<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Initial Game Screen -->
    <div id="start-screen" class="screen active">
        <img src="images/开始画面.jpg" alt="Start Screen" class="game-image">
        <div class="button-container">
            <button id="join-room-btn" class="game-btn">Join a Room</button>
            <button id="create-room-btn" class="game-btn">Create a Room</button>
        </div>
    </div>

    <!-- Room Number Input Modal -->
    <div id="room-input-modal" class="modal">
        <div class="modal-content">
            <p>Please enter a 6-digit room number</p>
            <input type="text" id="room-number-input" maxlength="6" pattern="\d{6}" placeholder="123456">
            <button id="submit-room-btn" class="modal-btn">Submit</button>
        </div>
    </div>

    <!-- Nickname Input Modal -->
    <div id="nickname-modal" class="modal">
        <div class="modal-content">
            <p>Please enter your English nickname</p>
            <input type="text" id="nickname-input" maxlength="12" placeholder="Nickname (max 12 chars)">
            <button id="submit-nickname-btn" class="modal-btn">Start Game</button>
        </div>
    </div>

    <!-- Error Message Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const roomNumberInput = document.getElementById('room-number-input');
        const submitRoomBtn = document.getElementById('submit-room-btn');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const submitNicknameBtn = document.getElementById('submit-nickname-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');

        // Game state variables
        let currentRoom = null;
        let isTeacher = false;
        let playerId = null;

        // Event Listeners
        joinRoomBtn.addEventListener('click', showRoomInputModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        submitRoomBtn.addEventListener('click', joinExistingRoom);
        submitNicknameBtn.addEventListener('click', startGameWithNickname);

        // Show room input modal
        function showRoomInputModal() {
            roomInputModal.style.display = 'flex';
        }

        // Create a new room (teacher)
        function createNewRoom() {
            isTeacher = true;
            // Generate random 6-digit room number
            const roomNumber = Math.floor(100000 + Math.random() * 900000).toString();
            currentRoom = roomNumber;
            
            // Create room in Firebase
            const roomRef = database.ref('rooms/' + roomNumber);
            roomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                players: {},
                status: 'waiting'
            }).then(() => {
                // Set automatic deletion after 24 hours
                setTimeout(() => {
                    roomRef.remove();
                }, 24 * 60 * 60 * 1000);
                
                // Redirect to ranking page
                window.location.href = `chapter.html?room=${roomNumber}&teacher=true`;
            }).catch(error => {
                showError("Failed to create room. Please try again.");
                console.error("Error creating room:", error);
            });
        }

        // Join existing room
        function joinExistingRoom() {
            const roomNumber = roomNumberInput.value.trim();
            
            // Validate room number
            if (!/^\d{6}$/.test(roomNumber)) {
                showError("Please enter a valid 6-digit room number.");
                return;
            }
            
            // Check if room exists in Firebase
            const roomRef = database.ref('rooms/' + roomNumber);
            roomRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    currentRoom = roomNumber;
                    roomInputModal.style.display = 'none';
                    nicknameModal.style.display = 'flex';
                } else {
                    showError("Room number does not exist");
                    setTimeout(() => {
                        errorModal.style.display = 'none';
                    }, 3000);
                }
            }).catch(error => {
                showError("Error checking room. Please try again.");
                console.error("Error checking room:", error);
            });
        }

        // Start game with entered nickname
        function startGameWithNickname() {
            const nickname = nicknameInput.value.trim();
            
            // Validate nickname
            if (!nickname || nickname.length > 12) {
                showError("Please enter a valid nickname (max 12 characters).");
                return;
            }
            
            // Generate player ID
            playerId = generatePlayerId();
            
            // Add player to room in Firebase
            const playerRef = database.ref(`rooms/${currentRoom}/players/${playerId}`);
            playerRef.set({
                nickname: nickname,
                score: 0,
                correctAnswers: 0,
                startTime: firebase.database.ServerValue.TIMESTAMP,
                currentProgress: 0,
                currentScreen: '2101'
            }).then(() => {
                // Redirect to game page
                window.location.href = `chapter.html?room=${currentRoom}&player=${playerId}&nickname=${encodeURIComponent(nickname)}`;
            }).catch(error => {
                showError("Failed to join room. Please try again.");
                console.error("Error joining room:", error);
            });
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
        }

        // Generate unique player ID
        function generatePlayerId() {
            return 'player-' + Math.random().toString(36).substr(2, 9);
        }

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === roomInputModal) {
                roomInputModal.style.display = 'none';
            }
            if (event.target === nicknameModal) {
                nicknameModal.style.display = 'none';
            }
            if (event.target === errorModal) {
                errorModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
