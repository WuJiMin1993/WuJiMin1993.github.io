<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Game Start Screen (Page ID: 2001) -->
    <div id="start-screen" class="screen active">
        <img src="images/开始画面.jpg" alt="Start Screen" class="full-width-image">
        <div class="button-container">
            <button id="join-room-btn" class="game-btn">Join a Room</button>
            <button id="create-room-btn" class="game-btn">Create a Room</button>
        </div>
    </div>

    <!-- Room Join Input -->
    <div id="room-input-modal" class="modal">
        <div class="modal-content">
            <p>Please enter a 6-digit room number</p>
            <input type="text" id="room-number-input" maxlength="6" pattern="\d{6}" placeholder="123456">
            <div class="modal-buttons">
                <button id="confirm-room-btn" class="game-btn">Confirm</button>
                <button id="cancel-room-btn" class="game-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Nickname Input -->
    <div id="nickname-input-modal" class="modal">
        <div class="modal-content">
            <p>Please enter your English nickname</p>
            <input type="text" id="nickname-input" maxlength="12" placeholder="Nickname (max 12 chars)">
            <div class="modal-buttons">
                <button id="confirm-nickname-btn" class="game-btn">Confirm</button>
                <button id="cancel-nickname-btn" class="game-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="error-message" class="message-box">
        <p id="error-text"></p>
    </div>

    <!-- Firebase configuration and game initialization -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state variables
        let currentRoom = null;
        let isTeacher = false;
        let playerId = null;
        let playerNickname = null;

        // DOM elements
        const startScreen = document.getElementById('start-screen');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const roomNumberInput = document.getElementById('room-number-input');
        const confirmRoomBtn = document.getElementById('confirm-room-btn');
        const cancelRoomBtn = document.getElementById('cancel-room-btn');
        const nicknameInputModal = document.getElementById('nickname-input-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const confirmNicknameBtn = document.getElementById('confirm-nickname-btn');
        const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // Event listeners
        joinRoomBtn.addEventListener('click', showRoomInputModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        confirmRoomBtn.addEventListener('click', joinExistingRoom);
        cancelRoomBtn.addEventListener('click', hideRoomInputModal);
        confirmNicknameBtn.addEventListener('click', confirmNickname);
        cancelNicknameBtn.addEventListener('click', hideNicknameInputModal);

        // Show room input modal
        function showRoomInputModal() {
            roomInputModal.style.display = 'flex';
            roomNumberInput.focus();
        }

        // Hide room input modal
        function hideRoomInputModal() {
            roomInputModal.style.display = 'none';
            roomNumberInput.value = '';
        }

        // Show nickname input modal
        function showNicknameInputModal() {
            nicknameInputModal.style.display = 'flex';
            nicknameInput.focus();
        }

        // Hide nickname input modal
        function hideNicknameInputModal() {
            nicknameInputModal.style.display = 'none';
            nicknameInput.value = '';
        }

        // Show error message
        function showError(message, duration = 3000) {
            errorText.textContent = message;
            errorMessage.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, duration);
            }
        }

        // Hide error message
        function hideError() {
            errorMessage.style.display = 'none';
        }

        // Create a new room (teacher)
        function createNewRoom() {
            isTeacher = true;
            
            // Generate a random 6-digit room number
            const roomNumber = Math.floor(100000 + Math.random() * 900000).toString();
            currentRoom = roomNumber;
            
            // Create room in Firebase
            const roomRef = database.ref('rooms/' + roomNumber);
            
            roomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                players: {},
                status: 'waiting'
            }).then(() => {
                // Set automatic deletion after 24 hours
                setTimeout(() => {
                    roomRef.remove();
                }, 24 * 60 * 60 * 1000);
                
                // Redirect to leaderboard
                window.location.href = `chapter.html?room=${roomNumber}&teacher=true`;
            }).catch((error) => {
                showError('Failed to create room. Please try again.');
                console.error('Error creating room:', error);
            });
        }

        // Join an existing room
        function joinExistingRoom() {
            const roomNumber = roomNumberInput.value.trim();
            
            if (!/^\d{6}$/.test(roomNumber)) {
                showError('Please enter a valid 6-digit room number');
                return;
            }
            
            // Check if room exists in Firebase
            const roomRef = database.ref('rooms/' + roomNumber);
            
            roomRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    currentRoom = roomNumber;
                    hideRoomInputModal();
                    showNicknameInputModal();
                } else {
                    showError('Room number does not exist');
                }
            }).catch((error) => {
                showError('Error checking room. Please try again.');
                console.error('Error checking room:', error);
            });
        }

        // Confirm nickname and start game
        function confirmNickname() {
            const nickname = nicknameInput.value.trim();
            
            if (nickname.length === 0) {
                showError('Please enter your nickname');
                return;
            }
            
            if (nickname.length > 12) {
                showError('Nickname must be 12 characters or less');
                return;
            }
            
            playerNickname = nickname;
            hideNicknameInputModal();
            
            // Generate unique player ID
            playerId = Date.now().toString();
            
            // Add player to room in Firebase
            const playerRef = database.ref(`rooms/${currentRoom}/players/${playerId}`);
            
            playerRef.set({
                nickname: playerNickname,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                score: 0,
                correctAnswers: 0,
                progress: 0,
                timeSpent: 0,
                status: 'playing'
            }).then(() => {
                // Redirect to game with room and player info
                window.location.href = `chapter.html?room=${currentRoom}&player=${playerId}`;
            }).catch((error) => {
                showError('Failed to join room. Please try again.');
                console.error('Error joining room:', error);
            });
        }
    </script>
</body>
</html>
