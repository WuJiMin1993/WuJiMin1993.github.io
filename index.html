<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- Initial Screen (Page ID: 2001) -->
        <div id="start-screen" class="screen" data-page-id="2001">
            <img src="images/开始画面.jpg" alt="Start Screen" class="full-width-image">
            <div class="button-container">
                <button id="join-room-btn" class="blue-btn">Join a Room</button>
                <button id="create-room-btn" class="blue-btn">Create a Room</button>
            </div>
        </div>

        <!-- Room Number Input Modal -->
        <div id="room-number-modal" class="modal">
            <div class="modal-content">
                <p>Please enter a 6-digit room number</p>
                <input type="text" id="room-number-input" maxlength="6" pattern="\d{6}" placeholder="123456">
                <button id="submit-room-btn" class="blue-btn">Submit</button>
            </div>
        </div>

        <!-- Nickname Input Modal -->
        <div id="nickname-modal" class="modal">
            <div class="modal-content">
                <p>Please enter your English nickname</p>
                <input type="text" id="nickname-input" maxlength="12" placeholder="Nickname">
                <button id="submit-nickname-btn" class="blue-btn">Submit</button>
            </div>
        </div>

        <!-- Error Message Modal -->
        <div id="error-modal" class="modal">
            <div class="modal-content">
                <p id="error-message"></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state variables
        let currentRoom = null;
        let playerId = null;
        let playerNickname = null;
        let isTeacher = false;

        // DOM elements
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomNumberModal = document.getElementById('room-number-modal');
        const roomNumberInput = document.getElementById('room-number-input');
        const submitRoomBtn = document.getElementById('submit-room-btn');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const submitNicknameBtn = document.getElementById('submit-nickname-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');

        // Event listeners
        joinRoomBtn.addEventListener('click', showRoomNumberModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        submitRoomBtn.addEventListener('click', joinExistingRoom);
        submitNicknameBtn.addEventListener('click', submitNickname);

        // Show room number input modal
        function showRoomNumberModal() {
            roomNumberModal.style.display = 'flex';
            roomNumberInput.focus();
        }

        // Create a new room
        function createNewRoom() {
            const roomNumber = generateRoomNumber();
            
            // Check if room already exists (unlikely with random 6-digit number)
            database.ref('rooms/' + roomNumber).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // Extremely rare case of collision, try again
                    createNewRoom();
                    return;
                }
                
                // Create new room
                const roomData = {
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    teacher: true,
                    players: {}
                };
                
                database.ref('rooms/' + roomNumber).set(roomData)
                    .then(() => {
                        currentRoom = roomNumber;
                        isTeacher = true;
                        // Teacher goes directly to ranking screen
                        window.location.href = 'chapter.html?room=' + roomNumber + '&teacher=true';
                    })
                    .catch((error) => {
                        showError('Failed to create room: ' + error.message);
                    });
            });
        }

        // Generate random 6-digit room number
        function generateRoomNumber() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Join existing room
        function joinExistingRoom() {
            const roomNumber = roomNumberInput.value.trim();
            
            if (!/^\d{6}$/.test(roomNumber)) {
                showError('Please enter a valid 6-digit room number');
                return;
            }
            
            // Check if room exists
            database.ref('rooms/' + roomNumber).once('value').then((snapshot) => {
                if (!snapshot.exists()) {
                    showError('Room number does not exist');
                    setTimeout(() => {
                        errorModal.style.display = 'none';
                    }, 3000);
                    return;
                }
                
                // Room exists, show nickname input
                roomNumberModal.style.display = 'none';
                nicknameModal.style.display = 'flex';
                nicknameInput.focus();
                currentRoom = roomNumber;
            }).catch((error) => {
                showError('Error checking room: ' + error.message);
            });
        }

        // Submit nickname and join game
        function submitNickname() {
            const nickname = nicknameInput.value.trim();
            
            if (!nickname || nickname.length > 12) {
                showError('Please enter a nickname (max 12 characters)');
                return;
            }
            
            if (!/^[a-zA-Z]+$/.test(nickname)) {
                showError('Nickname should contain only English letters');
                return;
            }
            
            playerNickname = nickname;
            nicknameModal.style.display = 'none';
            
            // Generate player ID and add to room
            playerId = generatePlayerId();
            
            const playerData = {
                nickname: playerNickname,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                score: 0,
                correctAnswers: 0,
                progress: 0,
                timeSpent: 0
            };
            
            database.ref('rooms/' + currentRoom + '/players/' + playerId).set(playerData)
                .then(() => {
                    // Start game
                    window.location.href = 'chapter.html?room=' + currentRoom + '&player=' + playerId;
                })
                .catch((error) => {
                    showError('Failed to join room: ' + error.message);
                });
        }

        // Generate unique player ID
        function generatePlayerId() {
            return 'player_' + Date.now();
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
            
            // Auto-hide after 3 seconds if not a critical error
            if (!message.includes('Failed') && !message.includes('Error')) {
                setTimeout(() => {
                    errorModal.style.display = 'none';
                }, 3000);
            }
        }

        // Preload chapter.html resources
        function preloadResources() {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.href = 'chapter.html';
            link.as = 'document';
            document.head.appendChild(link);
        }

        // Initialize preloading
        window.addEventListener('load', preloadResources);
    </script>
</body>
</html>
