<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- Start Screen (Page ID: 2001) -->
        <div id="page-2001" class="game-page active">
            <img src="images/开始画面.jpg" alt="Start Screen" class="full-width-image">
            <div class="button-container">
                <button id="join-room-btn" class="game-btn">Join Room</button>
                <button id="create-room-btn" class="game-btn">Create Room</button>
            </div>
        </div>

        <!-- Room Number Input Modal -->
        <div id="room-input-modal" class="modal">
            <div class="modal-content">
                <p>Please enter a 6-digit room number</p>
                <input type="text" id="room-number-input" maxlength="6" pattern="\d{6}" placeholder="123456">
                <div class="modal-button-container">
                    <button id="confirm-room-btn" class="modal-btn">Confirm</button>
                    <button id="cancel-room-btn" class="modal-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Nickname Input Modal -->
        <div id="nickname-input-modal" class="modal">
            <div class="modal-content">
                <p>Please enter your English nickname</p>
                <input type="text" id="nickname-input" maxlength="12" placeholder="Nickname">
                <div class="modal-button-container">
                    <button id="confirm-nickname-btn" class="modal-btn">Confirm</button>
                    <button id="cancel-nickname-btn" class="modal-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Alert Modal -->
        <div id="alert-modal" class="modal">
            <div class="modal-content">
                <p id="alert-message"></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Game state variables
        let currentRoomId = null;
        let playerId = null;
        let playerNickname = null;
        let isTeacher = false;
        let gameStartTime = null;
        let timerInterval = null;

        // DOM elements
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const roomNumberInput = document.getElementById('room-number-input');
        const confirmRoomBtn = document.getElementById('confirm-room-btn');
        const cancelRoomBtn = document.getElementById('cancel-room-btn');
        const nicknameInputModal = document.getElementById('nickname-input-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const confirmNicknameBtn = document.getElementById('confirm-nickname-btn');
        const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
        const alertModal = document.getElementById('alert-modal');
        const alertMessage = document.getElementById('alert-message');

        // Event listeners
        joinRoomBtn.addEventListener('click', showRoomInputModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        confirmRoomBtn.addEventListener('click', joinExistingRoom);
        cancelRoomBtn.addEventListener('click', hideRoomInputModal);
        confirmNicknameBtn.addEventListener('click', confirmNickname);
        cancelNicknameBtn.addEventListener('click', hideNicknameInputModal);

        // Show room input modal
        function showRoomInputModal() {
            roomInputModal.style.display = 'flex';
            roomNumberInput.focus();
        }

        // Hide room input modal
        function hideRoomInputModal() {
            roomInputModal.style.display = 'none';
            roomNumberInput.value = '';
        }

        // Show nickname input modal
        function showNicknameInputModal() {
            nicknameInputModal.style.display = 'flex';
            nicknameInput.focus();
        }

        // Hide nickname input modal
        function hideNicknameInputModal() {
            nicknameInputModal.style.display = 'none';
            nicknameInput.value = '';
        }

        // Show alert modal
        function showAlert(message, duration = 3000) {
            alertMessage.textContent = message;
            alertModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    alertModal.style.display = 'none';
                }, duration);
            }
        }

        // Hide alert modal
        function hideAlert() {
            alertModal.style.display = 'none';
        }

        // Create a new room
        function createNewRoom() {
            // Generate a random 6-digit room number
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            currentRoomId = roomId;
            isTeacher = true;
            
            // Create room in Firebase
            const roomRef = database.ref('rooms/' + roomId);
            roomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                players: {}
            }).then(() => {
                // Room created successfully, redirect to leaderboard
                window.location.href = `chapter.html?room=${roomId}&teacher=true`;
            }).catch((error) => {
                showAlert('Error creating room: ' + error.message);
            });
        }

        // Join an existing room
        function joinExistingRoom() {
            const roomId = roomNumberInput.value.trim();
            
            if (!roomId || roomId.length !== 6 || !/^\d+$/.test(roomId)) {
                showAlert('Please enter a valid 6-digit room number');
                return;
            }
            
            // Check if room exists in Firebase
            const roomRef = database.ref('rooms/' + roomId);
            roomRef.once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    currentRoomId = roomId;
                    hideRoomInputModal();
                    showNicknameInputModal();
                } else {
                    showAlert('Room number does not exist');
                }
            }).catch((error) => {
                showAlert('Error checking room: ' + error.message);
            });
        }

        // Confirm nickname and join game
        function confirmNickname() {
            const nickname = nicknameInput.value.trim();
            
            if (!nickname || nickname.length > 12 || !/^[a-zA-Z]+$/.test(nickname)) {
                showAlert('Please enter a valid English nickname (letters only, max 12 characters)');
                return;
            }
            
            playerNickname = nickname;
            hideNicknameInputModal();
            
            // Generate player ID
            playerId = generatePlayerId();
            
            // Start the game
            window.location.href = `chapter.html?room=${currentRoomId}&player=${playerId}&nickname=${encodeURIComponent(playerNickname)}`;
        }

        // Generate a unique player ID
        function generatePlayerId() {
            return 'player-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }
    </script>
</body>
</html>
