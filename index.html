<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态学习游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- 游戏开始界面 -->
    <div id="start-screen" class="screen active">
        <img src="images/开始画面.jpg" alt="游戏开始画面" class="full-width-img">
        <div class="button-container">
            <button id="join-room-btn" class="game-btn">加入房间</button>
            <button id="create-room-btn" class="game-btn">创建房间</button>
        </div>
    </div>

    <!-- 房间号输入框 -->
    <div id="room-input-modal" class="modal">
        <div class="modal-content">
            <h3>请输入6位数房间号</h3>
            <input type="text" id="room-id-input" maxlength="6" placeholder="输入6位数字">
            <div class="modal-buttons">
                <button id="confirm-room-btn" class="modal-btn">确认</button>
                <button id="cancel-room-btn" class="modal-btn">取消</button>
            </div>
        </div>
    </div>

    <!-- 提示信息框 -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // DOM元素
        const startScreen = document.getElementById('start-screen');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const roomIdInput = document.getElementById('room-id-input');
        const confirmRoomBtn = document.getElementById('confirm-room-btn');
        const cancelRoomBtn = document.getElementById('cancel-room-btn');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        
        // 游戏状态
        let currentRoomId = null;
        
        // 事件监听器
        joinRoomBtn.addEventListener('click', showRoomInputModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        confirmRoomBtn.addEventListener('click', joinRoom);
        cancelRoomBtn.addEventListener('click', hideRoomInputModal);
        
        // 显示房间号输入框
        function showRoomInputModal() {
            roomInputModal.style.display = 'flex';
            roomIdInput.focus();
        }
        
        // 隐藏房间号输入框
        function hideRoomInputModal() {
            roomInputModal.style.display = 'none';
            roomIdInput.value = '';
        }
        
        // 显示提示信息
        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, duration);
            }
        }
        
        // 创建新房间
        function createNewRoom() {
            // 生成6位随机房间号
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            currentRoomId = roomId;
            
            // 在Firebase中创建房间
            database.ref('rooms/' + roomId).set({
                created: firebase.database.ServerValue.TIMESTAMP,
                status: 'waiting'
            }).then(() => {
                // 跳转到游戏页面，传递房间号
                window.location.href = `chapter.html?room=${roomId}&creator=true`;
            }).catch(error => {
                showMessage('创建房间失败: ' + error.message);
            });
        }
        
        // 加入已有房间
        function joinRoom() {
            const roomId = roomIdInput.value.trim();
            
            if (!roomId || roomId.length !== 6 || !/^\d+$/.test(roomId)) {
                showMessage('请输入有效的6位数字房间号');
                return;
            }
            
            // 检查房间是否存在
            database.ref('rooms/' + roomId).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    currentRoomId = roomId;
                    hideRoomInputModal();
                    // 跳转到游戏页面，传递房间号
                    window.location.href = `chapter.html?room=${roomId}`;
                } else {
                    showMessage('房间号不存在');
                }
            }).catch(error => {
                showMessage('检查房间失败: ' + error.message);
            });
        }
    </script>
</body>
</html>
