<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Adventure</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Initial Game Screen -->
    <div id="start-screen" class="screen active">
        <img src="images/开始画面.jpg" alt="Start Screen" class="full-width-image">
        <div class="button-container">
            <button id="join-room-btn" class="game-btn">Join a Room</button>
            <button id="create-room-btn" class="game-btn">Create a Room</button>
        </div>
    </div>

    <!-- Room Number Input Modal -->
    <div id="room-input-modal" class="modal">
        <div class="modal-content">
            <p>Please enter a 6-digit room number</p>
            <input type="text" id="room-number-input" maxlength="6" pattern="\d{6}" placeholder="123456">
            <div class="modal-buttons">
                <button id="confirm-room-btn">Confirm</button>
                <button id="cancel-room-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Nickname Input Modal -->
    <div id="nickname-modal" class="modal">
        <div class="modal-content">
            <p>Please enter your English nickname</p>
            <input type="text" id="nickname-input" maxlength="12" placeholder="Nickname (max 12 chars)">
            <div class="modal-buttons">
                <button id="confirm-nickname-btn">Confirm</button>
                <button id="cancel-nickname-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Error Message Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <p id="error-message"></p>
            <button id="close-error-btn">OK</button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const startScreen = document.getElementById('start-screen');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const roomNumberInput = document.getElementById('room-number-input');
        const confirmRoomBtn = document.getElementById('confirm-room-btn');
        const cancelRoomBtn = document.getElementById('cancel-room-btn');
        const nicknameModal = document.getElementById('nickname-modal');
        const nicknameInput = document.getElementById('nickname-input');
        const confirmNicknameBtn = document.getElementById('confirm-nickname-btn');
        const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        const closeErrorBtn = document.getElementById('close-error-btn');

        // Game state variables
        let currentRoom = null;
        let isTeacher = false;
        let playerId = null;

        // Event Listeners
        joinRoomBtn.addEventListener('click', showRoomInputModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        confirmRoomBtn.addEventListener('click', joinExistingRoom);
        cancelRoomBtn.addEventListener('click', hideRoomInputModal);
        confirmNicknameBtn.addEventListener('click', confirmNickname);
        cancelNicknameBtn.addEventListener('click', hideNicknameModal);
        closeErrorBtn.addEventListener('click', hideErrorModal);

        // Show room input modal
        function showRoomInputModal() {
            roomInputModal.style.display = 'flex';
            roomNumberInput.focus();
        }

        // Hide room input modal
        function hideRoomInputModal() {
            roomInputModal.style.display = 'none';
            roomNumberInput.value = '';
        }

        // Show nickname input modal
        function showNicknameModal() {
            nicknameModal.style.display = 'flex';
            nicknameInput.focus();
        }

        // Hide nickname input modal
        function hideNicknameModal() {
            nicknameModal.style.display = 'none';
            nicknameInput.value = '';
        }

        // Show error modal with message
        function showErrorModal(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
        }

        // Hide error modal
        function hideErrorModal() {
            errorModal.style.display = 'none';
        }

        // Create a new room
        function createNewRoom() {
            // Generate a random 6-digit room number
            const roomNumber = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Check if room exists
            database.ref('rooms/' + roomNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        // If room exists (unlikely but possible), try again
                        createNewRoom();
                    } else {
                        // Create new room
                        currentRoom = roomNumber;
                        isTeacher = true;
                        
                        // Initialize room data
                        const roomData = {
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            teacher: true,
                            players: {}
                        };
                        
                        // Save to Firebase
                        return database.ref('rooms/' + roomNumber).set(roomData);
                    }
                })
                .then(() => {
                    // Redirect to ranking page
                    window.location.href = 'chapter.html?room=' + currentRoom + '&teacher=true';
                })
                .catch(error => {
                    console.error('Error creating room:', error);
                    showErrorModal('Failed to create room. Please try again.');
                });
        }

        // Join an existing room
        function joinExistingRoom() {
            const roomNumber = roomNumberInput.value.trim();
            
            // Validate room number
            if (!/^\d{6}$/.test(roomNumber)) {
                showErrorModal('Please enter a valid 6-digit room number');
                return;
            }
            
            // Check if room exists
            database.ref('rooms/' + roomNumber).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        showErrorModal('Room number does not exist');
                        setTimeout(() => {
                            hideErrorModal();
                        }, 3000);
                        return;
                    }
                    
                    // Room exists, proceed to nickname input
                    currentRoom = roomNumber;
                    hideRoomInputModal();
                    showNicknameModal();
                })
                .catch(error => {
                    console.error('Error checking room:', error);
                    showErrorModal('Error checking room. Please try again.');
                });
        }

        // Confirm nickname and join room
        function confirmNickname() {
            const nickname = nicknameInput.value.trim();
            
            // Validate nickname
            if (!nickname) {
                showErrorModal('Please enter a nickname');
                return;
            }
            
            if (nickname.length > 12) {
                showErrorModal('Nickname must be 12 characters or less');
                return;
            }
            
            // Generate player ID
            playerId = generateId();
            
            // Add player to room
            const playerData = {
                nickname: nickname,
                joinedAt: firebase.database.ServerValue.TIMESTAMP,
                score: 0,
                correctAnswers: 0,
                progress: 0,
                timeSpent: 0,
                completed: false
            };
            
            database.ref('rooms/' + currentRoom + '/players/' + playerId).set(playerData)
                .then(() => {
                    // Redirect to game page
                    window.location.href = 'chapter.html?room=' + currentRoom + '&player=' + playerId;
                })
                .catch(error => {
                    console.error('Error joining room:', error);
                    showErrorModal('Failed to join room. Please try again.');
                });
        }

        // Generate a random ID
        function generateId() {
            return 'player-' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html>
