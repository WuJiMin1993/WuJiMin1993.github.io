<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法棒</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- 开始画面 -->
        <div id="page-2001" class="game-page active">
            <img src="images/开始画面.jpg" alt="开始画面" class="game-image">
            <div class="button-container">
                <button id="join-room-btn" class="game-button">加入房间</button>
                <button id="create-room-btn" class="game-button">创建房间</button>
            </div>
        </div>
    </div>

    <!-- 提示框容器 -->
    <div id="alert-container" class="alert-hidden"></div>

    <!-- 输入框容器 -->
    <div id="input-container" class="input-hidden">
        <input type="text" id="room-id-input" placeholder="请输入6位数房间号" maxlength="6">
        <button id="confirm-room-btn">确认</button>
    </div>

    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 游戏状态变量
        let currentRoomId = null;
        let isTeacher = false;
        let playerName = '';
        
        // DOM元素
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const inputContainer = document.getElementById('input-container');
        const roomIdInput = document.getElementById('room-id-input');
        const confirmRoomBtn = document.getElementById('confirm-room-btn');
        const alertContainer = document.getElementById('alert-container');
        
        // 加入房间按钮点击事件
        joinRoomBtn.addEventListener('click', () => {
            showInput('请输入6位数房间号');
        });
        
        // 创建房间按钮点击事件
        createRoomBtn.addEventListener('click', () => {
            createNewRoom();
        });
        
        // 确认房间号按钮点击事件
        confirmRoomBtn.addEventListener('click', () => {
            const roomId = roomIdInput.value.trim();
            if (roomId.length === 6 && /^\d+$/.test(roomId)) {
                checkRoomExists(roomId);
            } else {
                showAlert('请输入有效的6位数房间号');
            }
        });
        
        // 显示输入框
        function showInput(placeholder) {
            roomIdInput.placeholder = placeholder;
            inputContainer.classList.remove('input-hidden');
            inputContainer.classList.add('input-visible');
            roomIdInput.focus();
        }
        
        // 隐藏输入框
        function hideInput() {
            inputContainer.classList.remove('input-visible');
            inputContainer.classList.add('input-hidden');
            roomIdInput.value = '';
        }
        
        // 显示提示框
        function showAlert(message, duration = 3000) {
            alertContainer.textContent = message;
            alertContainer.classList.remove('alert-hidden');
            alertContainer.classList.add('alert-visible');
            
            if (duration > 0) {
                setTimeout(() => {
                    alertContainer.classList.remove('alert-visible');
                    alertContainer.classList.add('alert-hidden');
                }, duration);
            }
        }
        
        // 隐藏提示框
        function hideAlert() {
            alertContainer.classList.remove('alert-visible');
            alertContainer.classList.add('alert-hidden');
        }
        
        // 检查房间是否存在
        function checkRoomExists(roomId) {
            database.ref('rooms/' + roomId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // 房间存在，提示输入昵称
                        hideInput();
                        showInput('请输入您的英文昵称');
                        confirmRoomBtn.onclick = () => {
                            const name = roomIdInput.value.trim();
                            if (name.length > 0 && name.length <= 12 && /^[a-zA-Z]+$/.test(name)) {
                                playerName = name;
                                currentRoomId = roomId;
                                joinRoom(roomId, name);
                            } else {
                                showAlert('请输入1-12个字母的英文昵称');
                            }
                        };
                    } else {
                        // 房间不存在
                        showAlert('房间号不存在');
                    }
                })
                .catch((error) => {
                    console.error('检查房间时出错:', error);
                    showAlert('连接服务器失败，请重试');
                });
        }
        
        // 加入房间
        function joinRoom(roomId, name) {
            hideInput();
            
            // 检查玩家是否已存在
            database.ref('rooms/' + roomId + '/players/' + name).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        showAlert('该昵称已被使用，请换一个');
                        showInput('请输入您的英文昵称');
                    } else {
                        // 记录玩家加入时间
                        const joinTime = Date.now();
                        
                        // 添加玩家到房间
                        database.ref('rooms/' + roomId + '/players/' + name).set({
                            name: name,
                            joinTime: joinTime,
                            score: 0,
                            correctAnswers: 0,
                            progress: 0,
                            status: 'playing'
                        })
                        .then(() => {
                            // 跳转到游戏章节页面
                            window.location.href = 'chapter.html?room=' + roomId + '&player=' + encodeURIComponent(name);
                        })
                        .catch((error) => {
                            console.error('加入房间时出错:', error);
                            showAlert('加入房间失败，请重试');
                        });
                    }
                })
                .catch((error) => {
                    console.error('检查玩家时出错:', error);
                    showAlert('连接服务器失败，请重试');
                });
        }
        
        // 创建新房间
        function createNewRoom() {
            isTeacher = true;
            
            // 生成6位随机房间号
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            currentRoomId = roomId;
            
            // 创建房间并设置24小时后自动删除
            const roomData = {
                createdAt: Date.now(),
                expiresAt: Date.now() + 24 * 60 * 60 * 1000, // 24小时后
                teacher: 'teacher',
                playerCount: 0
            };
            
            database.ref('rooms/' + roomId).set(roomData)
                .then(() => {
                    // 设置24小时后删除房间
                    setTimeout(() => {
                        database.ref('rooms/' + roomId).remove();
                    }, 24 * 60 * 60 * 1000);
                    
                    // 跳转到排名页面
                    window.location.href = 'chapter.html?room=' + roomId + '&teacher=true';
                })
                .catch((error) => {
                    console.error('创建房间时出错:', error);
                    showAlert('创建房间失败，请重试');
                });
        }
    </script>
</body>
</html>
