<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法冒险</title>
    <link href="https://fonts.googleapis.com/css2?family=Microsoft+YaHei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- 初始界面 -->
    <div id="page-2001" class="game-page active">
        <img src="images/开始画面.jpg" alt="开始画面" class="game-image">
        <div class="button-container">
            <button id="join-room" class="game-button left-button">加入房间</button>
            <button id="create-room" class="game-button right-button">创建房间</button>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 游戏状态
        let gameState = {
            roomId: null,
            isTeacher: false,
            playerId: null,
            playerName: null,
            startTime: null,
            score: 0,
            correctAnswers: 0,
            currentPage: null
        };
        
        // DOM元素
        const joinRoomBtn = document.getElementById('join-room');
        const createRoomBtn = document.getElementById('create-room');
        
        // 加入房间
        joinRoomBtn.addEventListener('click', () => {
            const roomId = prompt('请输入6位数房间号');
            if (roomId && roomId.length === 6) {
                checkRoomExists(roomId);
            } else {
                showAlert('请输入有效的6位数房间号');
            }
        });
        
        // 创建房间
        createRoomBtn.addEventListener('click', () => {
            createNewRoom();
        });
        
        // 检查房间是否存在
        function checkRoomExists(roomId) {
            database.ref('rooms/' + roomId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        // 检查房间人数
                        const players = snapshot.val().players || {};
                        const playerCount = Object.keys(players).length;
                        
                        if (playerCount < 10) {
                            joinRoom(roomId);
                        } else {
                            showAlert('房间已满(最多10人)');
                        }
                    } else {
                        showAlert('房间号不存在');
                    }
                })
                .catch((error) => {
                    console.error('检查房间错误:', error);
                    showAlert('连接服务器失败，请重试');
                });
        }
        
        // 加入房间
        function joinRoom(roomId) {
            gameState.roomId = roomId;
            gameState.isTeacher = false;
            gameState.startTime = new Date().getTime();
            
            // 生成玩家ID和名称
            database.ref('rooms/' + roomId + '/players').once('value')
                .then((snapshot) => {
                    const players = snapshot.val() || {};
                    const playerCount = Object.keys(players).length;
                    gameState.playerId = 'player' + (playerCount + 1);
                    gameState.playerName = '玩家' + (playerCount + 1);
                    
                    // 保存玩家初始数据
                    const playerData = {
                        name: gameState.playerName,
                        score: 0,
                        correctRate: 0,
                        progress: 0,
                        startTime: gameState.startTime,
                        currentPage: '2101'
                    };
                    
                    database.ref('rooms/' + roomId + '/players/' + gameState.playerId).set(playerData)
                        .then(() => {
                            // 跳转到章节页面
                            window.location.href = 'chapter.html?roomId=' + roomId + '&playerId=' + gameState.playerId;
                        });
                });
        }
        
        // 创建新房间
        function createNewRoom() {
            // 生成6位随机房间号
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            gameState.roomId = roomId;
            gameState.isTeacher = true;
            
            // 创建房间数据
            const roomData = {
                createdAt: new Date().getTime(),
                players: {}
            };
            
            database.ref('rooms/' + roomId).set(roomData)
                .then(() => {
                    // 直接跳转到排名页面
                    window.location.href = 'chapter.html?roomId=' + roomId + '&isTeacher=true';
                })
                .catch((error) => {
                    console.error('创建房间错误:', error);
                    showAlert('创建房间失败，请重试');
                });
        }
        
        // 显示提示框
        function showAlert(message, duration = 3000) {
            const alertBox = document.createElement('div');
            alertBox.className = 'alert-box';
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            
            setTimeout(() => {
                alertBox.remove();
            }, duration);
        }
    </script>
</body>
</html>
