<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔法学校时态冒险</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- Start Screen (Page ID: 2001) -->
        <div id="page-2001" class="game-page active">
            <img src="images/开始画面.jpg" alt="开始画面" class="background-image">
            <div class="button-container">
                <button id="join-room-btn" class="game-button">加入房间</button>
                <button id="create-room-btn" class="game-button">创建房间</button>
            </div>
        </div>

        <!-- Room Input Modal -->
        <div id="room-input-modal" class="modal">
            <div class="modal-content">
                <p>请输入6位数房间号</p>
                <input type="text" id="room-code-input" maxlength="6" pattern="\d{6}">
                <button id="confirm-join-btn" class="game-button">确认</button>
            </div>
        </div>

        <!-- Error Message Modal -->
        <div id="error-modal" class="modal">
            <div class="modal-content">
                <p id="error-message"></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state variables
        let currentRoomCode = '';
        let isTeacher = false;
        let playerName = '';
        let playerCount = 0;

        // DOM elements
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const roomCodeInput = document.getElementById('room-code-input');
        const confirmJoinBtn = document.getElementById('confirm-join-btn');
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');

        // Event listeners
        joinRoomBtn.addEventListener('click', showRoomInputModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        confirmJoinBtn.addEventListener('click', joinExistingRoom);

        // Show room input modal
        function showRoomInputModal() {
            roomInputModal.style.display = 'block';
        }

        // Create new room
        function createNewRoom() {
            isTeacher = true;
            currentRoomCode = generateRoomCode();
            
            // Create room in Firebase
            database.ref('rooms/' + currentRoomCode).set({
                teacher: true,
                players: {},
                createdAt: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                // Redirect to chapter.html with room code
                window.location.href = `chapter.html?room=${currentRoomCode}&teacher=true`;
            }).catch(error => {
                showError('创建房间失败: ' + error.message);
            });
        }

        // Join existing room
        function joinExistingRoom() {
            const roomCode = roomCodeInput.value.trim();
            
            if (roomCode.length !== 6 || !/^\d+$/.test(roomCode)) {
                showError('请输入有效的6位数房间号');
                return;
            }
            
            currentRoomCode = roomCode;
            
            // Check if room exists
            database.ref('rooms/' + roomCode).once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const roomData = snapshot.val();
                    playerCount = roomData.players ? Object.keys(roomData.players).length : 0;
                    
                    if (playerCount >= 10) {
                        showError('房间已满(最多10人)');
                        return;
                    }
                    
                    // Assign player name (Player 1 to Player 10)
                    playerName = `玩家${playerCount + 1}`;
                    
                    // Add player to room
                    const playerRef = database.ref(`rooms/${roomCode}/players/${playerName}`);
                    playerRef.set({
                        name: playerName,
                        score: 0,
                        correctRate: 0,
                        progress: 0,
                        startTime: firebase.database.ServerValue.TIMESTAMP,
                        currentChapter: 0
                    }).then(() => {
                        // Redirect to chapter.html with room code
                        window.location.href = `chapter.html?room=${roomCode}&player=${playerName}`;
                    }).catch(error => {
                        showError('加入房间失败: ' + error.message);
                    });
                } else {
                    showError('房间号不存在');
                }
            }).catch(error => {
                showError('检查房间失败: ' + error.message);
            });
        }

        // Generate random 6-digit room code
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'block';
            
            // Hide error after 3 seconds
            setTimeout(() => {
                errorModal.style.display = 'none';
            }, 3000);
        }

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === roomInputModal) {
                roomInputModal.style.display = 'none';
            }
            if (event.target === errorModal) {
                errorModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
