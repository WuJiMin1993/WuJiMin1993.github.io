<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Microsoft+YaHei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-analytics.js"></script>
</head>
<body>
    <!-- Game Initial Screen -->
    <div id="start-screen" class="screen active">
        <img src="images/开始画面.jpg" alt="Start Screen" class="full-width-image">
        <div class="button-container">
            <button id="join-room-btn" class="blue-btn">Join a Room</button>
            <button id="create-room-btn" class="blue-btn">Create a Room</button>
        </div>
    </div>

    <!-- Room Number Input -->
    <div id="room-input-screen" class="screen">
        <div class="input-container">
            <p>Please enter a 6-digit room number</p>
            <input type="text" id="room-number-input" maxlength="6" pattern="\d{6}" placeholder="123456">
            <button id="submit-room-btn" class="blue-btn">Submit</button>
        </div>
    </div>

    <!-- Nickname Input -->
    <div id="nickname-input-screen" class="screen">
        <div class="input-container">
            <p>Please enter your English nickname</p>
            <input type="text" id="nickname-input" maxlength="12" placeholder="Nickname">
            <button id="submit-nickname-btn" class="blue-btn">Start Game</button>
        </div>
    </div>

    <!-- Room Not Found Message -->
    <div id="room-not-found-screen" class="screen">
        <div class="message-box">
            <p>Room number does not exist</p>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>

    <!-- Game Logic -->
    <script>
        // Global variables
        let currentRoom = '';
        let playerName = '';
        let playerId = '';
        let isTeacher = false;
        let gameStartTime = 0;
        
        // DOM elements
        const startScreen = document.getElementById('start-screen');
        const roomInputScreen = document.getElementById('room-input-screen');
        const nicknameInputScreen = document.getElementById('nickname-input-screen');
        const roomNotFoundScreen = document.getElementById('room-not-found-screen');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomNumberInput = document.getElementById('room-number-input');
        const submitRoomBtn = document.getElementById('submit-room-btn');
        const nicknameInput = document.getElementById('nickname-input');
        const submitNicknameBtn = document.getElementById('submit-nickname-btn');

        // Event listeners
        joinRoomBtn.addEventListener('click', showRoomInput);
        createRoomBtn.addEventListener('click', createNewRoom);
        submitRoomBtn.addEventListener('click', checkRoomExists);
        submitNicknameBtn.addEventListener('click', startGame);

        // Show room input screen
        function showRoomInput() {
            startScreen.classList.remove('active');
            roomInputScreen.classList.add('active');
        }

        // Create a new room (teacher)
        function createNewRoom() {
            isTeacher = true;
            currentRoom = generateRoomNumber();
            playerName = "Teacher";
            playerId = generatePlayerId();
            
            // Create room in Firebase
            const roomRef = database.ref('rooms/' + currentRoom);
            roomRef.set({
                createdAt: firebase.database.ServerValue.TIMESTAMP,
                teacherId: playerId,
                players: {}
            });
            
            // Set room expiration (24 hours)
            setTimeout(() => {
                roomRef.remove();
            }, 24 * 60 * 60 * 1000);
            
            // Redirect to leaderboard
            redirectToLeaderboard();
        }

        // Check if room exists
        function checkRoomExists() {
            const roomNumber = roomNumberInput.value.trim();
            
            if (!/^\d{6}$/.test(roomNumber)) {
                alert("Please enter a valid 6-digit room number");
                return;
            }
            
            currentRoom = roomNumber;
            
            // Check room in Firebase
            database.ref('rooms/' + roomNumber).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        roomInputScreen.classList.remove('active');
                        nicknameInputScreen.classList.add('active');
                    } else {
                        showRoomNotFound();
                    }
                })
                .catch((error) => {
                    console.error("Error checking room:", error);
                    showRoomNotFound();
                });
        }

        // Show room not found message
        function showRoomNotFound() {
            roomInputScreen.classList.remove('active');
            roomNotFoundScreen.classList.add('active');
            
            // Return to room input after 3 seconds
            setTimeout(() => {
                roomNotFoundScreen.classList.remove('active');
                roomInputScreen.classList.add('active');
                roomNumberInput.value = '';
            }, 3000);
        }

        // Start game (for players)
        function startGame() {
            playerName = nicknameInput.value.trim();
            
            if (!playerName || playerName.length > 12) {
                alert("Please enter a valid nickname (max 12 characters)");
                return;
            }
            
            playerId = generatePlayerId();
            gameStartTime = Date.now();
            
            // Add player to room
            const playerRef = database.ref('rooms/' + currentRoom + '/players/' + playerId);
            playerRef.set({
                name: playerName,
                score: 0,
                accuracy: 0,
                progress: 0,
                timeSpent: 0,
                startTime: firebase.database.ServerValue.TIMESTAMP
            });
            
            // Redirect to chapter.html
            window.location.href = `chapter.html?room=${currentRoom}&player=${playerId}`;
        }

        // Redirect to leaderboard
        function redirectToLeaderboard() {
            window.location.href = `chapter.html?room=${currentRoom}&player=${playerId}&leaderboard=true`;
        }

        // Helper functions
        function generateRoomNumber() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }
        
        function generatePlayerId() {
            return 'player-' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html>
