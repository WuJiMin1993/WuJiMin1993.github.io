<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tenses Journey</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Initial Game Screen (ID:2001) -->
    <div id="screen-2001" class="game-screen">
        <img src="images/开始画面.jpg" alt="Welcome Screen" class="game-image">
        <div class="text-box">
            <p>Welcome to the journey of English tenses</p>
        </div>
        <div class="button-container">
            <button id="join-room-btn" class="game-button">Join a Room</button>
            <button id="create-room-btn" class="game-button">Create a Room</button>
        </div>
    </div>

    <!-- Room Number Input Modal -->
    <div id="room-input-modal" class="modal">
        <div class="modal-content">
            <p>Please enter a 6-digit room number</p>
            <input type="text" id="room-number-input" maxlength="6" pattern="\d{6}" placeholder="123456">
            <div class="modal-buttons">
                <button id="confirm-room-btn">Confirm</button>
                <button id="cancel-room-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Nickname Input Modal -->
    <div id="nickname-input-modal" class="modal">
        <div class="modal-content">
            <p>Please enter your English nickname</p>
            <input type="text" id="nickname-input" maxlength="12" placeholder="Your nickname">
            <div class="modal-buttons">
                <button id="confirm-nickname-btn">Confirm</button>
                <button id="cancel-nickname-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Error Message Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content">
            <p id="error-message"></p>
            <div class="modal-buttons">
                <button id="close-error-btn">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM elements
        const joinRoomBtn = document.getElementById('join-room-btn');
        const createRoomBtn = document.getElementById('create-room-btn');
        const roomInputModal = document.getElementById('room-input-modal');
        const nicknameInputModal = document.getElementById('nickname-input-modal');
        const errorModal = document.getElementById('error-modal');
        const roomNumberInput = document.getElementById('room-number-input');
        const nicknameInput = document.getElementById('nickname-input');
        const confirmRoomBtn = document.getElementById('confirm-room-btn');
        const cancelRoomBtn = document.getElementById('cancel-room-btn');
        const confirmNicknameBtn = document.getElementById('confirm-nickname-btn');
        const cancelNicknameBtn = document.getElementById('cancel-nickname-btn');
        const closeErrorBtn = document.getElementById('close-error-btn');
        const errorMessage = document.getElementById('error-message');

        // Game state variables
        let currentRoomId = '';
        let isTeacher = false;
        let playerId = '';
        let playerNickname = '';

        // Event listeners
        joinRoomBtn.addEventListener('click', showRoomInputModal);
        createRoomBtn.addEventListener('click', createNewRoom);
        confirmRoomBtn.addEventListener('click', joinRoom);
        cancelRoomBtn.addEventListener('click', hideRoomInputModal);
        confirmNicknameBtn.addEventListener('click', confirmNickname);
        cancelNicknameBtn.addEventListener('click', hideNicknameInputModal);
        closeErrorBtn.addEventListener('click', hideErrorModal);

        // Show room input modal
        function showRoomInputModal() {
            roomInputModal.style.display = 'flex';
            roomNumberInput.value = '';
        }

        // Hide room input modal
        function hideRoomInputModal() {
            roomInputModal.style.display = 'none';
        }

        // Show nickname input modal
        function showNicknameInputModal() {
            nicknameInputModal.style.display = 'flex';
            nicknameInput.value = '';
        }

        // Hide nickname input modal
        function hideNicknameInputModal() {
            nicknameInputModal.style.display = 'none';
        }

        // Show error modal with message
        function showErrorModal(message) {
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
        }

        // Hide error modal
        function hideErrorModal() {
            errorModal.style.display = 'none';
        }

        // Create a new room
        function createNewRoom() {
            // Generate random 6-digit room number
            const roomNumber = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Check if room exists
            database.ref('rooms/' + roomNumber).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    // If room exists (unlikely with random number), try again
                    createNewRoom();
                } else {
                    // Create new room
                    currentRoomId = roomNumber;
                    isTeacher = true;
                    
                    // Set room data with 24-hour expiration
                    const roomData = {
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        teacher: true,
                        players: {}
                    };
                    
                    database.ref('rooms/' + roomNumber).set(roomData)
                        .then(() => {
                            // Redirect to leaderboard
                            window.location.href = `chapter.html?room=${roomNumber}&teacher=true`;
                        })
                        .catch((error) => {
                            showErrorModal('Failed to create room: ' + error.message);
                        });
                }
            }).catch((error) => {
                showErrorModal('Error checking room: ' + error.message);
            });
        }

        // Join existing room
        function joinRoom() {
            const roomNumber = roomNumberInput.value.trim();
            
            // Validate room number
            if (!/^\d{6}$/.test(roomNumber)) {
                showErrorModal('Please enter a valid 6-digit room number');
                return;
            }
            
            // Check if room exists
            database.ref('rooms/' + roomNumber).once('value').then((snapshot) => {
                if (snapshot.exists()) {
                    currentRoomId = roomNumber;
                    hideRoomInputModal();
                    showNicknameInputModal();
                } else {
                    showErrorModal('Room number does not exist');
                    setTimeout(hideErrorModal, 3000);
                }
            }).catch((error) => {
                showErrorModal('Error checking room: ' + error.message);
            });
        }

        // Confirm nickname and start game
        function confirmNickname() {
            const nickname = nicknameInput.value.trim();
            
            // Validate nickname
            if (!nickname || nickname.length > 12) {
                showErrorModal('Please enter a valid nickname (max 12 characters)');
                return;
            }
            
            if (!/^[a-zA-Z]+$/.test(nickname)) {
                showErrorModal('Nickname should contain only English letters');
                return;
            }
            
            playerNickname = nickname;
            hideNicknameInputModal();
            
            // Generate unique player ID
            playerId = generatePlayerId();
            
            // Redirect to game with room and player info
            window.location.href = `chapter.html?room=${currentRoomId}&player=${playerId}&nickname=${encodeURIComponent(playerNickname)}`;
        }

        // Generate unique player ID
        function generatePlayerId() {
            return 'player-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }
    </script>
</body>
</html>
