<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔法学校时态冒险</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- All game pages will be dynamically loaded here -->
    </div>

    <!-- Hint Modal -->
    <div id="hint-modal" class="modal">
        <div class="modal-content">
            <p id="hint-message"></p>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state variables
        let currentPageId = '';
        let score = 0;
        let correctAnswers = 0;
        let totalQuestions = 15;
        let startTime = Date.now();
        let currentRoomCode = '';
        let isTeacher = false;
        let playerName = '';
        let currentChapter = 1;
        let imagesPreloaded = {};

        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const hintModal = document.getElementById('hint-modal');
        const hintMessage = document.getElementById('hint-message');

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentRoomCode = urlParams.get('room');
        isTeacher = urlParams.get('teacher') === 'true';
        playerName = urlParams.get('player') || '老师';

        // Initialize game
        if (isTeacher) {
            // Teacher view - go directly to results page
            loadPage('2501');
        } else {
            // Player view - start with first chapter
            loadPage('2101');
            startTime = Date.now();
            
            // Update player start time in Firebase
            if (currentRoomCode && playerName) {
                database.ref(`rooms/${currentRoomCode}/players/${playerName}/startTime`).set(
                    firebase.database.ServerValue.TIMESTAMP
                );
            }
        }

        // Preload next possible images
        function preloadImages(pageId) {
            const nextPages = getNextPages(pageId);
            nextPages.forEach(nextPageId => {
                const imageName = `画面${nextPageId.substring(1)}.jpg`;
                const imagePath = `images/${imageName}`;
                
                if (!imagesPreloaded[imagePath]) {
                    const img = new Image();
                    img.src = imagePath;
                    imagesPreloaded[imagePath] = true;
                }
            });
        }

        // Get possible next pages for preloading
        function getNextPages(pageId) {
            const pageMap = {
                '2001': ['2101', '2501'],
                '2101': ['2102'],
                '2102': ['2103'],
                '2103': ['2104'],
                '2104': ['2201'],
                '2201': ['2202'],
                '2202': ['2203'],
                '2203': ['2301'],
                '2301': ['2302'],
                '2302': ['2304'],
                '2303': ['2304'],
                '2304': ['2305'],
                '2305': ['2401'],
                '2401': ['2402'],
                '2402': ['2403'],
                '2403': ['2404'],
                '2404': ['2405'],
                '2405': ['2406'],
                '2406': ['2407'],
                '2407': ['2408'],
                '2408': ['2409'],
                '2409': ['2501'],
                '2501': []
            };
            return pageMap[pageId] || [];
        }

        // Load a game page
        function loadPage(pageId) {
            currentPageId = pageId;
            
            // Clear previous page
            gameContainer.innerHTML = '';
            
            // Create new page element
            const page = document.createElement('div');
            page.id = `page-${pageId}`;
            page.className = 'game-page active';
            
            // Add content based on page ID
            switch(pageId) {
                case '2501': // Results page
                    buildResultsPage(page);
                    break;
                default: // All other game pages
                    buildGamePage(page, pageId);
                    break;
            }
            
            // Add page to container
            gameContainer.appendChild(page);
            
            // Preload next possible images
            preloadImages(pageId);
        }

        // Build a standard game page
        function buildGamePage(page, pageId) {
            const pageNum = pageId.substring(1);
            const imageName = `画面${pageNum.padStart(2, '0')}.jpg`;
            
            // Add background image
            const bgImg = document.createElement('img');
            bgImg.src = `images/${imageName}`;
            bgImg.alt = `画面${pageNum}`;
            bgImg.className = 'background-image';
            page.appendChild(bgImg);
            
            // Add text content
            const textContent = getPageTextContent(pageId);
            if (textContent) {
                const textDiv = document.createElement('div');
                textDiv.className = 'text-content';
                textDiv.textContent = textContent;
                page.appendChild(textDiv);
            }
            
            // Add buttons
            const buttons = getPageButtons(pageId);
            if (buttons.length > 0) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';
                
                buttons.forEach(button => {
                    const btn = document.createElement('button');
                    btn.className = 'game-button';
                    btn.textContent = button.name;
                    
                    // Position class
                    if (buttons.length === 2) {
                        btn.classList.add(button.position === '左' ? 'left-button' : 'right-button');
                    } else {
                        btn.classList.add('center-button');
                    }
                    
                    // Click handler
                    btn.addEventListener('click', () => {
                        handleButtonClick(button, pageId);
                    });
                    
                    buttonContainer.appendChild(btn);
                });
                
                page.appendChild(buttonContainer);
            }
        }

        // Build the results page
        function buildResultsPage(page) {
            page.className = 'results-page';
            
            // Title
            const title = document.createElement('h1');
            title.textContent = '游戏结果';
            page.appendChild(title);
            
            // Room info
            const roomInfo = document.createElement('div');
            roomInfo.className = 'room-info';
            roomInfo.innerHTML = `<p>房间号: ${currentRoomCode}</p>`;
            page.appendChild(roomInfo);
            
            // Player results container
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'player-results';
            resultsContainer.className = 'results-container';
            page.appendChild(resultsContainer);
            
            // Leaderboard container
            const leaderboardContainer = document.createElement('div');
            leaderboardContainer.id = 'leaderboard';
            leaderboardContainer.className = 'leaderboard-container';
            leaderboardContainer.innerHTML = '<h2>排行榜</h2>';
            page.appendChild(leaderboardContainer);
            
            // Load and display real-time data from Firebase
            if (currentRoomCode) {
                const roomRef = database.ref(`rooms/${currentRoomCode}`);
                
                roomRef.on('value', (snapshot) => {
                    const roomData = snapshot.val();
                    if (roomData) {
                        updateResultsDisplay(roomData);
                    }
                });
            }
        }

        // Update the results display with Firebase data
        function updateResultsDisplay(roomData) {
            const resultsContainer = document.getElementById('player-results');
            const leaderboardContainer = document.getElementById('leaderboard');
            
            if (!roomData.players) {
                resultsContainer.innerHTML = '<p>暂无玩家数据</p>';
                leaderboardContainer.innerHTML = '<h2>排行榜</h2><p>暂无排行榜数据</p>';
                return;
            }
            
            // Convert players object to array
            const players = Object.values(roomData.players);
            
            // Display current player's results
            const currentPlayer = players.find(p => p.name === playerName) || {};
            resultsContainer.innerHTML = `
                <h2>你的成绩</h2>
                <p>名称: ${currentPlayer.name || ''}</p>
                <p>正确率: ${currentPlayer.correctRate ? currentPlayer.correctRate.toFixed(1) + '%' : '0%'}</p>
                <p>用时: ${formatTime(currentPlayer.timeUsed || 0)}</p>
                <p>得分: ${currentPlayer.score || 0}</p>
                <p>进度: 第${currentPlayer.currentChapter || 0}章</p>
            `;
            
            // Create and display leaderboard (top 10 players)
            const sortedPlayers = [...players].sort((a, b) => (b.score || 0) - (a.score || 0));
            let leaderboardHTML = '<h2>排行榜</h2><ol>';
            
            sortedPlayers.slice(0, 10).forEach((player, index) => {
                leaderboardHTML += `
                    <li>
                        ${player.name}: ${player.score || 0}分 
                        (正确率: ${player.correctRate ? player.correctRate.toFixed(1) + '%' : '0%'}, 
                        用时: ${formatTime(player.timeUsed || 0)})
                    </li>
                `;
            });
            
            leaderboardHTML += '</ol>';
            leaderboardContainer.innerHTML = leaderboardHTML;
        }

        // Format time (seconds to MM:SS)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Get text content for a page
        function getPageTextContent(pageId) {
            const contentMap = {
                '2101': '主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。',
                '2102': '有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。',
                '2103': 'Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着"时态魔法棒"。',
                '2104': 'Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。',
                '2201': '时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。',
                '2202': '昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。',
                '2203': '为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。',
                '2301': 'Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫"时态"，难道启动它的咒语和时态有关？',
                '2302': '于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼____了【现在完成】"',
                '2303': '只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。',
                '2304': 'Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。',
                '2305': 'Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）',
                '2401': '虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。',
                '2402': 'Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"',
                '2403': '今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"',
                '2404': '只见Tom用魔法棒指向天空，用咒语说了一句："It\'s going to rain soon"，魔法棒发出来蓝光。',
                '2405': '果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。',
                '2406': 'Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"',
                '2407': 'Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。',
                '2408': '馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。',
                '2409': 'Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....'
            };
            return contentMap[pageId] || '';
        }

        // Get buttons for a page
        function getPageButtons(pageId) {
            const buttonsMap = {
                '2101': [
                    { name: '打扫', position: '左', meaning: '正确', nextPage: '2102', isCorrect: true },
                    { name: '正在打扫', position: '右', meaning: '错误', nextPage: '2102', isCorrect: false, 
                      hint: '日常行为用一般现在时' }
                ],
                '2102': [
                    { name: '锁上', position: '左', meaning: '正确', nextPage: '2103', isCorrect: true },
                    { name: '正在锁上', position: '右', meaning: '错误', nextPage: '2103', isCorrect: false, 
                      hint: '描述昨天发生的简单行为用一般过去时' }
                ],
                '2103': [
                    { name: '继续', position: '中', meaning: '无', nextPage: '2104' }
                ],
                '2104': [
                    { name: '将去', position: '左', meaning: '正确', nextPage: '2201', isCorrect: true },
                    { name: '已经去', position: '右', meaning: '错误', nextPage: '2201', isCorrect: false, 
                      hint: '描述未来发生的简单行为用一般将来时' }
                ],
                '2201': [
                    { name: '正在骑', position: '左', meaning: '正确', nextPage: '2202', isCorrect: true },
                    { name: '已经骑', position: '右', meaning: '错误', nextPage: '2202', isCorrect: false, 
                      hint: '描述正在进行的行为用现在进行时' }
                ],
                '2202': [
                    { name: '正在打扫', position: '左', meaning: '正确', nextPage: '2203', isCorrect: true },
                    { name: '已经打扫', position: '右', meaning: '错误', nextPage: '2203', isCorrect: false, 
                      hint: '描述过去正在进行的行为用过去进行时' }
                ],
                '2203': [
                    { name: '打扫', position: '左', meaning: '正确', nextPage: '2301', isCorrect: true },
                    { name: '已经打扫', position: '右', meaning: '错误', nextPage: '2301', isCorrect: false, 
                      hint: '描述将来正在进行的行为用将来进行时' }
                ],
                '2301': [
                    { name: '拿出', position: '左', meaning: '正确', nextPage: '2302', isCorrect: true },
                    { name: '已经拿出', position: '右', meaning: '错误', nextPage: '2302', isCorrect: false, 
                      hint: '描述日常行为一般现在时' }
                ],
                '2302': [
                    { name: '已经被烤熟', position: '左', meaning: '正确', nextPage: '2304', isCorrect: true },
                    { name: '将来被烤熟', position: '右', meaning: '错误', nextPage: '2304', isCorrect: false, 
                      hint: '咒语未生效，Tom重新念了一条香喷喷的鱼已经被烤熟了' }
                ],
                '2303': [
                    { name: '继续', position: '中', meaning: '无', nextPage: '2304' }
                ],
                '2304': [
                    { name: '已经烤好的鱼', position: '左', meaning: '正确', nextPage: '2305', isCorrect: true },
                    { name: '将要烤好', position: '右', meaning: '错误', nextPage: '2305', isCorrect: false, 
                      hint: '描述已经完成的的行为用现在完成时' }
                ],
                '2305': [
                    { name: '将会被打败', position: '左', meaning: '正确', nextPage: '2401', isCorrect: true },
                    { name: '已经被打败', position: '右', meaning: '错误', nextPage: '2401', isCorrect: false, 
                      hint: '描述将来完成的的行为用将来完成时' }
                ],
                '2401': [
                    { name: '学习了', position: '左', meaning: '正确', nextPage: '2402', isCorrect: true },
                    { name: '将学习', position: '右', meaning: '错误', nextPage: '2402', isCorrect: false, 
                      hint: '描述过去的行为持续到现在用现在完成进行' }
                ],
                '2402': [
                    { name: '可以用', position: '左', meaning: '正确', nextPage: '2403', isCorrect: true },
                    { name: '正在用', position: '右', meaning: '错误', nextPage: '2403', isCorrect: false, 
                      hint: '描述正在进行的行为用现在进行时' }
                ],
                '2403': [
                    { name: '输给', position: '左', meaning: '正确', nextPage: '2404', isCorrect: true },
                    { name: '将输给', position: '右', meaning: '错误', nextPage: '2404', isCorrect: false, 
                      hint: '描述正在进行的行为用现在进行时' }
                ],
                '2404': [
                    { name: '继续', position: '中', meaning: '无', nextPage: '2405' }
                ],
                '2405': [
                    { name: '继续', position: '中', meaning: '无', nextPage: '2406' }
                ],
                '2406': [
                    { name: '已经学了', position: '左', meaning: '正确', nextPage: '2407', isCorrect: true },
                    { name: '将要学', position: '右', meaning: '错误', nextPage: '2407', isCorrect: false, 
                      hint: '描述将来完成进行时' }
                ],
                '2407': [
                    { name: '继续', position: '中', meaning: '无', nextPage: '2408' }
                ],
                '2408': [
                    { name: '找了', position: '左', meaning: '正确', nextPage: '2409', isCorrect: true },
                    { name: '将找', position: '右', meaning: '错误', nextPage: '2409', isCorrect: false, 
                      hint: '描述过去完成' }
                ],
                '2409': [
                    { name: '游戏结束', position: '中', meaning: '无', nextPage: '2501' }
                ]
            };
            return buttonsMap[pageId] || [];
        }

        // Handle button click
        function handleButtonClick(button, currentPageId) {
            // Update chapter progress
            const newChapter = getChapterFromPage(button.nextPage);
            if (newChapter > currentChapter) {
                currentChapter = newChapter;
                
                // Update chapter progress in Firebase
                if (currentRoomCode && playerName) {
                    database.ref(`rooms/${currentRoomCode}/players/${playerName}/currentChapter`).set(currentChapter);
                }
            }
            
            // Handle correct/incorrect answers
            if (button.isCorrect === true) {
                // Correct answer - add to score
                correctAnswers++;
                score += 6.7;
                
                // Update score in Firebase
                if (currentRoomCode && playerName) {
                    const playerRef = database.ref(`rooms/${currentRoomCode}/players/${playerName}`);
                    
                    // Calculate time used in seconds
                    const timeUsed = Math.floor((Date.now() - startTime) / 1000);
                    const timeScore = Math.floor(timeUsed / 60) * 2 + (timeUsed % 60 > 0 ? 1 : 0);
                    const totalScore = score + timeScore;
                    const correctRate = (correctAnswers / totalQuestions * 100).toFixed(1);
                    
                    playerRef.update({
                        score: totalScore,
                        correctRate: parseFloat(correctRate),
                        timeUsed: timeUsed
                    });
                }
                
                // Proceed to next page
                loadPage(button.nextPage);
            } else if (button.isCorrect === false) {
                // Incorrect answer - show hint
                showHint(button.hint, button.nextPage);
            } else {
                // Neutral button - just proceed
                loadPage(button.nextPage);
            }
        }

        // Get chapter number from page ID
        function getChapterFromPage(pageId) {
            const chapterMap = {
                '2101': 1, '2102': 1, '2103': 1, '2104': 1,
                '2201': 2, '2202': 2, '2203': 2,
                '2301': 3, '2302': 3, '2303': 3, '2304': 3, '2305': 3,
                '2401': 4, '2402': 4, '2403': 4, '2404': 4, '2405': 4, 
                '2406': 4, '2407': 4, '2408': 4, '2409': 4,
                '2501': 5
            };
            return chapterMap[pageId] || 0;
        }

        // Show hint message
        function showHint(message, nextPage) {
            hintMessage.textContent = message;
            hintModal.style.display = 'block';
            
            // Hide hint and proceed after 3 seconds
            setTimeout(() => {
                hintModal.style.display = 'none';
                loadPage(nextPage);
            }, 3000);
        }

        // Close hint modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === hintModal) {
                hintModal.style.display = 'none';
            }
        });
    </script>
</body>
</html>
