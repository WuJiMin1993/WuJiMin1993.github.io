<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game - Chapters</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Game Container for all screens -->
    <div id="game-container">
        <!-- Screens will be dynamically loaded here -->
    </div>

    <!-- Hint Box -->
    <div id="hint-box" class="hint-box">
        <p id="hint-text"></p>
    </div>

    <!-- Preloader for images -->
    <div id="preloader" style="display:none;"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomNumber = urlParams.get('room');
        const isTeacher = urlParams.get('teacher') === 'true';
        const playerId = urlParams.get('player');
        const nickname = decodeURIComponent(urlParams.get('nickname') || '');

        // Game state variables
        let currentScreen = '2101'; // Start with screen 2101
        let score = 0;
        let correctAnswers = 0;
        let startTime = null;
        let clickedButtons = new Set(); // Track clicked buttons to prevent multiple clicks
        let nextImagePreloaded = false;

        // DOM Elements
        const gameContainer = document.getElementById('game-container');
        const hintBox = document.getElementById('hint-box');
        const hintText = document.getElementById('hint-text');
        const preloader = document.getElementById('preloader');

        // Screen definitions
        const screens = {
            // Chapter 1
            '2101': {
                image: '画面01.jpg',
                text: 'Tom lives in a magical world and ____ the school library every day.',
                buttons: [
                    { text: 'cleans', position: 'left', correct: true, nextScreen: '2102' },
                    { text: 'cleaning', position: 'right', correct: false, 
                      hint: 'Daily behavior is expressed in the present tense', nextScreen: '2102' }
                ]
            },
            '2102': {
                image: '画面02.jpg',
                text: 'Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.',
                buttons: [
                    { text: 'locked', position: 'left', correct: true, nextScreen: '2103' },
                    { text: 'locks', position: 'right', correct: false, 
                      hint: 'Describe the simple behavior that occurred yesterday in the past simple tense', nextScreen: '2103' }
                ]
            },
            '2103': {
                image: '画面03.jpg',
                text: 'Tom walked over curiously and saw a magic wand with a flashing blue light, with a label next to it that read: Tense Magic wand.',
                buttons: [
                    { text: 'continue', position: 'center', correct: null, nextScreen: '2104' }
                ]
            },
            '2104': {
                image: '画面04.jpg',
                text: 'Tom became curious and hid his magic wand in his clothes before taking it away from the library He ____ outdoors tomorrow to test the power of the magic wand.',
                buttons: [
                    { text: 'will go', position: 'left', correct: true, nextScreen: '2201' },
                    { text: 'is going', position: 'right', correct: false, 
                      hint: 'Describe simple behaviors that will occur in the future using general future tense', nextScreen: '2201' }
                ]
            },
            // Chapter 2
            '2201': {
                image: '画面05.jpg',
                text: 'The next morning, he ____ a magic broom towards a forest next to the school.',
                buttons: [
                    { text: 'is riding', position: 'left', correct: true, nextScreen: '2202' },
                    { text: 'has ridden', position: 'right', correct: false, 
                      hint: 'Describe the ongoing behavior in present continuous tense', nextScreen: '2202' }
                ]
            },
            '2202': {
                image: '画面06.jpg',
                text: 'At this time yesterday, Tom was cleaning the library. He was supposed to be organizing books in the library today, but he thought this magic wand would be fun. So I decided to slack off and not go to the library anymore.',
                buttons: [
                    { text: 'was cleaning', position: 'left', correct: true, nextScreen: '2203' },
                    { text: 'is cleaning', position: 'right', correct: false, 
                      hint: '描述过去正在进行的行为用过去进行时', nextScreen: '2203' }
                ]
            },
            '2203': {
                image: '画面07.jpg',
                text: 'Tom will be tidying up the library early tomorrow to prevent library director Jimmy from discovering his laziness.',
                buttons: [
                    { text: 'will be tidying up', position: 'left', correct: true, nextScreen: '2301' },
                    { text: 'is tidying up', position: 'right', correct: false, 
                      hint: 'Describe the ongoing behavior in the future using future continuous tense', nextScreen: '2301' }
                ]
            },
            // Chapter 3
            '2301': {
                image: '画面08.jpg',
                text: 'Tom stops by the stream in the forest and ____ the magic wand from his clothes. He thought that the magic wand is called a tense magic wand. Is the spell that activates it related to tense?',
                buttons: [
                    { text: 'takes out', position: 'left', correct: true, nextScreen: '2302' },
                    { text: 'will take out', position: 'right', correct: false, 
                      hint: 'Describe daily behavior in the present tense', nextScreen: '2302' }
                ]
            },
            '2302': {
                image: '画面09.jpg',
                text: 'So he decided to try combining the spells he learned at the magic school. Tom pointed his magic wand at the stream and said, "A delicious fish ____."',
                buttons: [
                    { text: 'has been grilled', position: 'left', correct: true, nextScreen: '2304' },
                    { text: 'will be grilled', position: 'right', correct: false, 
                      hint: 'The spell didn\'t take effect, Tom recited a delicious fish that had already been grilled', nextScreen: '2304' }
                ]
            },
            '2303': {
                image: '画面10.jpg',
                text: 'After reciting the spell, a sudden blue flash appeared. Then a grill made of tree branches appeared in front of Tom, with a fragrant grilled fish on top.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2304' }
                ]
            },
            '2304': {
                image: '画面11.jpg',
                text: 'Tom hadn\'t had breakfast before coming here, and his stomach was growling. Tom ____ the grilled fish and begins eating.',
                buttons: [
                    { text: 'has taken', position: 'left', correct: true, nextScreen: '2305' },
                    { text: 'will take', position: 'right', correct: false, 
                      hint: 'Describe completed actions in present perfect tense', nextScreen: '2305' }
                ]
            },
            '2305': {
                image: '画面12.jpg',
                text: 'Tom thinks that now he has the powerful wand. And the wizard who always bullies me ____ by him.',
                buttons: [
                    { text: 'will have been defeated', position: 'left', correct: true, nextScreen: '2401' },
                    { text: 'has been defeated', position: 'right', correct: false, 
                      hint: 'Describe the behavior to be completed in the future using the future perfect tense', nextScreen: '2401' }
                ]
            },
            // Chapter 4
            '2401': {
                image: '画面13.jpg',
                text: 'Although Tom ____ magic at the school for a year, his knowledge of magic is still inferior to that of wizard Mike.',
                buttons: [
                    { text: 'has been studying', position: 'left', correct: true, nextScreen: '2402' },
                    { text: 'will studying', position: 'right', correct: false, 
                      hint: 'The action has been ongoing from the past to the present, and may have just ended or is still ongoing, using the present to complete the ongoing tense', nextScreen: '2402' }
                ]
            },
            '2402': {
                image: '画面14.jpg',
                text: 'So Tom came to the house of the wizard Mike who used to tease him. Tom shouted at Mike, "I ____ magic to defeat you. Come out and accept my challenge."',
                buttons: [
                    { text: 'will use', position: 'left', correct: true, nextScreen: '2403' },
                    { text: 'am using', position: 'right', correct: false, 
                      hint: 'Describe future actions using future continuous tense', nextScreen: '2403' }
                ]
            },
            '2403': {
                image: '画面15.jpg',
                text: 'Mike walked out of the room and said, "Tom, you ____ to me over the past year. Are you still not willing to give up?"',
                buttons: [
                    { text: 'had been repeatedly losing', position: 'left', correct: true, nextScreen: '2404' },
                    { text: 'was losing', position: 'right', correct: false, 
                      hint: 'A certain past action started earlier in the past and continued until a certain point in time, possibly still continuing or just stopped', nextScreen: '2404' }
                ]
            },
            '2404': {
                image: '画面16.jpg',
                text: 'Tom pointed his magic wand at the sky and cursed "It\'s going to rain soon," and the wand emitted blue light.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2405' }
                ]
            },
            '2405': {
                image: '画面17.jpg',
                text: 'Before long, dark clouds appeared in the sky, thunder started to strike, and raindrops began to fall.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2406' }
                ]
            },
            '2406': {
                image: '画面18.jpg',
                text: 'By tomorrow, Mike ____ magic for 2 years now. But Mike was still stunned when he saw Tom\'s magic. Mike had never seen such a powerful magic before and said to Tom, "I admit you\'re already better than me."',
                buttons: [
                    { text: 'will have been studying', position: 'left', correct: true, nextScreen: '2407' },
                    { text: 'will be studying', position: 'right', correct: false, 
                      hint: 'Emphasize how long a certain action has been ongoing until a certain point in the future, using the future completion continuous time', nextScreen: '2407' }
                ]
            },
            '2407': {
                image: '画面19.jpg',
                text: 'Tom wants to show off the power of his magic wand again and is ready to recite the next spell. But suddenly a beam of light flashed and the library director Jimmy appeared in front of him.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2408' }
                ]
            },
            '2408': {
                image: '画面20.jpg',
                text: 'Library director Jimmy said to Tom, "I ____ for it all day, but you took it away."',
                buttons: [
                    { text: 'have been looking', position: 'left', correct: true, nextScreen: '2409' },
                    { text: 'am looking', position: 'right', correct: false, 
                      hint: 'Describe actions that have been completed in the past and use them to complete them', nextScreen: '2409' }
                ]
            },
            '2409': {
                image: '画面21.jpg',
                text: 'Jimmy raised his hand, and the magic wand automatically flew into Jimmy\'s hand. Then Jimmy shouted at Tom, "Hurry back and clean the library for me."',
                buttons: [
                    { text: 'Game over', position: 'center', correct: null, nextScreen: '2501' }
                ]
            },
            // Ranking Screen
            '2501': {
                isRankingScreen: true
            }
        };

        // Initialize the game
        function initGame() {
            if (isTeacher) {
                // Teacher goes directly to ranking screen
                currentScreen = '2501';
                loadRankingScreen();
                startRoomMonitoring();
            } else {
                // Player starts the game
                startTime = Date.now();
                loadScreen(currentScreen);
                startPlayerUpdates();
                
                // Preload next image
                preloadNextImage();
            }
        }

        // Load a game screen
        function loadScreen(screenId) {
            clickedButtons.clear(); // Reset clicked buttons for new screen
            
            const screen = screens[screenId];
            if (!screen) {
                console.error('Screen not found:', screenId);
                return;
            }
            
            // Update current screen in game state
            currentScreen = screenId;
            
            // Calculate progress (1-21)
            const progress = Math.floor((parseInt(screenId.substring(1)) - 2100) / 100 * 21);
            
            // Update player data in Firebase
            if (playerId) {
                updatePlayerData(progress);
            }
            
            // Clear previous screen
            gameContainer.innerHTML = '';
            
            if (screen.isRankingScreen) {
                loadRankingScreen();
                return;
            }
            
            // Create screen elements
            const screenDiv = document.createElement('div');
            screenDiv.className = 'screen active';
            
            // Add image
            const img = document.createElement('img');
            img.src = `images/${screen.image}`;
            img.alt = `Scene ${screenId}`;
            img.className = 'game-image fade-in';
            screenDiv.appendChild(img);
            
            // Add text box
            const textBox = document.createElement('div');
            textBox.className = 'text-box';
            textBox.textContent = screen.text;
            screenDiv.appendChild(textBox);
            
            // Add buttons container
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'button-container';
            
            // Add buttons
            screen.buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = `game-btn ${button.position}`;
                btn.textContent = button.text;
                
                // Store button data as attributes
                btn.dataset.correct = button.correct;
                btn.dataset.nextScreen = button.nextScreen;
                if (button.hint) {
                    btn.dataset.hint = button.hint;
                }
                
                btn.addEventListener('click', handleButtonClick);
                buttonContainer.appendChild(btn);
            });
            
            screenDiv.appendChild(buttonContainer);
            gameContainer.appendChild(screenDiv);
        }

        // Handle button clicks
        function handleButtonClick(event) {
            const button = event.target;
            const buttonId = `${currentScreen}-${button.textContent}`;
            
            // Prevent multiple clicks on the same button
            if (clickedButtons.has(buttonId)) {
                return;
            }
            clickedButtons.add(buttonId);
            
            // Check if button is correct
            const isCorrect = button.dataset.correct === 'true';
            const nextScreen = button.dataset.nextScreen;
            const hint = button.dataset.hint;
            
            // Update score if answer is correct
            if (isCorrect) {
                score += 6.7;
                correctAnswers++;
                
                // Update player data in Firebase
                if (playerId) {
                    updatePlayerData(null, true);
                }
            }
            
            // Show hint if answer is wrong
            if (hint && !isCorrect) {
                showHint(hint);
            }
            
            // Preload next image if not already done
            if (!nextImagePreloaded && nextScreen !== '2501') {
                preloadImage(`images/${screens[nextScreen].image}`);
                nextImagePreloaded = true;
            }
            
            // Proceed to next screen after delay if there's a hint
            if (hint) {
                setTimeout(() => {
                    proceedToNextScreen(nextScreen);
                }, 3000);
            } else {
                proceedToNextScreen(nextScreen);
            }
        }

        // Proceed to next screen
        function proceedToNextScreen(nextScreen) {
            if (nextScreen === '2501') {
                // Game over, go to ranking screen
                endGame();
            } else {
                // Load next game screen
                loadScreen(nextScreen);
                nextImagePreloaded = false;
                
                // Preload next next image
                preloadNextImage();
            }
        }

        // Show hint message
        function showHint(message) {
            hintText.textContent = message;
            hintBox.style.display = 'block';
            
            setTimeout(() => {
                hintBox.style.display = 'none';
            }, 3000);
        }

        // Preload next image
        function preloadNextImage() {
            const nextScreenId = screens[currentScreen].buttons[0].nextScreen;
            if (nextScreenId && nextScreenId !== '2501') {
                preloadImage(`images/${screens[nextScreenId].image}`);
            }
        }

        // Preload an image
        function preloadImage(src) {
            const img = new Image();
            img.src = src;
            preloader.appendChild(img);
        }

        // Update player data in Firebase
        function updatePlayerData(progress, updateScore = false) {
            if (!playerId || !roomNumber) return;
            
            const updates = {};
            if (progress !== null) {
                updates.currentProgress = progress;
                updates.currentScreen = currentScreen;
            }
            if (updateScore) {
                updates.score = score;
                updates.correctAnswers = correctAnswers;
            }
            
            database.ref(`rooms/${roomNumber}/players/${playerId}`).update(updates)
                .catch(error => {
                    console.error('Error updating player data:', error);
                });
        }

        // Start periodic player updates
        function startPlayerUpdates() {
            setInterval(() => {
                if (playerId && roomNumber && currentScreen !== '2501') {
                    updatePlayerData(null, false);
                }
            }, 3000); // Update every 3 seconds
        }

        // End game and go to ranking screen
        function endGame() {
            // Calculate final score
            const gameTime = Math.min(Math.floor((Date.now() - startTime) / 1000 / 60), 60); // in minutes, max 60
            const timeScore = gameTime * 2;
            const finalScore = Math.min(Math.floor(score + timeScore), 100);
            const accuracy = (correctAnswers / 15 * 100).toFixed(1);
            
            // Update final player data
            database.ref(`rooms/${roomNumber}/players/${playerId}`).update({
                score: finalScore,
                correctAnswers: correctAnswers,
                accuracy: accuracy,
                gameTime: gameTime,
                finished: true,
                finishTime: firebase.database.ServerValue.TIMESTAMP
            }).then(() => {
                loadRankingScreen();
            }).catch(error => {
                console.error('Error updating final player data:', error);
                loadRankingScreen();
            });
        }

        // Load ranking screen
        function loadRankingScreen() {
            gameContainer.innerHTML = '';
            
            const rankingDiv = document.createElement('div');
            rankingDiv.className = 'ranking-screen';
            
            // Room info box
            const roomInfoBox = document.createElement('div');
            roomInfoBox.className = 'room-info';
            
            const roomNumberEl = document.createElement('p');
            roomNumberEl.textContent = `Room: ${roomNumber}`;
            roomInfoBox.appendChild(roomNumberEl);
            
            const playerCountEl = document.createElement('p');
            playerCountEl.textContent = 'Players: Loading...';
            roomInfoBox.appendChild(playerCountEl);
            
            rankingDiv.appendChild(roomInfoBox);
            
            // Ranking table
            const rankingTable = document.createElement('table');
            rankingTable.className = 'ranking-table';
            
            const headerRow = document.createElement('tr');
            ['Rank', 'Name', 'Score', 'Accuracy', 'Time'].forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });
            rankingTable.appendChild(headerRow);
            
            const tableBody = document.createElement('tbody');
            tableBody.id = 'ranking-body';
            rankingTable.appendChild(tableBody);
            
            rankingDiv.appendChild(rankingTable);
            gameContainer.appendChild(rankingDiv);
            
            // Start room monitoring
            startRoomMonitoring(playerCountEl);
        }

        // Start monitoring room data for ranking
        function startRoomMonitoring(playerCountEl) {
            if (!roomNumber) return;
            
            const roomRef = database.ref(`rooms/${roomNumber}/players`);
            roomRef.on('value', snapshot => {
                const players = snapshot.val() || {};
                
                // Update player count
                if (playerCountEl) {
                    const playerCount = Object.keys(players).length;
                    playerCountEl.textContent = `Players: ${playerCount}`;
                }
                
                // Prepare player data for ranking
                const playerArray = [];
                Object.keys(players).forEach(id => {
                    if (players[id].finished) {
                        playerArray.push({
                            id: id,
                            nickname: players[id].nickname || 'Anonymous',
                            score: players[id].score || 0,
                            accuracy: players[id].accuracy || '0.0',
                            time: players[id].gameTime || 0
                        });
                    }
                });
                
                // Sort by score (descending)
                playerArray.sort((a, b) => b.score - a.score);
                
                // Update ranking table
                const rankingBody = document.getElementById('ranking-body');
                if (rankingBody) {
                    rankingBody.innerHTML = '';
                    
                    // Show top 10 players
                    playerArray.slice(0, 10).forEach((player, index) => {
                        const row = document.createElement('tr');
                        
                        // Highlight current player
                        if (player.id === playerId) {
                            row.className = 'highlight-player';
                        }
                        
                        // Add cells
                        const rankCell = document.createElement('td');
                        rankCell.textContent = index + 1;
                        row.appendChild(rankCell);
                        
                        const nameCell = document.createElement('td');
                        nameCell.textContent = player.nickname;
                        row.appendChild(nameCell);
                        
                        const scoreCell = document.createElement('td');
                        scoreCell.textContent = player.score;
                        row.appendChild(scoreCell);
                        
                        const accuracyCell = document.createElement('td');
                        accuracyCell.textContent = `${player.accuracy}%`;
                        row.appendChild(accuracyCell);
                        
                        const timeCell = document.createElement('td');
                        timeCell.textContent = `${player.time} min`;
                        row.appendChild(timeCell);
                        
                        rankingBody.appendChild(row);
                    });
                }
            });
        }

        // Initialize the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
