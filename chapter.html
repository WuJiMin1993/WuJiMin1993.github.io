<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>时态魔法棒 - 章节</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <!-- 章节1 -->
        <div id="scene-2101" class="scene">
            <div class="scene-image" style="background-image: url('images/画面01.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2101', 'left', true)">打扫</button>
                    <button class="scene-button right" onclick="handleAnswer('2101', 'right', false)">正在打扫</button>
                </div>
            </div>
        </div>

        <div id="scene-2102" class="scene">
            <div class="scene-image" style="background-image: url('images/画面02.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2102', 'left', true)">锁上</button>
                    <button class="scene-button right" onclick="handleAnswer('2102', 'right', false)">正在锁上</button>
                </div>
            </div>
        </div>

        <div id="scene-2103" class="scene">
            <div class="scene-image" style="background-image: url('images/画面03.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着"时态魔法棒"。</div>
                <div class="scene-buttons">
                    <button class="scene-button center" onclick="nextScene('2103', '2104')">继续</button>
                </div>
            </div>
        </div>

        <div id="scene-2104" class="scene">
            <div class="scene-image" style="background-image: url('images/画面04.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2104', 'left', true)">将去</button>
                    <button class="scene-button right" onclick="handleAnswer('2104', 'right', false)">已经去</button>
                </div>
            </div>
        </div>

        <!-- 章节2 -->
        <div id="scene-2201" class="scene">
            <div class="scene-image" style="background-image: url('images/画面05.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2201', 'left', true)">正在骑</button>
                    <button class="scene-button right" onclick="handleAnswer('2201', 'right', false)">已经骑</button>
                </div>
            </div>
        </div>

        <div id="scene-2202" class="scene">
            <div class="scene-image" style="background-image: url('images/画面06.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2202', 'left', true)">正在打扫</button>
                    <button class="scene-button right" onclick="handleAnswer('2202', 'right', false)">已经打扫</button>
                </div>
            </div>
        </div>

        <div id="scene-2203" class="scene">
            <div class="scene-image" style="background-image: url('images/画面07.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2203', 'left', true)">打扫</button>
                    <button class="scene-button right" onclick="handleAnswer('2203', 'right', false)">已经打扫</button>
                </div>
            </div>
        </div>

        <!-- 章节3 -->
        <div id="scene-2301" class="scene">
            <div class="scene-image" style="background-image: url('images/画面08.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫"时态"，难道启动它的咒语和时态有关？</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2301', 'left', true)">拿出</button>
                    <button class="scene-button right" onclick="handleAnswer('2301', 'right', false)">已经拿出</button>
                </div>
            </div>
        </div>

        <div id="scene-2302" class="scene">
            <div class="scene-image" style="background-image: url('images/画面09.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼已经被烤熟了【现在完成】"。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2302', 'left', true)">已经被烤熟</button>
                    <button class="scene-button right" onclick="handleAnswer('2302', 'right', false)">将来被烤熟</button>
                </div>
            </div>
        </div>

        <div id="scene-2303" class="scene">
            <div class="scene-image" style="background-image: url('images/画面10.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。</div>
                <div class="scene-buttons">
                    <button class="scene-button center" onclick="nextScene('2303', '2304')">继续</button>
                </div>
            </div>
        </div>

        <div id="scene-2304" class="scene">
            <div class="scene-image" style="background-image: url('images/画面11.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2304', 'left', true)">已经烤好的鱼</button>
                    <button class="scene-button right" onclick="handleAnswer('2304', 'right', false)">将要烤好</button>
                </div>
            </div>
        </div>

        <div id="scene-2305" class="scene">
            <div class="scene-image" style="background-image: url('images/画面12.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2305', 'left', true)">将会被打败</button>
                    <button class="scene-button right" onclick="handleAnswer('2305', 'right', false)">已经被打败</button>
                </div>
            </div>
        </div>

        <!-- 章节4 -->
        <div id="scene-2401" class="scene">
            <div class="scene-image" style="background-image: url('images/画面13.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2401', 'left', true)">学习了</button>
                    <button class="scene-button right" onclick="handleAnswer('2401', 'right', false)">将学习</button>
                </div>
            </div>
        </div>

        <div id="scene-2402" class="scene">
            <div class="scene-image" style="background-image: url('images/画面14.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2402', 'left', true)">可以用</button>
                    <button class="scene-button right" onclick="handleAnswer('2402', 'right', false)">正在用</button>
                </div>
            </div>
        </div>

        <div id="scene-2403" class="scene">
            <div class="scene-image" style="background-image: url('images/画面15.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2403', 'left', true)">输给</button>
                    <button class="scene-button right" onclick="handleAnswer('2403', 'right', false)">将输给</button>
                </div>
            </div>
        </div>

        <div id="scene-2404" class="scene">
            <div class="scene-image" style="background-image: url('images/画面16.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">只见Tom用魔法棒指向天空，用咒语说了一句："It's going to rain soon"，魔法棒发出来蓝光。</div>
                <div class="scene-buttons">
                    <button class="scene-button center" onclick="nextScene('2404', '2405')">继续</button>
                </div>
            </div>
        </div>

        <div id="scene-2405" class="scene">
            <div class="scene-image" style="background-image: url('images/画面17.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。</div>
                <div class="scene-buttons">
                    <button class="scene-button center" onclick="nextScene('2405', '2406')">继续</button>
                </div>
            </div>
        </div>

        <div id="scene-2406" class="scene">
            <div class="scene-image" style="background-image: url('images/画面18.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2406', 'left', true)">已经学了</button>
                    <button class="scene-button right" onclick="handleAnswer('2406', 'right', false)">将要学</button>
                </div>
            </div>
        </div>

        <div id="scene-2407" class="scene">
            <div class="scene-image" style="background-image: url('images/画面19.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。</div>
                <div class="scene-buttons">
                    <button class="scene-button center" onclick="nextScene('2407', '2408')">继续</button>
                </div>
            </div>
        </div>

        <div id="scene-2408" class="scene">
            <div class="scene-image" style="background-image: url('images/画面20.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。</div>
                <div class="scene-buttons">
                    <button class="scene-button left" onclick="handleAnswer('2408', 'left', true)">找了</button>
                    <button class="scene-button right" onclick="handleAnswer('2408', 'right', false)">将找</button>
                </div>
            </div>
        </div>

        <div id="scene-2409" class="scene">
            <div class="scene-image" style="background-image: url('images/画面21.jpg');"></div>
            <div class="scene-content">
                <div class="scene-text">Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....</div>
                <div class="scene-buttons">
                    <button class="scene-button center" onclick="nextScene('2409', '2410')">继续</button>
                </div>
            </div>
        </div>

        <div id="scene-2410" class="scene">
            <div class="scene-image"></div>
            <div class="scene-content">
                <div class="scene-text">
                    <h2>游戏结束</h2>
                    <div id="game-summary">
                        <p>正确率: <span id="accuracy">0%</span></p>
                        <p>闯关所用时间: <span id="time-used">0分0秒</span></p>
                        <p>总得分: <span id="total-score">0</span></p>
                    </div>
                </div>
                <div class="scene-buttons">
                    <button class="scene-button center" onclick="location.reload()">重新开始</button>
                </div>
            </div>
        </div>

        <!-- 错误提示框 -->
        <div id="error-tip" class="error-tip">
            <div class="error-content"></div>
        </div>
    </div>

    <script>
        // 从URL获取当前场景ID
        const urlParams = new URLSearchParams(window.location.search);
        let currentSceneId = urlParams.get('scene') || '2101';
        
        // 从localStorage恢复游戏状态
        let gameState = JSON.parse(localStorage.getItem('gameState')) || {
            score: 0,
            startTime: new Date().getTime(),
            correctAnswers: 0,
            answeredQuestions: new Set()
        };

        // 如果是从开始页面跳转过来，重置游戏状态
        if (urlParams.get('reset') === 'true') {
            gameState = {
                score: 0,
                startTime: new Date().getTime(),
                correctAnswers: 0,
                answeredQuestions: new Set()
            };
            localStorage.setItem('gameState', JSON.stringify(gameState));
        }

        // 页面加载完成后显示当前场景
        window.addEventListener('load', function() {
            showScene(currentSceneId);
            
            // 预加载下一张可能的图片
            preloadNextImage(currentSceneId);
        });

        // 显示指定场景
        function showScene(sceneId) {
            // 隐藏所有场景
            document.querySelectorAll('.scene').forEach(scene => {
                scene.classList.remove('active');
                scene.style.display = 'none';
            });
            
            // 显示当前场景
            const currentScene = document.getElementById(`scene-${sceneId}`);
            if (currentScene) {
                currentScene.style.display = 'block';
                setTimeout(() => {
                    currentScene.classList.add('active');
                }, 10);
            }
            
            // 如果是游戏结束场景，计算并显示结果
            if (sceneId === '2410') {
                calculateAndDisplayResults();
            }
        }

        // 处理答案选择
        function handleAnswer(sceneId, buttonPosition, isCorrect) {
            // 检查是否已经回答过这个问题
            if (gameState.answeredQuestions.has(sceneId)) {
                return;
            }
            
            // 标记问题已回答
            gameState.answeredQuestions.add(sceneId);
            
            // 更新游戏状态
            if (isCorrect) {
                gameState.score += 6.7;
                gameState.correctAnswers++;
            } else {
                // 显示错误提示
                showErrorTip(sceneId, buttonPosition);
            }
            
            // 保存游戏状态
            localStorage.setItem('gameState', JSON.stringify(gameState));
            
            // 根据场景ID决定下一个场景
            let nextSceneId;
            switch (sceneId) {
                case '2101':
                case '2102':
                case '2104':
                case '2201':
                case '2202':
                case '2203':
                case '2301':
                case '2302':
                case '2304':
                case '2305':
                case '2401':
                case '2402':
                case '2403':
                case '2406':
                case '2408':
                    nextSceneId = String(parseInt(sceneId) + 1);
                    break;
                default:
                    nextSceneId = '2410'; // 默认跳转到结束场景
            }
            
            // 如果不是错误答案，直接跳转
            if (isCorrect) {
                setTimeout(() => {
                    nextScene(sceneId, nextSceneId);
                }, 300);
            } else {
                // 如果是错误答案，显示提示后跳转
                setTimeout(() => {
                    nextScene(sceneId, nextSceneId);
                }, 3000);
            }
        }

        // 显示错误提示
        function showErrorTip(sceneId, buttonPosition) {
            const errorTip = document.getElementById('error-tip');
            const errorContent = errorTip.querySelector('.error-content');
            
            // 设置提示内容
            let tipText = '';
            switch (sceneId) {
                case '2101': tipText = '日常行为用一般现在时'; break;
                case '2102': tipText = '描述昨天发生的简单行为用一般过去时'; break;
                case '2104': tipText = '描述未来发生的简单行为用一般将来时'; break;
                case '2201': tipText = '描述正在进行的行为用现在进行时'; break;
                case '2202': tipText = '描述过去正在进行的行为用过去进行时'; break;
                case '2203': tipText = '描述将来正在进行的行为用将来进行时'; break;
                case '2301': tipText = '描述日常行为一般现在时'; break;
                case '2302': tipText = '咒语未生效，请重新试'; break;
                case '2304': tipText = '描述已经完成的行为用现在完成时'; break;
                case '2305': tipText = '描述将来完成的行为用将来完成时'; break;
                case '2401': tipText = '描述过去的行为持续到现在用现在完成进行'; break;
                case '2402': tipText = '描述正在进行的行为用现在进行时'; break;
                case '2403': tipText = '描述正在进行的行为用现在进行时'; break;
                case '2406': tipText = '描述将来完成进行时'; break;
                case '2408': tipText = '描述过去完成'; break;
                default: tipText = '答案不正确';
            }
            
            errorContent.textContent = tipText;
            
            // 根据按钮位置设置提示框位置
            if (buttonPosition === 'left') {
                errorTip.style.left = '20%';
                errorTip.style.right = 'auto';
            } else {
                errorTip.style.left = 'auto';
                errorTip.style.right = '20%';
            }
            
            // 显示提示框
            errorTip.style.display = 'block';
            errorTip.style.opacity = '1';
            
            // 3秒后隐藏提示框
            setTimeout(() => {
                errorTip.style.opacity = '0';
                setTimeout(() => {
                    errorTip.style.display = 'none';
                }, 300);
            }, 3000);
        }

        // 跳转到下一个场景
        function nextScene(currentSceneId, nextSceneId) {
            // 隐藏当前场景
            const currentScene = document.getElementById(`scene-${currentSceneId}`);
            if (currentScene) {
                currentScene.classList.remove('active');
            }
            
            // 显示下一个场景
            setTimeout(() => {
                showScene(nextSceneId);
                
                // 预加载下一张可能的图片
                preloadNextImage(nextSceneId);
                
                // 更新URL但不刷新页面
                history.pushState(null, '', `?scene=${nextSceneId}`);
            }, 300);
        }

        // 预加载下一张可能的图片
        function preloadNextImage(currentSceneId) {
            let nextSceneId;
            switch (currentSceneId) {
                case '2101': nextSceneId = '2102'; break;
                case '2102': nextSceneId = '2103'; break;
                case '2103': nextSceneId = '2104'; break;
                case '2104': nextSceneId = '2201'; break;
                case '2201': nextSceneId = '2202'; break;
                case '2202': nextSceneId = '2203'; break;
                case '2203': nextSceneId = '2301'; break;
                case '2301': nextSceneId = '2302'; break;
                case '2302': nextSceneId = '2303'; break;
                case '2303': nextSceneId = '2304'; break;
                case '2304': nextSceneId = '2305'; break;
                case '2305': nextSceneId = '2401'; break;
                case '2401': nextSceneId = '2402'; break;
                case '2402': nextSceneId = '2403'; break;
                case '2403': nextSceneId = '2404'; break;
                case '2404': nextSceneId = '2405'; break;
                case '2405': nextSceneId = '2406'; break;
                case '2406': nextSceneId = '2407'; break;
                case '2407': nextSceneId = '2408'; break;
                case '2408': nextSceneId = '2409'; break;
                case '2409': nextSceneId = '2410'; break;
                default: return;
            }
            
            const img = new Image();
            img.src = `images/画面${nextSceneId.substring(1)}.jpg`;
        }

        // 计算并显示游戏结果
        function calculateAndDisplayResults() {
            // 计算用时（分钟）
            const endTime = new Date().getTime();
            const timeUsedMs = endTime - gameState.startTime;
            const timeUsedMin = Math.floor(timeUsedMs / 60000);
            const timeUsedSec = Math.floor((timeUsedMs % 60000) / 1000);
            
            // 计算时间分数（每分钟2分，不满1分钟1分）
            const timeScore = timeUsedMin * 2 + (timeUsedSec > 0 ? 1 : 0);
            
            // 计算总分数
            const totalScore = Math.max(0, gameState.score - timeScore);
            
            // 计算正确率
            const accuracy = (gameState.correctAnswers / 15 * 100).toFixed(1);
            
            // 显示结果
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('time-used').textContent = `${timeUsedMin}分${timeUsedSec}秒`;
            document.getElementById('total-score').textContent = totalScore.toFixed(1);
            
            // 清除游戏状态
            localStorage.removeItem('gameState');
        }
    </script>
</body>
</html>
