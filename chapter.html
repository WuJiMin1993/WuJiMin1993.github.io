<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语时态魔法棒 - 章节</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="game-container">
        <!-- 所有章节画面将通过JavaScript动态显示 -->
    </div>

    <script>
        // 游戏状态管理
        const gameState = {
            score: 0,
            correctAnswers: 0,
            startTime: null,
            endTime: null,
            // 记录每个按钮的点击状态，防止重复点击
            buttonStates: {}
        };

        // 所有章节数据
        const scenes = {
            // 章节1
            '2101': {
                image: 'images/画面01.jpg',
                text: '主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。',
                buttons: [
                    {
                        text: '打扫',
                        position: 'left',
                        correct: true,
                        nextScene: '2102',
                        feedback: ''
                    },
                    {
                        text: '正在打扫',
                        position: 'right',
                        correct: false,
                        nextScene: '2102',
                        feedback: '日常行为用一般现在时'
                    }
                ]
            },
            '2102': {
                image: 'images/画面02.jpg',
                text: '有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。',
                buttons: [
                    {
                        text: '锁上',
                        position: 'left',
                        correct: true,
                        nextScene: '2103',
                        feedback: ''
                    },
                    {
                        text: '正在锁上',
                        position: 'right',
                        correct: false,
                        nextScene: '2103',
                        feedback: '描述昨天发生的简单行为用一般过去时'
                    }
                ]
            },
            '2103': {
                image: 'images/画面03.jpg',
                text: 'Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着"时态魔法棒"。',
                buttons: [
                    {
                        text: '继续',
                        position: 'full',
                        correct: null,
                        nextScene: '2104',
                        feedback: ''
                    }
                ]
            },
            '2104': {
                image: 'images/画面04.jpg',
                text: 'Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。',
                buttons: [
                    {
                        text: '将去',
                        position: 'left',
                        correct: true,
                        nextScene: '2201',
                        feedback: ''
                    },
                    {
                        text: '已经去',
                        position: 'right',
                        correct: false,
                        nextScene: '2201',
                        feedback: '描述未来发生的简单行为用一般将来时'
                    }
                ]
            },
            // 章节2
            '2201': {
                image: 'images/画面05.jpg',
                text: '时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。',
                buttons: [
                    {
                        text: '正在骑',
                        position: 'left',
                        correct: true,
                        nextScene: '2202',
                        feedback: ''
                    },
                    {
                        text: '已经骑',
                        position: 'right',
                        correct: false,
                        nextScene: '2203',
                        feedback: '描述正在进行的行为用现在进行时'
                    }
                ]
            },
            '2202': {
                image: 'images/画面06.jpg',
                text: '昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。',
                buttons: [
                    {
                        text: '正在打扫',
                        position: 'left',
                        correct: true,
                        nextScene: '2203',
                        feedback: ''
                    },
                    {
                        text: '已经打扫',
                        position: 'right',
                        correct: false,
                        nextScene: '2202',
                        feedback: '描述过去正在进行的行为用过去进行时'
                    }
                ]
            },
            '2203': {
                image: 'images/画面07.jpg',
                text: '为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。',
                buttons: [
                    {
                        text: '打扫',
                        position: 'left',
                        correct: true,
                        nextScene: '2301',
                        feedback: ''
                    },
                    {
                        text: '已经打扫',
                        position: 'right',
                        correct: false,
                        nextScene: '2301',
                        feedback: '描述将来正在进行的行为用将来进行时'
                    }
                ]
            },
            // 章节3
            '2301': {
                image: 'images/画面08.jpg',
                text: 'Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫"时态"，难道启动它的咒语和时态有关？',
                buttons: [
                    {
                        text: '拿出',
                        position: 'left',
                        correct: true,
                        nextScene: '2302',
                        feedback: ''
                    },
                    {
                        text: '已经拿出',
                        position: 'right',
                        correct: false,
                        nextScene: '2302',
                        feedback: '描述日常行为一般现在时'
                    }
                ]
            },
            '2302': {
                image: 'images/画面09.jpg',
                text: '于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼已经被烤熟了【现在完成】"。',
                buttons: [
                    {
                        text: '已经被烤熟',
                        position: 'left',
                        correct: true,
                        nextScene: '2303',
                        feedback: ''
                    },
                    {
                        text: '将来被烤熟',
                        position: 'right',
                        correct: false,
                        nextScene: '2302',
                        feedback: '咒语未生效，请重新试'
                    }
                ]
            },
            '2303': {
                image: 'images/画面10.jpg',
                text: '只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。',
                buttons: [
                    {
                        text: '继续',
                        position: 'full',
                        correct: null,
                        nextScene: '2304',
                        feedback: ''
                    }
                ]
            },
            '2304': {
                image: 'images/画面11.jpg',
                text: 'Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。',
                buttons: [
                    {
                        text: '已经烤好的鱼',
                        position: 'left',
                        correct: true,
                        nextScene: '2305',
                        feedback: ''
                    },
                    {
                        text: '将要烤好',
                        position: 'right',
                        correct: false,
                        nextScene: '2305',
                        feedback: '描述已经完成的的行为用现在完成时'
                    }
                ]
            },
            '2305': {
                image: 'images/画面12.jpg',
                text: 'Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）',
                buttons: [
                    {
                        text: '将会被打败',
                        position: 'left',
                        correct: true,
                        nextScene: '2401',
                        feedback: ''
                    },
                    {
                        text: '已经被打败',
                        position: 'right',
                        correct: false,
                        nextScene: '2401',
                        feedback: '描述将来完成的的行为用将来完成时'
                    }
                ]
            },
            // 章节4
            '2401': {
                image: 'images/画面13.jpg',
                text: '虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。',
                buttons: [
                    {
                        text: '学习了',
                        position: 'left',
                        correct: true,
                        nextScene: '2402',
                        feedback: ''
                    },
                    {
                        text: '将学习',
                        position: 'right',
                        correct: false,
                        nextScene: '2402',
                        feedback: '描述过去的行为持续到现在用现在完成进行'
                    }
                ]
            },
            '2402': {
                image: 'images/画面14.jpg',
                text: 'Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"',
                buttons: [
                    {
                        text: '可以用',
                        position: 'left',
                        correct: true,
                        nextScene: '2403',
                        feedback: ''
                    },
                    {
                        text: '正在用',
                        position: 'right',
                        correct: false,
                        nextScene: '2403',
                        feedback: '描述正在进行的行为用现在进行时'
                    }
                ]
            },
            '2403': {
                image: 'images/画面15.jpg',
                text: '今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"',
                buttons: [
                    {
                        text: '输给',
                        position: 'left',
                        correct: true,
                        nextScene: '2404',
                        feedback: ''
                    },
                    {
                        text: '将输给',
                        position: 'right',
                        correct: false,
                        nextScene: '2404',
                        feedback: '描述正在进行的行为用现在进行时'
                    }
                ]
            },
            '2404': {
                image: 'images/画面16.jpg',
                text: '只见Tom用魔法棒指向天空，用咒语说了一句："It\'s going to rain soon"，魔法棒发出来蓝光。',
                buttons: [
                    {
                        text: '继续',
                        position: 'full',
                        correct: null,
                        nextScene: '2405',
                        feedback: ''
                    }
                ]
            },
            '2405': {
                image: 'images/画面17.jpg',
                text: '果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。',
                buttons: [
                    {
                        text: '继续',
                        position: 'full',
                        correct: null,
                        nextScene: '2406',
                        feedback: ''
                    }
                ]
            },
            '2406': {
                image: 'images/画面18.jpg',
                text: 'Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"',
                buttons: [
                    {
                        text: '已经学了',
                        position: 'left',
                        correct: true,
                        nextScene: '2407',
                        feedback: ''
                    },
                    {
                        text: '将要学',
                        position: 'right',
                        correct: false,
                        nextScene: '2407',
                        feedback: '描述将来完成进行时'
                    }
                ]
            },
            '2407': {
                image: 'images/画面19.jpg',
                text: 'Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。',
                buttons: [
                    {
                        text: '继续',
                        position: 'full',
                        correct: null,
                        nextScene: '2408',
                        feedback: ''
                    }
                ]
            },
            '2408': {
                image: 'images/画面20.jpg',
                text: '馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。',
                buttons: [
                    {
                        text: '找了',
                        position: 'left',
                        correct: true,
                        nextScene: '2409',
                        feedback: ''
                    },
                    {
                        text: '将找',
                        position: 'right',
                        correct: false,
                        nextScene: '2409',
                        feedback: '描述过去完成'
                    }
                ]
            },
            '2409': {
                image: 'images/画面21.jpg',
                text: 'Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....',
                buttons: [
                    {
                        text: '继续',
                        position: 'full',
                        correct: null,
                        nextScene: '2410',
                        feedback: ''
                    }
                ]
            },
            // 结束画面
            '2410': {
                image: '',
                text: '',
                buttons: []
            }
        };

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', function() {
            // 从URL获取当前场景ID
            const currentSceneId = window.location.hash.substring(1) || '2101';
            
            // 初始化游戏状态
            if (!gameState.startTime) {
                gameState.startTime = new Date();
            }
            
            // 加载当前场景
            loadScene(currentSceneId);
            
            // 预加载下一场景的图片
            preloadNextImages(currentSceneId);
        });

        // 加载场景函数
        function loadScene(sceneId) {
            const scene = scenes[sceneId];
            const gameContainer = document.getElementById('game-container');
            
            // 如果是结束画面
            if (sceneId === '2410') {
                showResultScreen();
                return;
            }
            
            // 创建场景HTML
            let sceneHTML = `
                <div id="scene-${sceneId}" class="screen active">
                    <div class="image-container">
                        <img src="${scene.image}" alt="场景${sceneId}" class="game-image">
                    </div>
                    <div class="text-container">
                        <p>${scene.text}</p>
                    </div>
                    <div class="button-container">
            `;
            
            // 添加按钮
            scene.buttons.forEach((button, index) => {
                const buttonId = `button-${sceneId}-${index}`;
                const positionClass = button.position === 'full' ? 'full-button' : `${button.position}-button`;
                
                sceneHTML += `
                    <button id="${buttonId}" class="game-button ${positionClass}" 
                            data-correct="${button.correct}" 
                            data-next="${button.nextScene}" 
                            data-feedback="${button.feedback}">
                        ${button.text}
                    </button>
                `;
            });
            
            sceneHTML += `</div></div>`;
            
            // 添加到游戏容器
            gameContainer.innerHTML = sceneHTML;
            
            // 添加按钮点击事件
            scene.buttons.forEach((button, index) => {
                const buttonId = `button-${sceneId}-${index}`;
                document.getElementById(buttonId).addEventListener('click', function() {
                    handleButtonClick(this);
                });
            });
            
            // 添加淡入效果
            setTimeout(() => {
                const sceneElement = document.getElementById(`scene-${sceneId}`);
                if (sceneElement) {
                    sceneElement.classList.add('fade-in');
                }
            }, 50);
        }

        // 处理按钮点击
        function handleButtonClick(button) {
            const sceneId = window.location.hash.substring(1);
            const buttonId = button.id;
            
            // 防止重复点击
            if (gameState.buttonStates[buttonId]) {
                return;
            }
            gameState.buttonStates[buttonId] = true;
            
            // 禁用所有按钮
            const buttons = document.querySelectorAll('.game-button');
            buttons.forEach(btn => {
                btn.disabled = true;
            });
            
            // 如果是正确答案，增加分数
            const isCorrect = button.getAttribute('data-correct') === 'true';
            if (isCorrect) {
                gameState.score += 6.7;
                gameState.correctAnswers++;
            }
            
            // 显示反馈信息（如果有）
            const feedback = button.getAttribute('data-feedback');
            if (feedback) {
                showFeedback(feedback);
            }
            
            // 获取下一个场景ID
            const nextSceneId = button.getAttribute('data-next');
            
            // 延迟跳转到下一个场景
            setTimeout(() => {
                // 更新URL哈希
                window.location.hash = nextSceneId;
                
                // 加载下一个场景
                loadScene(nextSceneId);
                
                // 预加载后续图片
                preloadNextImages(nextSceneId);
            }, feedback ? 3000 : 500);
        }

        // 显示反馈信息
        function showFeedback(message) {
            const feedbackElement = document.createElement('div');
            feedbackElement.className = 'feedback-box';
            feedbackElement.textContent = message;
            
            document.getElementById('game-container').appendChild(feedbackElement);
            
            // 3秒后移除反馈框
            setTimeout(() => {
                feedbackElement.remove();
            }, 3000);
        }

        // 预加载图片
        function preloadImages(imageUrls) {
            imageUrls.forEach(url => {
                const img = new Image();
                img.src = url;
            });
        }

        // 预加载下一场景的图片
        function preloadNextImages(currentSceneId) {
            const currentScene = scenes[currentSceneId];
            if (!currentScene) return;
            
            // 预加载当前场景的图片（确保已加载）
            if (currentScene.image) {
                preloadImages([currentScene.image]);
            }
            
            // 预加载下一场景的图片
            const nextSceneIds = [];
            currentScene.buttons.forEach(button => {
                if (!nextSceneIds.includes(button.nextScene)) {
                    nextSceneIds.push(button.nextScene);
                }
            });
            
            // 最多预加载2个后续场景的图片
            let preloadCount = 0;
            for (let i = 0; i < nextSceneIds.length && preloadCount < 2; i++) {
                const nextScene = scenes[nextSceneIds[i]];
                if (nextScene && nextScene.image) {
                    preloadImages([nextScene.image]);
                    preloadCount++;
                    
                    // 如果这个场景有多个可能的下一场景，继续预加载
                    nextScene.buttons.forEach(button => {
                        if (preloadCount < 2 && scenes[button.nextScene] && scenes[button.nextScene].image) {
                            preloadImages([scenes[button.nextScene].image]);
                            preloadCount++;
                        }
                    });
                }
            }
        }

        // 显示结果画面
        function showResultScreen() {
            // 记录结束时间
            gameState.endTime = new Date();
            
            // 计算用时（秒）
            const timeSpent = (gameState.endTime - gameState.startTime) / 1000;
            const minutes = Math.floor(timeSpent / 60);
            const seconds = Math.floor(timeSpent % 60);
            
            // 计算时间分数（每分钟2分，不满1分钟按1分计算）
            const timeScore = minutes * 2 + (seconds > 0 ? 1 : 0);
            
            // 计算总分数
            const totalScore = Math.max(0, gameState.score - timeScore);
            
            // 计算正确率（保留1位小数）
            const accuracy = (gameState.correctAnswers / 15 * 100).toFixed(1);
            
            // 创建结果HTML
            const resultHTML = `
                <div id="result-screen" class="screen active">
                    <div class="result-container">
                        <h1>游戏结束</h1>
                        <div class="result-item">
                            <span class="result-label">正确率:</span>
                            <span class="result-value">${accuracy}%</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">用时:</span>
                            <span class="result-value">${minutes}分${seconds}秒</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">总得分:</span>
                            <span class="result-value">${totalScore.toFixed(1)}</span>
                        </div>
                        <button id="restart-button" class="main-button">重新开始</button>
                    </div>
                </div>
            `;
            
            // 添加到游戏容器
            document.getElementById('game-container').innerHTML = resultHTML;
            
            // 添加重新开始按钮事件
            document.getElementById('restart-button').addEventListener('click', function() {
                window.location.href = 'index.html';
            });
            
            // 添加淡入效果
            setTimeout(() => {
                const resultElement = document.getElementById('result-screen');
                if (resultElement) {
                    resultElement.classList.add('fade-in');
                }
            }, 50);
        }
    </script>
</body>
</html>
