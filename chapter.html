<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态学习游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- 游戏主容器 -->
    <div id="game-container">
        <!-- 图片显示区域 -->
        <div id="image-container">
            <img id="current-image" src="" alt="游戏画面" class="fade-in">
        </div>
        
        <!-- 文字显示区域 -->
        <div id="text-container">
            <p id="game-text"></p>
        </div>
        
        <!-- 按钮区域 -->
        <div id="button-container">
            <!-- 按钮将通过JavaScript动态生成 -->
        </div>
    </div>
    
    <!-- 提示信息框 -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="message-text"></p>
        </div>
    </div>
    
    <!-- 游戏结束统计界面 -->
    <div id="stats-screen" class="screen">
        <div class="stats-container">
            <h2>游戏结束</h2>
            <div class="stat-item">
                <span class="stat-label">正确率:</span>
                <span id="accuracy" class="stat-value">0%</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">用时:</span>
                <span id="time-used" class="stat-value">0分0秒</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">总得分:</span>
                <span id="total-score" class="stat-value">0</span>
            </div>
            <button id="return-btn" class="game-btn">返回首页</button>
        </div>
    </div>

    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const isCreator = urlParams.get('creator') === 'true';
        
        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const currentImage = document.getElementById('current-image');
        const gameText = document.getElementById('game-text');
        const buttonContainer = document.getElementById('button-container');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const statsScreen = document.getElementById('stats-screen');
        const accuracyDisplay = document.getElementById('accuracy');
        const timeUsedDisplay = document.getElementById('time-used');
        const totalScoreDisplay = document.getElementById('total-score');
        const returnBtn = document.getElementById('return-btn');
        
        // 游戏状态
        let gameState = {
            currentPageId: null,
            score: 0,
            correctAnswers: 0,
            startTime: null,
            endTime: null,
            clickedButtons: new Set() // 用于记录已点击的按钮
        };
        
        // 游戏页面数据
        const gamePages = {
            // 章节1
            '2101': {
                image: 'images/画面01.jpg',
                text: '主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。',
                buttons: [
                    { text: '打扫', position: 'left', correct: true, nextPage: '2102' },
                    { text: '正在打扫', position: 'right', correct: false, 
                      message: '日常行为用一般现在时', nextPage: '2102' }
                ]
            },
            '2102': {
                image: 'images/画面02.jpg',
                text: '有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。',
                buttons: [
                    { text: '锁上', position: 'left', correct: true, nextPage: '2103' },
                    { text: '正在锁上', position: 'right', correct: false, 
                      message: '描述昨天发生的简单行为用一般过去时', nextPage: '2103' }
                ]
            },
            '2103': {
                image: 'images/画面03.jpg',
                text: 'Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着"时态魔法棒"。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2104' }
                ]
            },
            '2104': {
                image: 'images/画面04.jpg',
                text: 'Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。',
                buttons: [
                    { text: '将去', position: 'left', correct: true, nextPage: '2201' },
                    { text: '已经去', position: 'right', correct: false, 
                      message: '描述未来发生的简单行为用一般将来时', nextPage: '2201' }
                ]
            },
            // 章节2
            '2201': {
                image: 'images/画面05.jpg',
                text: '时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。',
                buttons: [
                    { text: '正在骑', position: 'left', correct: true, nextPage: '2202' },
                    { text: '已经骑', position: 'right', correct: false, 
                      message: '描述正在进行的行为用现在进行时', nextPage: '2202' }
                ]
            },
            '2202': {
                image: 'images/画面06.jpg',
                text: '昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。',
                buttons: [
                    { text: '正在打扫', position: 'left', correct: true, nextPage: '2203' },
                    { text: '已经打扫', position: 'right', correct: false, 
                      message: '描述过去正在进行的行为用过去进行时', nextPage: '2203' }
                ]
            },
            '2203': {
                image: 'images/画面07.jpg',
                text: '为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。',
                buttons: [
                    { text: '打扫', position: 'left', correct: true, nextPage: '2301' },
                    { text: '已经打扫', position: 'right', correct: false, 
                      message: '描述将来正在进行的行为用将来进行时', nextPage: '2301' }
                ]
            },
            // 章节3
            '2301': {
                image: 'images/画面08.jpg',
                text: 'Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫"时态"，难道启动它的咒语和时态有关？',
                buttons: [
                    { text: '拿出', position: 'left', correct: true, nextPage: '2302' },
                    { text: '已经拿出', position: 'right', correct: false, 
                      message: '描述日常行为一般现在时', nextPage: '2302' }
                ]
            },
            '2302': {
                image: 'images/画面09.jpg',
                text: '于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼____了【现在完成】"',
                buttons: [
                    { text: '已经被烤熟', position: 'left', correct: true, nextPage: '2303' },
                    { text: '将来被烤熟', position: 'right', correct: false, 
                      message: '咒语未生效，Tom重新念了一条香喷喷的鱼已经被烤熟了', nextPage: '2303' }
                ]
            },
            '2303': {
                image: 'images/画面10.jpg',
                text: '只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2304' }
                ]
            },
            '2304': {
                image: 'images/画面11.jpg',
                text: 'Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。',
                buttons: [
                    { text: '已经烤好的鱼', position: 'left', correct: true, nextPage: '2305' },
                    { text: '将要烤好', position: 'right', correct: false, 
                      message: '描述已经完成的的行为用现在完成时', nextPage: '2305' }
                ]
            },
            '2305': {
                image: 'images/画面12.jpg',
                text: 'Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）',
                buttons: [
                    { text: '将会被打败', position: 'left', correct: true, nextPage: '2401' },
                    { text: '已经被打败', position: 'right', correct: false, 
                      message: '描述将来完成的的行为用将来完成时', nextPage: '2401' }
                ]
            },
            // 章节4
            '2401': {
                image: 'images/画面13.jpg',
                text: '虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。',
                buttons: [
                    { text: '学习了', position: 'left', correct: true, nextPage: '2402' },
                    { text: '将学习', position: 'right', correct: false, 
                      message: '描述过去的行为持续到现在用现在完成进行', nextPage: '2402' }
                ]
            },
            '2402': {
                image: 'images/画面14.jpg',
                text: 'Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"',
                buttons: [
                    { text: '可以用', position: 'left', correct: true, nextPage: '2403' },
                    { text: '正在用', position: 'right', correct: false, 
                      message: '描述正在进行的行为用现在进行时', nextPage: '2403' }
                ]
            },
            '2403': {
                image: 'images/画面15.jpg',
                text: '今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"',
                buttons: [
                    { text: '输给', position: 'left', correct: true, nextPage: '2404' },
                    { text: '将输给', position: 'right', correct: false, 
                      message: '描述正在进行的行为用现在进行时', nextPage: '2404' }
                ]
            },
            '2404': {
                image: 'images/画面16.jpg',
                text: '只见Tom用魔法棒指向天空，用咒语说了一句："It\'s going to rain soon"，魔法棒发出来蓝光。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2405' }
                ]
            },
            '2405': {
                image: 'images/画面17.jpg',
                text: '果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2406' }
                ]
            },
            '2406': {
                image: 'images/画面18.jpg',
                text: 'Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"',
                buttons: [
                    { text: '已经学了', position: 'left', correct: true, nextPage: '2407' },
                    { text: '将要学', position: 'right', correct: false, 
                      message: '描述将来完成进行时', nextPage: '2407' }
                ]
            },
            '2407': {
                image: 'images/画面19.jpg',
                text: 'Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2408' }
                ]
            },
            '2408': {
                image: 'images/画面20.jpg',
                text: '馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。',
                buttons: [
                    { text: '找了', position: 'left', correct: true, nextPage: '2409' },
                    { text: '将找', position: 'right', correct: false, 
                      message: '描述过去完成', nextPage: '2409' }
                ]
            },
            '2409': {
                image: 'images/画面21.jpg',
                text: 'Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....',
                buttons: [
                    { text: '游戏结束', position: 'center', correct: null, nextPage: 'stats' }
                ]
            }
        };
        
        // 显示提示信息
        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, duration);
            }
        }
        
        // 预加载图片
        function preloadImage(imageUrl) {
            const img = new Image();
            img.src = imageUrl;
        }
        
        // 加载游戏页面
        function loadPage(pageId) {
            // 如果是第一次加载页面，记录开始时间
            if (!gameState.startTime) {
                gameState.startTime = new Date();
            }
            
            // 更新当前页面ID
            gameState.currentPageId = pageId;
            
            // 重置已点击按钮记录
            gameState.clickedButtons.clear();
            
            // 如果是统计页面
            if (pageId === 'stats') {
                showStats();
                return;
            }
            
            // 获取页面数据
            const page = gamePages[pageId];
            if (!page) {
                console.error('无效的页面ID:', pageId);
                return;
            }
            
            // 更新图片和文字
            currentImage.src = page.image;
            gameText.textContent = page.text;
            
            // 预加载下一张可能的图片
            if (page.buttons && page.buttons.length > 0) {
                const nextPageId = page.buttons[0].nextPage;
                if (nextPageId && nextPageId !== 'stats') {
                    const nextPage = gamePages[nextPageId];
                    if (nextPage) {
                        preloadImage(nextPage.image);
                    }
                }
            }
            
            // 清除现有按钮
            buttonContainer.innerHTML = '';
            
            // 创建新按钮
            page.buttons.forEach((button, index) => {
                const btn = document.createElement('button');
                btn.textContent = button.text;
                btn.className = 'game-btn';
                
                // 设置按钮位置类
                if (button.position === 'left') {
                    btn.classList.add('left-btn');
                } else if (button.position === 'right') {
                    btn.classList.add('right-btn');
                } else {
                    btn.classList.add('center-btn');
                }
                
                // 按钮点击事件
                btn.addEventListener('click', () => {
                    // 防止重复点击
                    if (gameState.clickedButtons.has(index)) return;
                    gameState.clickedButtons.add(index);
                    
                    // 如果是正确答案，增加分数
                    if (button.correct === true) {
                        gameState.score += 6.7;
                        gameState.correctAnswers++;
                    }
                    
                    // 显示提示信息（如果有）
                    if (button.message) {
                        showMessage(button.message);
                    }
                    
                    // 延迟跳转到下一页，确保用户看到提示信息
                    setTimeout(() => {
                        loadPage(button.nextPage);
                    }, button.message ? 3000 : 0);
                });
                
                buttonContainer.appendChild(btn);
            });
        }
        
        // 显示游戏统计
        function showStats() {
            // 记录结束时间
            gameState.endTime = new Date();
            
            // 计算用时（毫秒）
            const timeUsedMs = gameState.endTime - gameState.startTime;
            const minutes = Math.floor(timeUsedMs / 60000);
            const seconds = Math.floor((timeUsedMs % 60000) / 1000);
            
            // 计算时间分数（每分钟2分，不足1分钟1分）
            const timeScore = minutes * 2 + (seconds > 0 ? 1 : 0);
            
            // 计算总分数
            const totalScore = Math.floor(gameState.score) + timeScore;
            
            // 计算正确率
            const accuracy = (gameState.correctAnswers / 15 * 100).toFixed(1);
            
            // 更新显示
            accuracyDisplay.textContent = `${accuracy}%`;
            timeUsedDisplay.textContent = `${minutes}分${seconds}秒`;
            totalScoreDisplay.textContent = totalScore;
            
            // 显示统计页面
            gameContainer.style.display = 'none';
            statsScreen.style.display = 'flex';
            
            // 如果是房间创建者，更新Firebase中的房间状态
            if (isCreator && roomId) {
                database.ref('rooms/' + roomId).update({
                    status: 'completed',
                    score: totalScore,
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                });
            }
        }
        
        // 返回首页按钮事件
        returnBtn.addEventListener('click', () => {
            window.location.href = 'index.html';
        });
        
        // 初始化游戏
        function initGame() {
            // 隐藏统计页面
            statsScreen.style.display = 'none';
            
            // 隐藏消息框
            messageModal.style.display = 'none';
            
            // 如果是通过房间进入，检查房间状态
            if (roomId) {
                if (isCreator) {
                    // 创建者直接开始游戏
                    loadPage('2101');
                } else {
                    // 加入者等待创建者开始
                    database.ref('rooms/' + roomId).on('value', (snapshot) => {
                        const roomData = snapshot.val();
                        if (!roomData) {
                            showMessage('房间已关闭', 3000);
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 3000);
                        } else if (roomData.status === 'completed') {
                            showMessage('游戏已结束', 3000);
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 3000);
                        } else {
                            // 房间存在且未结束，开始游戏
                            loadPage('2101');
                        }
                    });
                }
            } else {
                // 没有房间号，直接开始游戏（调试用）
                loadPage('2101');
            }
        }
        
        // 页面加载完成后初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
