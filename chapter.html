<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法游戏 - 游戏进行中</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- 所有游戏画面容器 -->
    <div id="game-container">
        <!-- 章节1 -->
        <!-- 画面01 (页面ID:2101) -->
        <div id="page-2101" class="game-page">
            <img src="images/画面01.jpg" alt="画面01" class="game-image">
            <div class="text-container">
                <p>Tom lives in a magical world and ____ the school library every day.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2102" class="game-button">cleans</button>
                <button data-correct="false" data-next="2102" data-hint="Daily behavior is expressed in the present tense" class="game-button">cleaning</button>
            </div>
        </div>

        <!-- 画面02 (页面ID:2102) -->
        <div id="page-2102" class="game-page">
            <img src="images/画面02.jpg" alt="画面02" class="game-image">
            <div class="text-container">
                <p>Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2103" class="game-button">locked</button>
                <button data-correct="false" data-next="2103" data-hint="Describe the simple behavior that occurred yesterday in the past simple tense" class="game-button">locks</button>
            </div>
        </div>

        <!-- 画面03 (页面ID:2103) -->
        <div id="page-2103" class="game-page">
            <img src="images/画面03.jpg" alt="画面03" class="game-image">
            <div class="text-container">
                <p>Tom walked over curiously and saw a magic wand with a flashing blue light, with a label next to it that read: Tense Magic wand.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2104" class="game-button">continue</button>
            </div>
        </div>

        <!-- 画面04 (页面ID:2104) -->
        <div id="page-2104" class="game-page">
            <img src="images/画面04.jpg" alt="画面04" class="game-image">
            <div class="text-container">
                <p>Tom became curious and hid his magic wand in his clothes before taking it away from the library He ____ outdoors tomorrow to test the power of the magic wand.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2201" class="game-button">will go</button>
                <button data-correct="false" data-next="2201" data-hint="Describe simple behaviors that will occur in the future using general future tense" class="game-button">is going</button>
            </div>
        </div>

        <!-- 章节2 -->
        <!-- 画面05 (页面ID:2201) -->
        <div id="page-2201" class="game-page">
            <img src="images/画面05.jpg" alt="画面05" class="game-image">
            <div class="text-container">
                <p>The next morning, he ____ a magic broom towards a forest next to the school.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2202" class="game-button">is riding</button>
                <button data-correct="false" data-next="2202" data-hint="Describe the ongoing behavior in present continuous tense" class="game-button">has ridden</button>
            </div>
        </div>

        <!-- 画面06 (页面ID:2202) -->
        <div id="page-2202" class="game-page">
            <img src="images/画面06.jpg" alt="画面06" class="game-image">
            <div class="text-container">
                <p>At this time yesterday, Tom was cleaning the library. He was supposed to be organizing books in the library today, but he thought this magic wand would be fun. So I decided to slack off and not go to the library anymore.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2203" class="game-button">was cleaning</button>
                <button data-correct="false" data-next="2203" data-hint="描述过去正在进行的行为用过去进行时" class="game-button">is cleaning</button>
            </div>
        </div>

        <!-- 画面07 (页面ID:2203) -->
        <div id="page-2203" class="game-page">
            <img src="images/画面07.jpg" alt="画面07" class="game-image">
            <div class="text-container">
                <p>Tom will be tidying up the library early tomorrow to prevent library director Jimmy from discovering his laziness.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2301" class="game-button">will be tidying up</button>
                <button data-correct="false" data-next="2301" data-hint="Describe the ongoing behavior in the future using future continuous tense" class="game-button">is tidying up</button>
            </div>
        </div>

        <!-- 章节3 -->
        <!-- 画面08 (页面ID:2301) -->
        <div id="page-2301" class="game-page">
            <img src="images/画面08.jpg" alt="画面08" class="game-image">
            <div class="text-container">
                <p>Tom stops by the stream in the forest and ____ the magic wand from his clothes. He thought that the magic wand is called a tense magic wand. Is the spell that activates it related to tense?</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2302" class="game-button">takes out</button>
                <button data-correct="false" data-next="2302" data-hint="Describe daily behavior in the present tense" class="game-button">will take out</button>
            </div>
        </div>

        <!-- 画面09 (页面ID:2302) -->
        <div id="page-2302" class="game-page">
            <img src="images/画面09.jpg" alt="画面09" class="game-image">
            <div class="text-container">
                <p>So he decided to try combining the spells he learned at the magic school. Tom pointed his magic wand at the stream and said, 'A delicious fish ____.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2304" class="game-button">has been grilled</button>
                <button data-correct="false" data-next="2304" data-hint="The spell didn't take effect, Tom recited a delicious fish that had already been grilled" class="game-button">will be grilled</button>
            </div>
        </div>

        <!-- 画面10 (页面ID:2303) -->
        <div id="page-2303" class="game-page">
            <img src="images/画面10.jpg" alt="画面10" class="game-image">
            <div class="text-container">
                <p>After reciting the spell, a sudden blue flash appeared. Then a grill made of tree branches appeared in front of Tom, with a fragrant grilled fish on top.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2304" class="game-button">Continue</button>
            </div>
        </div>

        <!-- 画面11 (页面ID:2304) -->
        <div id="page-2304" class="game-page">
            <img src="images/画面11.jpg" alt="画面11" class="game-image">
            <div class="text-container">
                <p>Tom hadn't had breakfast before coming here, and his stomach was growling. Tom ____ the grilled fish and begins eating.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2305" class="game-button">has taken</button>
                <button data-correct="false" data-next="2305" data-hint="Describe completed actions in present perfect tense" class="game-button">will take</button>
            </div>
        </div>

        <!-- 画面12 (页面ID:2305) -->
        <div id="page-2305" class="game-page">
            <img src="images/画面12.jpg" alt="画面12" class="game-image">
            <div class="text-container">
                <p>Tom thinks that now he has the powerful wand.And the wizard who always bullies me ____ by him.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2401" class="game-button">will have been defeated</button>
                <button data-correct="false" data-next="2401" data-hint="Describe the behavior to be completed in the future using the future perfect tense" class="game-button">has been defeated</button>
            </div>
        </div>

        <!-- 章节4 -->
        <!-- 画面13 (页面ID:2401) -->
        <div id="page-2401" class="game-page">
            <img src="images/画面13.jpg" alt="画面13" class="game-image">
            <div class="text-container">
                <p>Although Tom ____ magic at the school for a year, his knowledge of magic is still inferior to that of wizard Mike.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2402" class="game-button">has been studying</button>
                <button data-correct="false" data-next="2402" data-hint="The action has been ongoing from the past to the present, and may have just ended or is still ongoing, using the present to complete the ongoing tense" class="game-button">will studying</button>
            </div>
        </div>

        <!-- 画面14 (页面ID:2402) -->
        <div id="page-2402" class="game-page">
            <img src="images/画面14.jpg" alt="画面14" class="game-image">
            <div class="text-container">
                <p>So Tom came to the house of the wizard Mike who used to tease him. Tom shouted at Mike, 'I ____ magic to defeat you. Come out and accept my challenge.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2403" class="game-button">will use</button>
                <button data-correct="false" data-next="2403" data-hint="Describe future actions using future continuous tense" class="game-button">am using</button>
            </div>
        </div>

        <!-- 画面15 (页面ID:2403) -->
        <div id="page-2403" class="game-page">
            <img src="images/画面15.jpg" alt="画面15" class="game-image">
            <div class="text-container">
                <p>Mike walked out of the room and said, 'Tom, you ____ to me over the past year. Are you still not willing to give up?'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2404" class="game-button">had been repeatedly losing</button>
                <button data-correct="false" data-next="2404" data-hint="A certain past action started earlier in the past and continued until a certain point in time, possibly still continuing or just stopped" class="game-button">was losing</button>
            </div>
        </div>

        <!-- 画面16 (页面ID:2404) -->
        <div id="page-2404" class="game-page">
            <img src="images/画面16.jpg" alt="画面16" class="game-image">
            <div class="text-container">
                <p>Tom pointed his magic wand at the sky and cursed 'It's going to rain soon,' and the wand emitted blue light.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2405" class="game-button">Continue</button>
            </div>
        </div>

        <!-- 画面17 (页面ID:2405) -->
        <div id="page-2405" class="game-page">
            <img src="images/画面17.jpg" alt="画面17" class="game-image">
            <div class="text-container">
                <p>Before long, dark clouds appeared in the sky, thunder started to strike, and raindrops began to fall.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2406" class="game-button">Continue</button>
            </div>
        </div>

        <!-- 画面18 (页面ID:2406) -->
        <div id="page-2406" class="game-page">
            <img src="images/画面18.jpg" alt="画面18" class="game-image">
            <div class="text-container">
                <p>By tomorrow, Mike ____ magic for 2 years now. But Mike was still stunned when he saw Tom's magic. Mike had never seen such a powerful magic before and said to Tom, 'I admit you're already better than me.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2407" class="game-button">will have been studying</button>
                <button data-correct="false" data-next="2407" data-hint="Emphasize how long a certain action has been ongoing until a certain point in the future, using the future completion continuous time" class="game-button">will be studying</button>
            </div>
        </div>

        <!-- 画面19 (页面ID:2407) -->
        <div id="page-2407" class="game-page">
            <img src="images/画面19.jpg" alt="画面19" class="game-image">
            <div class="text-container">
                <p>Tom wants to show off the power of his magic wand again and is ready to recite the next spell. But suddenly a beam of light flashed and the library director Jimmy appeared in front of him.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2408" class="game-button">Continue</button>
            </div>
        </div>

        <!-- 画面20 (页面ID:2408) -->
        <div id="page-2408" class="game-page">
            <img src="images/画面20.jpg" alt="画面20" class="game-image">
            <div class="text-container">
                <p>Library director Jimmy said to Tom, 'I ____ for it all day, but you took it away.'.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2409" class="game-button">have been looking</button>
                <button data-correct="false" data-next="2409" data-hint="Describe actions that have been completed in the past and use them to complete them" class="game-button">am looking</button>
            </div>
        </div>

        <!-- 画面21 (页面ID:2409) -->
        <div id="page-2409" class="game-page">
            <img src="images/画面21.jpg" alt="画面21" class="game-image">
            <div class="text-container">
                <p>Jimmy raised his hand, and the magic wand automatically flew into Jimmy's hand. Then Jimmy shouted at Tom, 'Hurry back and clean the library for me.'</p>
            </div>
            <div class="button-container single-button">
                <button id="game-over-btn" class="game-button">Game over</button>
            </div>
        </div>
    </div>

    <!-- 排名画面22 (页面ID:2501) -->
    <div id="page-2501" class="game-page">
        <div class="room-info">
            <h2>房间号: <span id="room-number-display"></span></h2>
            <p>当前玩家人数: <span id="player-count">0</span></p>
        </div>
        <div class="leaderboard-container">
            <table id="leaderboard">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>名称</th>
                        <th>总分数</th>
                        <th>正确率</th>
                        <th>用时</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 排行榜内容将通过JavaScript动态生成 -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- 提示框 -->
    <div id="hint-modal" class="modal">
        <div class="modal-content">
            <p id="hint-message"></p>
        </div>
    </div>

    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const roomNumber = urlParams.get('room');
        const playerId = urlParams.get('player');
        const nickname = decodeURIComponent(urlParams.get('nickname') || '');

        // 游戏状态变量
        let isTeacher = playerId === 'teacher';
        let currentPage = isTeacher ? '2501' : '2101'; // 老师直接看排名，玩家从第一页开始
        let correctAnswers = 0;
        let startTime = null;
        let gameCompleted = false;
        let clickedButtons = new Set(); // 记录已点击的按钮，防止重复点击

        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const hintModal = document.getElementById('hint-modal');
        const hintMessage = document.getElementById('hint-message');
        const gameOverBtn = document.getElementById('game-over-btn');
        const roomNumberDisplay = document.getElementById('room-number-display');
        const playerCountDisplay = document.getElementById('player-count');
        const leaderboardTable = document.getElementById('leaderboard').querySelector('tbody');

        // 显示提示框
        function showHint(message, duration = 3000) {
            hintMessage.textContent = message;
            hintModal.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    hintModal.style.display = 'none';
                }, duration);
            }
        }

        // 切换页面
        function switchPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.game-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
                
                // 如果是排名页面，更新排行榜
                if (pageId === '2501') {
                    updateLeaderboard();
                }
                
                // 更新当前页面
                currentPage = pageId;
                
                // 更新进度
                updateProgress();
                
                // 预加载下一张可能的图片
                preloadNextImage(pageId);
            }
        }

        // 更新玩家进度
        function updateProgress() {
            if (isTeacher || gameCompleted) return;
            
            // 计算进度 (当前页数/21)
            const pageNum = parseInt(currentPage.substring(1));
            const progress = Math.round((pageNum / 21) * 100);
            
            // 更新数据库中的进度
            database.ref(`rooms/${roomNumber}/players/${playerId}/progress`).set(progress);
        }

        // 计算并更新分数
        function updateScore(isCorrect) {
            if (isTeacher || gameCompleted) return;
            
            // 每答对一题得6.7分
            if (isCorrect) {
                correctAnswers++;
                const score = Math.min(correctAnswers * 6.7, 100);
                database.ref(`rooms/${roomNumber}/players/${playerId}/score`).set(Math.round(score));
                database.ref(`rooms/${roomNumber}/players/${playerId}/correctAnswers`).set(correctAnswers);
            }
        }

        // 计算用时分数
        function calculateTimeScore() {
            if (!startTime) return 1;
            
            const timeSpent = (Date.now() - startTime) / 1000 / 60; // 分钟
            return Math.max(1, Math.floor(timeSpent)) * 2; // 每分钟2分
        }

        // 游戏结束
        function endGame() {
            if (isTeacher || gameCompleted) return;
            
            gameCompleted = true;
            
            // 计算总分数
            const timeScore = calculateTimeScore();
            const totalScore = Math.min(Math.round(correctAnswers * 6.7 - timeScore), 100);
            
            // 计算正确率
            const accuracy = ((correctAnswers / 15) * 100).toFixed(1);
            
            // 计算用时（分钟）
            const timeSpent = Math.round((Date.now() - startTime) / 1000 / 60);
            
            // 更新数据库
            database.ref(`rooms/${roomNumber}/players/${playerId}`).update({
                gameCompleted: true,
                score: totalScore,
                accuracy: accuracy,
                timeSpent: timeSpent
            });
            
            // 跳转到排名页面
            switchPage('2501');
        }

        // 更新排行榜
        function updateLeaderboard() {
            if (!roomNumber) return;
            
            // 显示房间号
            roomNumberDisplay.textContent = roomNumber;
            
            // 监听房间玩家数据变化
            database.ref(`rooms/${roomNumber}/players`).on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const playerList = [];
                
                // 转换玩家数据为数组
                for (const [id, data] of Object.entries(players)) {
                    if (id === 'teacher') continue; // 跳过老师
                    
                    playerList.push({
                        id: id,
                        nickname: data.nickname || 'Anonymous',
                        score: data.score || 0,
                        accuracy: data.accuracy || '0.0',
                        timeSpent: data.timeSpent || 0,
                        gameCompleted: data.gameCompleted || false
                    });
                }
                
                // 更新玩家人数
                playerCountDisplay.textContent = playerList.length;
                
                // 按分数排序
                playerList.sort((a, b) => b.score - a.score);
                
                // 只显示前10名
                const topPlayers = playerList.slice(0, 10);
                
                // 清空排行榜
                leaderboardTable.innerHTML = '';
                
                // 填充排行榜
                topPlayers.forEach((player, index) => {
                    const row = document.createElement('tr');
                    
                    // 高亮显示当前玩家
                    if (player.id === playerId) {
                        row.classList.add('highlight');
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.nickname}</td>
                        <td>${player.score}</td>
                        <td>${player.accuracy}%</td>
                        <td>${player.timeSpent}分钟</td>
                    `;
                    
                    leaderboardTable.appendChild(row);
                });
            });
        }

        // 预加载下一张可能的图片
        function preloadNextImage(currentPageId) {
            const pageNum = parseInt(currentPageId.substring(1));
            const nextPageNum = pageNum + 1;
            
            if (nextPageNum <= 21) {
                const nextPageId = nextPageNum.toString().padStart(4, '2'); // 确保是4位数
                const img = new Image();
                img.src = `images/画面${nextPageNum.toString().padStart(2, '0')}.jpg`;
            }
        }

        // 初始化游戏
        function initGame() {
            // 如果是老师，直接显示排名页面
            if (isTeacher) {
                switchPage('2501');
                return;
            }
            
            // 玩家从第一页开始
            switchPage(currentPage);
            
            // 记录开始时间
            startTime = Date.now();
            database.ref(`rooms/${roomNumber}/players/${playerId}/gameStarted`).set(true);
            
            // 设置最大游戏时间为60分钟
            setTimeout(() => {
                if (!gameCompleted) {
                    endGame();
                }
            }, 60 * 60 * 1000);
            
            // 每3秒更新一次用时
            setInterval(() => {
                if (!gameCompleted) {
                    const timeSpent = Math.round((Date.now() - startTime) / 1000);
                    database.ref(`rooms/${roomNumber}/players/${playerId}/timeSpent`).set(timeSpent);
                }
            }, 3000);
            
            // 按钮点击事件
            document.querySelectorAll('.game-button').forEach(button => {
                button.addEventListener('click', function() {
                    // 防止重复点击
                    if (clickedButtons.has(this)) return;
                    clickedButtons.add(this);
                    
                    // 短暂禁用按钮
                    this.disabled = true;
                    
                    // 如果是正确答案，更新分数
                    if (this.dataset.correct === 'true') {
                        updateScore(true);
                    }
                    
                    // 如果有提示，显示提示
                    if (this.dataset.hint) {
                        showHint(this.dataset.hint);
                    }
                    
                    // 延迟跳转，让玩家看到提示
                    setTimeout(() => {
                        // 如果是游戏结束按钮
                        if (this.id === 'game-over-btn') {
                            endGame();
                        } 
                        // 否则跳转到下一页
                        else if (this.dataset.next) {
                            switchPage(this.dataset.next);
                        }
                    }, this.dataset.hint ? 3000 : 100); // 如果有提示，延迟3秒，否则延迟100毫秒
                });
            });
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
