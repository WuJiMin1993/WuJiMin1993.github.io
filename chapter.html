<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Adventure - Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Game screens container -->
    <div id="game-container">
        <!-- Screens will be dynamically loaded here -->
    </div>

    <!-- Hint Modal -->
    <div id="hint-modal" class="modal">
        <div class="modal-content">
            <p id="hint-message"></p>
        </div>
    </div>

    <!-- Preloader for images -->
    <div id="preloader" style="display: none;"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isTeacher = urlParams.get('teacher') === 'true';

        // Game state variables
        let currentScreenId = null;
        let score = 0;
        let correctAnswers = 0;
        let startTime = null;
        let endTime = null;
        let gameCompleted = false;
        let buttonsClicked = new Set();

        // DOM Elements
        const gameContainer = document.getElementById('game-container');
        const hintModal = document.getElementById('hint-modal');
        const hintMessage = document.getElementById('hint-message');
        const preloader = document.getElementById('preloader');

        // Game screens data
        const screens = {
            // Chapter 1
            '2101': {
                image: 'images/画面01.jpg',
                text: 'Tom lives in a magical world and ____ the school library every day.',
                buttons: [
                    { text: 'cleans', position: 'left', correct: true, nextScreen: '2102' },
                    { text: 'cleaning', position: 'right', correct: false, 
                      hint: 'Daily behavior is expressed in the present tense', nextScreen: '2102' }
                ]
            },
            '2102': {
                image: 'images/画面02.jpg',
                text: 'Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.',
                buttons: [
                    { text: 'locked', position: 'left', correct: true, nextScreen: '2103' },
                    { text: 'locks', position: 'right', correct: false, 
                      hint: 'Describe the simple behavior that occurred yesterday in the past simple tense', nextScreen: '2103' }
                ]
            },
            '2103': {
                image: 'images/画面03.jpg',
                text: 'Tom walked over curiously and saw a magic wand with a flashing blue light, with a label next to it that read: Tense Magic wand.',
                buttons: [
                    { text: 'continue', position: 'center', correct: null, nextScreen: '2104' }
                ]
            },
            '2104': {
                image: 'images/画面04.jpg',
                text: 'Tom became curious and hid his magic wand in his clothes before taking it away from the library He ____ outdoors tomorrow to test the power of the magic wand.',
                buttons: [
                    { text: 'will go', position: 'left', correct: true, nextScreen: '2201' },
                    { text: 'is going', position: 'right', correct: false, 
                      hint: 'Describe simple behaviors that will occur in the future using general future tense', nextScreen: '2201' }
                ]
            },
            // Chapter 2
            '2201': {
                image: 'images/画面05.jpg',
                text: 'The next morning, he ____ a magic broom towards a forest next to the school.',
                buttons: [
                    { text: 'is riding', position: 'left', correct: true, nextScreen: '2202' },
                    { text: 'has ridden', position: 'right', correct: false, 
                      hint: 'Describe the ongoing behavior in present continuous tense', nextScreen: '2202' }
                ]
            },
            '2202': {
                image: 'images/画面06.jpg',
                text: 'At this time yesterday, Tom was cleaning the library. He was supposed to be organizing books in the library today, but he thought this magic wand would be fun. So I decided to slack off and not go to the library anymore.',
                buttons: [
                    { text: 'was cleaning', position: 'left', correct: true, nextScreen: '2203' },
                    { text: 'is cleaning', position: 'right', correct: false, 
                      hint: '描述过去正在进行的行为用过去进行时', nextScreen: '2203' }
                ]
            },
            '2203': {
                image: 'images/画面07.jpg',
                text: 'Tom will be tidying up the library early tomorrow to prevent library director Jimmy from discovering his laziness.',
                buttons: [
                    { text: 'will be tidying up', position: 'left', correct: true, nextScreen: '2301' },
                    { text: 'is tidying up', position: 'right', correct: false, 
                      hint: 'Describe the ongoing behavior in the future using future continuous tense', nextScreen: '2301' }
                ]
            },
            // Chapter 3
            '2301': {
                image: 'images/画面08.jpg',
                text: 'Tom stops by the stream in the forest and ____ the magic wand from his clothes. He thought that the magic wand is called a tense magic wand. Is the spell that activates it related to tense?',
                buttons: [
                    { text: 'takes out', position: 'left', correct: true, nextScreen: '2302' },
                    { text: 'will take out', position: 'right', correct: false, 
                      hint: 'Describe daily behavior in the present tense', nextScreen: '2302' }
                ]
            },
            '2302': {
                image: 'images/画面09.jpg',
                text: 'So he decided to try combining the spells he learned at the magic school. Tom pointed his magic wand at the stream and said, \'A delicious fish ____.\'',
                buttons: [
                    { text: 'has been grilled', position: 'left', correct: true, nextScreen: '2304' },
                    { text: 'will be grilled', position: 'right', correct: false, 
                      hint: 'The spell didn\'t take effect, Tom recited a delicious fish that had already been grilled', nextScreen: '2304' }
                ]
            },
            '2303': {
                image: 'images/画面10.jpg',
                text: 'After reciting the spell, a sudden blue flash appeared. Then a grill made of tree branches appeared in front of Tom, with a fragrant grilled fish on top.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2304' }
                ]
            },
            '2304': {
                image: 'images/画面11.jpg',
                text: 'Tom hadn\'t had breakfast before coming here, and his stomach was growling. Tom ____ the grilled fish and begins eating.',
                buttons: [
                    { text: 'has taken', position: 'left', correct: true, nextScreen: '2305' },
                    { text: 'will take', position: 'right', correct: false, 
                      hint: 'Describe completed actions in present perfect tense', nextScreen: '2305' }
                ]
            },
            '2305': {
                image: 'images/画面12.jpg',
                text: 'Tom thinks that now he has the powerful wand.And the wizard who always bullies me ____ by him.',
                buttons: [
                    { text: 'will have been defeated', position: 'left', correct: true, nextScreen: '2401' },
                    { text: 'has been defeated', position: 'right', correct: false, 
                      hint: 'Describe the behavior to be completed in the future using the future perfect tense', nextScreen: '2401' }
                ]
            },
            // Chapter 4
            '2401': {
                image: 'images/画面13.jpg',
                text: 'Although Tom ____ magic at the school for a year, his knowledge of magic is still inferior to that of wizard Mike.',
                buttons: [
                    { text: 'has been studying', position: 'left', correct: true, nextScreen: '2402' },
                    { text: 'will studying', position: 'right', correct: false, 
                      hint: 'The action has been ongoing from the past to the present, and may have just ended or is still ongoing, using the present to complete the ongoing tense', nextScreen: '2402' }
                ]
            },
            '2402': {
                image: 'images/画面14.jpg',
                text: 'So Tom came to the house of the wizard Mike who used to tease him. Tom shouted at Mike, \'I ____ magic to defeat you. Come out and accept my challenge.\'',
                buttons: [
                    { text: 'will use', position: 'left', correct: true, nextScreen: '2403' },
                    { text: 'am using', position: 'right', correct: false, 
                      hint: 'Describe future actions using future continuous tense', nextScreen: '2403' }
                ]
            },
            '2403': {
                image: 'images/画面15.jpg',
                text: 'Mike walked out of the room and said, \'Tom, you ____ to me over the past year. Are you still not willing to give up?\'',
                buttons: [
                    { text: 'had been repeatedly losing', position: 'left', correct: true, nextScreen: '2404' },
                    { text: 'was losing', position: 'right', correct: false, 
                      hint: 'A certain past action started earlier in the past and continued until a certain point in time, possibly still continuing or just stopped', nextScreen: '2404' }
                ]
            },
            '2404': {
                image: 'images/画面16.jpg',
                text: 'Tom pointed his magic wand at the sky and cursed \'It\'s going to rain soon,\' and the wand emitted blue light.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2405' }
                ]
            },
            '2405': {
                image: 'images/画面17.jpg',
                text: 'Before long, dark clouds appeared in the sky, thunder started to strike, and raindrops began to fall.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2406' }
                ]
            },
            '2406': {
                image: 'images/画面18.jpg',
                text: 'By tomorrow, Mike ____ magic for 2 years now. But Mike was still stunned when he saw Tom\'s magic. Mike had never seen such a powerful magic before and said to Tom, \'I admit you\'re already better than me.\'',
                buttons: [
                    { text: 'will have been studying', position: 'left', correct: true, nextScreen: '2407' },
                    { text: 'will be studying', position: 'right', correct: false, 
                      hint: 'Emphasize how long a certain action has been ongoing until a certain point in the future, using the future completion continuous time', nextScreen: '2407' }
                ]
            },
            '2407': {
                image: 'images/画面19.jpg',
                text: 'Tom wants to show off the power of his magic wand again and is ready to recite the next spell. But suddenly a beam of light flashed and the library director Jimmy appeared in front of him.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, nextScreen: '2408' }
                ]
            },
            '2408': {
                image: 'images/画面20.jpg',
                text: 'Library director Jimmy said to Tom, \'I ____ for it all day, but you took it away.\'.',
                buttons: [
                    { text: 'have been looking', position: 'left', correct: true, nextScreen: '2409' },
                    { text: 'am looking', position: 'right', correct: false, 
                      hint: 'Describe actions that have been completed in the past and use them to complete them', nextScreen: '2409' }
                ]
            },
            '2409': {
                image: 'images/画面21.jpg',
                text: 'Jimmy raised his hand, and the magic wand automatically flew into Jimmy\'s hand. Then Jimmy shouted at Tom, \'Hurry back and clean the library for me.\'',
                buttons: [
                    { text: 'Game over', position: 'center', correct: null, nextScreen: '2501' }
                ]
            },
            // Ranking screen
            '2501': {
                isRanking: true,
                text: 'Ranking'
            }
        };

        // Initialize game
        document.addEventListener('DOMContentLoaded', () => {
            if (isTeacher) {
                // Teacher goes directly to ranking screen
                loadScreen('2501');
            } else {
                // Player starts game
                startTime = new Date().getTime();
                loadScreen('2101'); // Start with first screen
                
                // Set up Firebase listener for player data
                if (playerId && roomId) {
                    setupPlayerDataListener();
                }
            }
        });

        // Set up Firebase listener for player data
        function setupPlayerDataListener() {
            const playerRef = database.ref('rooms/' + roomId + '/players/' + playerId);
            
            playerRef.on('value', (snapshot) => {
                const playerData = snapshot.val();
                if (playerData && playerData.completed) {
                    // If game is completed, go to ranking screen
                    if (!gameCompleted) {
                        gameCompleted = true;
                        loadScreen('2501');
                    }
                }
            });
        }

        // Load a game screen
        function loadScreen(screenId) {
            currentScreenId = screenId;
            buttonsClicked.clear();
            
            // Clear previous screen
            gameContainer.innerHTML = '';
            
            const screen = screens[screenId];
            if (!screen) {
                console.error('Screen not found:', screenId);
                return;
            }
            
            if (screen.isRanking) {
                // Load ranking screen
                loadRankingScreen();
                return;
            }
            
            // Create screen elements
            const screenElement = document.createElement('div');
            screenElement.className = 'screen active';
            screenElement.id = 'screen-' + screenId;
            
            // Add image
            const img = document.createElement('img');
            img.src = screen.image;
            img.alt = 'Game Screen ' + screenId;
            img.className = 'full-width-image';
            screenElement.appendChild(img);
            
            // Add text container
            const textContainer = document.createElement('div');
            textContainer.className = 'text-container';
            textContainer.textContent = screen.text;
            screenElement.appendChild(textContainer);
            
            // Add buttons container
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'button-container';
            
            // Add buttons
            screen.buttons.forEach(buttonData => {
                const button = document.createElement('button');
                button.className = 'game-btn';
                button.textContent = buttonData.text;
                
                // Position class
                if (buttonData.position === 'left') {
                    button.classList.add('left-btn');
                } else if (buttonData.position === 'right') {
                    button.classList.add('right-btn');
                } else {
                    button.classList.add('center-btn');
                }
                
                // Button click handler
                button.addEventListener('click', () => {
                    if (buttonsClicked.has(buttonData.text)) return;
                    buttonsClicked.add(buttonData.text);
                    
                    // Handle correct answer
                    if (buttonData.correct === true) {
                        correctAnswers++;
                        score += 6.7;
                        updatePlayerProgress();
                    }
                    
                    // Show hint if incorrect
                    if (buttonData.correct === false && buttonData.hint) {
                        showHint(buttonData.hint);
                    }
                    
                    // Preload next screen image
                    if (screen.buttons[0].nextScreen && screen.buttons[0].nextScreen !== '2501') {
                        preloadImage(screens[screen.buttons[0].nextScreen].image);
                    }
                    
                    // Move to next screen after delay if there's a hint
                    if (buttonData.hint) {
                        setTimeout(() => {
                            loadScreen(buttonData.nextScreen);
                        }, 3000);
                    } else {
                        loadScreen(buttonData.nextScreen);
                    }
                });
                
                buttonsContainer.appendChild(button);
            });
            
            screenElement.appendChild(buttonsContainer);
            gameContainer.appendChild(screenElement);
            
            // Update player progress
            updatePlayerProgress();
        }

        // Load ranking screen
        function loadRankingScreen() {
            if (!roomId) return;
            
            // Mark game as completed for player
            if (playerId && !isTeacher && !gameCompleted) {
                endTime = new Date().getTime();
                gameCompleted = true;
                
                // Calculate time spent in minutes
                const timeSpent = Math.max(1, Math.min(60, Math.ceil((endTime - startTime) / 60000)));
                
                // Calculate time score (2 points per minute, max 120)
                const timeScore = Math.min(120, timeSpent * 2);
                
                // Calculate total score (max 100)
                const totalScore = Math.min(100, Math.round(score + timeScore));
                
                // Calculate accuracy
                const accuracy = (correctAnswers / 15 * 100).toFixed(1);
                
                // Update player data
                const updates = {
                    score: totalScore,
                    correctAnswers: correctAnswers,
                    progress: 100,
                    timeSpent: timeSpent,
                    completed: true,
                    accuracy: accuracy,
                    completedAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                database.ref('rooms/' + roomId + '/players/' + playerId).update(updates)
                    .catch(error => {
                        console.error('Error updating player data:', error);
                    });
            }
            
            // Create ranking screen
            const screenElement = document.createElement('div');
            screenElement.className = 'screen active';
            screenElement.id = 'ranking-screen';
            
            // Room info
            const roomInfo = document.createElement('div');
            roomInfo.className = 'room-info';
            roomInfo.innerHTML = `<h2>Room: ${roomId}</h2>`;
            
            // Player count will be updated by the listener
            const playerCount = document.createElement('p');
            playerCount.id = 'player-count';
            playerCount.textContent = 'Players: 0';
            roomInfo.appendChild(playerCount);
            
            screenElement.appendChild(roomInfo);
            
            // Ranking table
            const rankingTable = document.createElement('table');
            rankingTable.id = 'ranking-table';
            rankingTable.innerHTML = `
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="ranking-body">
                    <!-- Rows will be added here -->
                </tbody>
            `;
            screenElement.appendChild(rankingTable);
            
            gameContainer.appendChild(screenElement);
            
            // Set up Firebase listener for room data
            setupRoomDataListener();
        }

        // Set up Firebase listener for room data
        function setupRoomDataListener() {
            if (!roomId) return;
            
            const roomRef = database.ref('rooms/' + roomId);
            
            roomRef.on('value', (snapshot) => {
                const roomData = snapshot.val();
                if (!roomData) return;
                
                // Update player count (excluding teacher)
                const players = roomData.players || {};
                const playerCount = Object.keys(players).length;
                document.getElementById('player-count').textContent = `Players: ${playerCount}`;
                
                // Prepare ranking data
                const rankingData = [];
                for (const playerId in players) {
                    const player = players[playerId];
                    if (player.completed) {
                        rankingData.push({
                            nickname: player.nickname || 'Anonymous',
                            score: player.score || 0,
                            accuracy: player.accuracy || '0.0',
                            timeSpent: player.timeSpent || 0
                        });
                    }
                }
                
                // Sort by score (descending)
                rankingData.sort((a, b) => b.score - a.score);
                
                // Update ranking table
                const rankingBody = document.getElementById('ranking-body');
                rankingBody.innerHTML = '';
                
                rankingData.slice(0, 10).forEach((player, index) => {
                    const row = document.createElement('tr');
                    
                    // Highlight current player's row
                    if (player.nickname === document.getElementById('nickname-input')?.value) {
                        row.classList.add('highlight-player');
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${escapeHtml(player.nickname)}</td>
                        <td>${player.score}</td>
                        <td>${player.accuracy}%</td>
                        <td>${player.timeSpent}m</td>
                    `;
                    rankingBody.appendChild(row);
                });
            });
        }

        // Show hint message
        function showHint(message) {
            hintMessage.textContent = message;
            hintModal.style.display = 'flex';
            
            setTimeout(() => {
                hintModal.style.display = 'none';
            }, 3000);
        }

        // Preload image
        function preloadImage(src) {
            const img = new Image();
            img.src = src;
            preloader.appendChild(img);
        }

        // Update player progress in Firebase
        function updatePlayerProgress() {
            if (!playerId || !roomId || isTeacher) return;
            
            // Calculate progress (current screen number / total screens * 100)
            const screenNumber = parseInt(currentScreenId.substring(1));
            const progress = Math.round((screenNumber - 2100) / 21 * 100);
            
            // Calculate time spent in minutes
            const currentTime = new Date().getTime();
            const timeSpent = Math.ceil((currentTime - startTime) / 60000);
            
            // Calculate accuracy
            const accuracy = (correctAnswers / 15 * 100).toFixed(1);
            
            const updates = {
                score: Math.round(score),
                correctAnswers: correctAnswers,
                progress: progress,
                timeSpent: timeSpent,
                accuracy: accuracy
            };
            
            database.ref('rooms/' + roomId + '/players/' + playerId).update(updates)
                .catch(error => {
                    console.error('Error updating player progress:', error);
                });
        }

        // Escape HTML to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>
