<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法冒险</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- 游戏主容器 -->
    <div id="game-container">
        <!-- 章节1-4的游戏画面将通过JavaScript动态加载 -->
    </div>
    
    <!-- 提示信息弹窗 -->
    <div id="hint-modal" class="modal">
        <div class="modal-content">
            <p id="hint-text"></p>
        </div>
    </div>
    
    <!-- 排名画面 -->
    <div id="ranking-screen" class="screen">
        <div class="ranking-container">
            <h2>游戏排名</h2>
            <div class="room-info">
                <p>房间号: <span id="room-id-display"></span></p>
                <p>当前人数: <span id="player-count"></span>/10</p>
            </div>
            <div class="player-stats">
                <p>正确率: <span id="accuracy-display">0%</span></p>
                <p>用时: <span id="time-used-display">0秒</span></p>
                <p>得分: <span id="score-display">0</span></p>
            </div>
            <div class="ranking-list" id="ranking-list">
                <!-- 排名列表将通过JavaScript动态生成 -->
            </div>
            <button id="close-ranking-btn" class="blue-btn">关闭</button>
        </div>
    </div>

    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 从URL获取房间号和玩家ID
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        
        // 游戏状态
        let gameState = {
            currentPage: 2101, // 当前页面ID
            score: 0,          // 得分
            correctAnswers: 0, // 正确答案数
            startTime: Date.now(), // 游戏开始时间
            timeUsed: 0,       // 用时(秒)
            isTeacher: false,  // 是否是老师
            clickedButtons: new Set() // 记录已点击的按钮
        };
        
        // 页面配置
        const pageConfigs = {
            // 章节1
            2101: {
                image: "images/画面01.jpg",
                text: "主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。",
                buttons: [
                    { text: "打扫", position: "left", correct: true, nextPage: 2102 },
                    { text: "正在打扫", position: "right", correct: false, nextPage: 2102, 
                      hint: "日常行为用一般现在时" }
                ]
            },
            2102: {
                image: "images/画面02.jpg",
                text: "有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。",
                buttons: [
                    { text: "锁上", position: "left", correct: true, nextPage: 2103 },
                    { text: "正在锁上", position: "right", correct: false, nextPage: 2103, 
                      hint: "描述昨天发生的简单行为用一般过去时" }
                ]
            },
            2103: {
                image: "images/画面03.jpg",
                text: "Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着：时态魔法棒。",
                buttons: [
                    { text: "继续", position: "center", correct: null, nextPage: 2104 }
                ]
            },
            2104: {
                image: "images/画面04.jpg",
                text: "Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。",
                buttons: [
                    { text: "将去", position: "left", correct: true, nextPage: 2201 },
                    { text: "已经去", position: "right", correct: false, nextPage: 2201, 
                      hint: "描述未来发生的简单行为用一般将来时" }
                ]
            },
            // 章节2
            2201: {
                image: "images/画面05.jpg",
                text: "时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。",
                buttons: [
                    { text: "正在骑", position: "left", correct: true, nextPage: 2202 },
                    { text: "已经骑", position: "right", correct: false, nextPage: 2202, 
                      hint: "描述正在进行的行为用现在进行时" }
                ]
            },
            2202: {
                image: "images/画面06.jpg",
                text: "昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。",
                buttons: [
                    { text: "正在打扫", position: "left", correct: true, nextPage: 2203 },
                    { text: "已经打扫", position: "right", correct: false, nextPage: 2203, 
                      hint: "描述过去正在进行的行为用过去进行时" }
                ]
            },
            2203: {
                image: "images/画面07.jpg",
                text: "为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。",
                buttons: [
                    { text: "打扫", position: "left", correct: true, nextPage: 2301 },
                    { text: "已经打扫", position: "right", correct: false, nextPage: 2301, 
                      hint: "描述将来正在进行的行为用将来进行时" }
                ]
            },
            // 章节3
            2301: {
                image: "images/画面08.jpg",
                text: "Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫"时态"，难道启动它的咒语和时态有关？",
                buttons: [
                    { text: "拿出", position: "left", correct: true, nextPage: 2302 },
                    { text: "已经拿出", position: "right", correct: false, nextPage: 2302, 
                      hint: "描述日常行为一般现在时" }
                ]
            },
            2302: {
                image: "images/画面09.jpg",
                text: "于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼____了【现在完成】"",
                buttons: [
                    { text: "已经被烤熟", position: "left", correct: true, nextPage: 2304 },
                    { text: "将来被烤熟", position: "right", correct: false, nextPage: 2304, 
                      hint: "咒语未生效，Tom重新念了一条香喷喷的鱼已经被烤熟了" }
                ]
            },
            2303: {
                image: "images/画面10.jpg",
                text: "只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。",
                buttons: [
                    { text: "继续", position: "center", correct: null, nextPage: 2304 }
                ]
            },
            2304: {
                image: "images/画面11.jpg",
                text: "Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。",
                buttons: [
                    { text: "已经烤好的鱼", position: "left", correct: true, nextPage: 2305 },
                    { text: "将要烤好", position: "right", correct: false, nextPage: 2305, 
                      hint: "描述已经完成的的行为用现在完成时" }
                ]
            },
            2305: {
                image: "images/画面12.jpg",
                text: "Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）",
                buttons: [
                    { text: "将会被打败", position: "left", correct: true, nextPage: 2401 },
                    { text: "已经被打败", position: "right", correct: false, nextPage: 2401, 
                      hint: "描述将来完成的的行为用将来完成时" }
                ]
            },
            // 章节4
            2401: {
                image: "images/画面13.jpg",
                text: "虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。",
                buttons: [
                    { text: "学习了", position: "left", correct: true, nextPage: 2402 },
                    { text: "将学习", position: "right", correct: false, nextPage: 2402, 
                      hint: "描述过去的行为持续到现在用现在完成进行" }
                ]
            },
            2402: {
                image: "images/画面14.jpg",
                text: "Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"",
                buttons: [
                    { text: "可以用", position: "left", correct: true, nextPage: 2403 },
                    { text: "正在用", position: "right", correct: false, nextPage: 2403, 
                      hint: "描述正在进行的行为用现在进行时" }
                ]
            },
            2403: {
                image: "images/画面15.jpg",
                text: "今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"",
                buttons: [
                    { text: "输给", position: "left", correct: true, nextPage: 2404 },
                    { text: "将输给", position: "right", correct: false, nextPage: 2404, 
                      hint: "描述正在进行的行为用现在进行时" }
                ]
            },
            2404: {
                image: "images/画面16.jpg",
                text: "只见Tom用魔法棒指向天空，用咒语说了一句："It's going to rain soon"，魔法棒发出来蓝光。",
                buttons: [
                    { text: "继续", position: "center", correct: null, nextPage: 2405 }
                ]
            },
            2405: {
                image: "images/画面17.jpg",
                text: "果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。",
                buttons: [
                    { text: "继续", position: "center", correct: null, nextPage: 2406 }
                ]
            },
            2406: {
                image: "images/画面18.jpg",
                text: "Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"",
                buttons: [
                    { text: "已经学了", position: "left", correct: true, nextPage: 2407 },
                    { text: "将要学", position: "right", correct: false, nextPage: 2407, 
                      hint: "描述将来完成进行时" }
                ]
            },
            2407: {
                image: "images/画面19.jpg",
                text: "Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。",
                buttons: [
                    { text: "继续", position: "center", correct: null, nextPage: 2408 }
                ]
            },
            2408: {
                image: "images/画面20.jpg",
                text: "馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。",
                buttons: [
                    { text: "找了", position: "left", correct: true, nextPage: 2409 },
                    { text: "将找", position: "right", correct: false, nextPage: 2409, 
                      hint: "描述过去完成" }
                ]
            },
            2409: {
                image: "images/画面21.jpg",
                text: "Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....",
                buttons: [
                    { text: "游戏结束", position: "center", correct: null, nextPage: 2501 }
                ]
            },
            // 排名画面
            2501: {
                isRanking: true
            }
        };
        
        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const hintModal = document.getElementById('hint-modal');
        const hintText = document.getElementById('hint-text');
        const rankingScreen = document.getElementById('ranking-screen');
        const roomIdDisplay = document.getElementById('room-id-display');
        const playerCountDisplay = document.getElementById('player-count');
        const accuracyDisplay = document.getElementById('accuracy-display');
        const timeUsedDisplay = document.getElementById('time-used-display');
        const scoreDisplay = document.getElementById('score-display');
        const rankingList = document.getElementById('ranking-list');
        const closeRankingBtn = document.getElementById('close-ranking-btn');
        
        // 显示提示信息
        function showHint(message, duration = 3000) {
            hintText.textContent = message;
            hintModal.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    hintModal.style.display = 'none';
                }, duration);
            }
        }
        
        // 计算正确率
        function calculateAccuracy() {
            if (gameState.correctAnswers === 0) return 0;
            const accuracy = (gameState.correctAnswers / 15) * 100;
            return Math.round(accuracy * 10) / 10; // 保留一位小数
        }
        
        // 计算得分
        function calculateScore() {
            // 每题6.7分，共15题
            const questionScore = gameState.correctAnswers * 6.7;
            
            // 时间分数：每分钟2分，不满一分钟1分
            const minutes = Math.floor(gameState.timeUsed / 60);
            const timeScore = minutes * 2 + (gameState.timeUsed % 60 > 0 ? 1 : 0);
            
            return Math.round(questionScore + timeScore);
        }
        
        // 计算进度
        function calculateProgress(pageId) {
            // 页面ID从2101到2409共21个画面
            const pageNumber = parseInt(pageId.toString().substring(1)) - 100;
            const progress = Math.round((pageNumber / 21) * 100);
            return Math.min(progress, 100); // 确保不超过100%
        }
        
        // 更新玩家数据到Firebase
        async function updatePlayerData() {
            if (!roomId || !playerId) return;
            
            const accuracy = calculateAccuracy();
            const score = calculateScore();
            const progress = calculateProgress(gameState.currentPage);
            
            try {
                await database.ref(`rooms/${roomId}/players/${playerId}`).update({
                    score: score,
                    accuracy: accuracy,
                    progress: progress,
                    timeUsed: gameState.timeUsed,
                    lastUpdate: Date.now()
                });
            } catch (error) {
                console.error("更新玩家数据时出错:", error);
            }
        }
        
        // 加载排名数据
        async function loadRankingData() {
            if (!roomId) return;
            
            try {
                const snapshot = await database.ref(`rooms/${roomId}`).once('value');
                const roomData = snapshot.val();
                
                if (!roomData) {
                    console.error("房间数据不存在");
                    return;
                }
                
                // 更新房间信息
                roomIdDisplay.textContent = roomId;
                playerCountDisplay.textContent = roomData.playerCount || 1;
                
                // 准备玩家数据数组
                const players = [];
                for (const [id, player] of Object.entries(roomData.players)) {
                    players.push({
                        id: id,
                        name: player.name,
                        score: player.score || 0,
                        accuracy: player.accuracy || 0,
                        progress: player.progress || 0,
                        timeUsed: player.timeUsed || 0,
                        isTeacher: player.isTeacher || false
                    });
                }
                
                // 按分数排序
                players.sort((a, b) => b.score - a.score);
                
                // 更新当前玩家数据
                const currentPlayer = players.find(p => p.id === playerId);
                if (currentPlayer) {
                    accuracyDisplay.textContent = `${currentPlayer.accuracy}%`;
                    timeUsedDisplay.textContent = `${Math.floor(currentPlayer.timeUsed / 60)}分${currentPlayer.timeUsed % 60}秒`;
                    scoreDisplay.textContent = currentPlayer.score;
                }
                
                // 生成排名列表
                rankingList.innerHTML = '';
                players.slice(0, 10).forEach((player, index) => {
                    const playerElement = document.createElement('div');
                    playerElement.className = `ranking-item ${player.id === playerId ? 'current-player' : ''}`;
                    
                    playerElement.innerHTML = `
                        <span class="rank">${index + 1}</span>
                        <span class="name">${player.name}${player.isTeacher ? ' (老师)' : ''}</span>
                        <span class="score">${player.score}</span>
                        <span class="accuracy">${player.accuracy}%</span>
                        <span class="time">${Math.floor(player.timeUsed / 60)}:${(player.timeUsed % 60).toString().padStart(2, '0')}</span>
                        <span class="progress">${player.progress}%</span>
                    `;
                    
                    rankingList.appendChild(playerElement);
                });
                
            } catch (error) {
                console.error("加载排名数据时出错:", error);
            }
        }
        
        // 显示排名画面
        function showRankingScreen() {
            loadRankingData();
            rankingScreen.style.display = 'block';
        }
        
        // 隐藏排名画面
        function hideRankingScreen() {
            rankingScreen.style.display = 'none';
        }
        
        // 预加载图片
        function preloadImage(imagePath) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = imagePath;
                img.onload = () => resolve();
                img.onerror = () => resolve(); // 即使加载失败也继续
            });
        }
        
        // 加载游戏页面
        async function loadPage(pageId) {
            // 更新游戏状态
            gameState.currentPage = pageId;
            gameState.timeUsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            
            // 如果是排名画面，特殊处理
            if (pageId === 2501) {
                showRankingScreen();
                return;
            }
            
            // 获取页面配置
            const config = pageConfigs[pageId];
            if (!config) {
                console.error(`找不到页面配置: ${pageId}`);
                return;
            }
            
            // 更新玩家数据到Firebase
            await updatePlayerData();
            
            // 预加载下一张可能的图片
            if (config.buttons && config.buttons.length > 0) {
                const nextPageId = config.buttons[0].nextPage;
                if (nextPageId && pageConfigs[nextPageId] && pageConfigs[nextPageId].image) {
                    preloadImage(pageConfigs[nextPageId].image);
                }
            }
            
            // 创建页面HTML
            let pageHTML = `
                <div class="screen active fade-in">
                    <img src="${config.image}" alt="游戏画面" class="full-width-image">
                    <div class="text-container">${config.text}</div>
                    <div class="button-container">
            `;
            
            // 添加按钮
            config.buttons.forEach(button => {
                const buttonClass = button.position === 'center' ? 'center-btn' : 
                                   button.position === 'left' ? 'left-btn' : 'right-btn';
                
                pageHTML += `
                    <button class="blue-btn ${buttonClass}" 
                            data-next="${button.nextPage}" 
                            data-correct="${button.correct}"
                            ${button.hint ? `data-hint="${button.hint}"` : ''}>
                        ${button.text}
                    </button>
                `;
            });
            
            pageHTML += `
                    </div>
                </div>
            `;
            
            // 更新游戏容器
            gameContainer.innerHTML = pageHTML;
            
            // 添加按钮事件监听
            document.querySelectorAll('.blue-btn').forEach(button => {
                button.addEventListener('click', handleButtonClick);
            });
            
            // 重置已点击按钮记录
            gameState.clickedButtons.clear();
        }
        
        // 处理按钮点击
        async function handleButtonClick(event) {
            const button = event.target;
            const nextPage = parseInt(button.dataset.next);
            const isCorrect = button.dataset.correct === 'true';
            const hint = button.dataset.hint;
            
            // 防止重复点击
            if (gameState.clickedButtons.has(button)) return;
            gameState.clickedButtons.add(button);
            
            // 禁用所有按钮
            document.querySelectorAll('.blue-btn').forEach(btn => {
                btn.disabled = true;
            });
            
            // 如果是正确答案，增加分数
            if (isCorrect) {
                gameState.correctAnswers++;
            }
            
            // 如果有提示信息，显示
            if (hint) {
                showHint(hint);
                await new Promise(resolve => setTimeout(resolve, 3000));
            }
            
            // 加载下一页
            await loadPage(nextPage);
        }
        
        // 事件监听
        closeRankingBtn.addEventListener('click', () => {
            // 如果是老师，留在排名画面
            if (gameState.isTeacher) return;
            
            // 如果是学生，关闭游戏
            window.location.href = 'index.html';
        });
        
        // 初始化游戏
        async function initGame() {
            // 检查是否是老师
            if (roomId && playerId) {
                try {
                    const snapshot = await database.ref(`rooms/${roomId}/players/${playerId}`).once('value');
                    const playerData = snapshot.val();
                    gameState.isTeacher = playerData && playerData.isTeacher;
                    
                    // 如果是老师，直接显示排名画面
                    if (gameState.isTeacher) {
                        await loadPage(2501);
                        return;
                    }
                } catch (error) {
                    console.error("检查玩家身份时出错:", error);
                }
            }
            
            // 否则加载第一个页面
            await loadPage(2101);
        }
        
        // 启动游戏
        initGame();
    </script>
</body>
</html>
