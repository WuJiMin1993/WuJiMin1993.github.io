<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法冒险 - 游戏章节</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- 游戏章节容器 -->
    <div id="game-container">
        <!-- 所有游戏画面将通过JavaScript动态生成 -->
    </div>

    <!-- 提示信息弹窗 -->
    <div id="message-modal" class="modal">
        <div class="modal-content">
            <p id="message-text"></p>
        </div>
    </div>

    <script>
        // 初始化游戏状态
        const gameState = {
            currentPage: 0,
            totalPages: 21,
            score: 0,
            correctAnswers: 0,
            startTime: null,
            roomCode: null,
            playerName: null,
            answeredPages: new Set(),
            preloadedImages: new Set()
        };

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 从URL获取房间号和玩家名称
        function parseQueryParams() {
            const params = new URLSearchParams(window.location.search);
            gameState.roomCode = params.get('room');
            gameState.playerName = decodeURIComponent(params.get('player'));
        }

        // 显示消息弹窗
        function showMessage(message, duration = 3000) {
            const messageModal = document.getElementById('message-modal');
            const messageText = document.getElementById('message-text');
            
            messageText.textContent = message;
            messageModal.style.display = 'block';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, duration);
            }
        }

        // 预加载图片
        function preloadImage(pageId) {
            const imageName = getImageNameForPage(pageId);
            if (!imageName || gameState.preloadedImages.has(imageName)) return;
            
            const img = new Image();
            img.src = `images/${imageName}`;
            gameState.preloadedImages.add(imageName);
        }

        // 根据页面ID获取图片名称
        function getImageNameForPage(pageId) {
            if (pageId === 2001) return '开始画面.jpg';
            if (pageId >= 2101 && pageId <= 2110) return `画面${String(pageId - 2100).padStart(2, '0')}.jpg`;
            if (pageId >= 2201 && pageId <= 2210) return `画面${String(pageId - 2100).padStart(2, '0')}.jpg`;
            if (pageId >= 2301 && pageId <= 2310) return `画面${String(pageId - 2100).padStart(2, '0')}.jpg`;
            if (pageId >= 2401 && pageId <= 2410) return `画面${String(pageId - 2100).padStart(2, '0')}.jpg`;
            if (pageId === 2501) return null; // 排名画面没有图片
            return null;
        }

        // 创建游戏页面
        function createPage(pageId) {
            const container = document.getElementById('game-container');
            container.innerHTML = '';
            
            // 记录当前页面
            gameState.currentPage = pageId;
            
            // 更新Firebase中的玩家进度
            updatePlayerProgress();
            
            // 预加载下一页可能的图片
            preloadNextPossibleImages(pageId);
            
            // 创建页面元素
            const page = document.createElement('div');
            page.className = 'game-page';
            page.dataset.pageId = pageId;
            
            // 添加图片
            const imageName = getImageNameForPage(pageId);
            if (imageName) {
                const img = document.createElement('img');
                img.src = `images/${imageName}`;
                img.alt = `游戏画面 ${pageId}`;
                img.className = 'full-width-image';
                page.appendChild(img);
            }
            
            // 添加文字内容
            const textContent = getTextContentForPage(pageId);
            if (textContent) {
                const textBox = document.createElement('div');
                textBox.className = 'text-box';
                textBox.textContent = textContent;
                page.appendChild(textBox);
            }
            
            // 添加按钮
            const buttons = getButtonsForPage(pageId);
            if (buttons && buttons.length > 0) {
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';
                
                buttons.forEach(button => {
                    const btn = document.createElement('button');
                    btn.className = 'game-button';
                    btn.textContent = button.name;
                    btn.dataset.isCorrect = button.isCorrect;
                    btn.dataset.nextPage = button.nextPage;
                    btn.dataset.message = button.message || '';
                    
                    // 位置布局
                    if (buttons.length === 2) {
                        btn.style.float = button.position === 'left' ? 'left' : 'right';
                    } else {
                        btn.style.margin = '0 auto';
                    }
                    
                    // 点击事件
                    btn.addEventListener('click', function() {
                        if (gameState.answeredPages.has(pageId)) return;
                        
                        gameState.answeredPages.add(pageId);
                        
                        // 处理正确答案
                        if (button.isCorrect === 'true') {
                            gameState.score += 6.7;
                            gameState.correctAnswers++;
                            updatePlayerScore();
                        }
                        
                        // 显示提示信息
                        if (button.message) {
                            showMessage(button.message, 3000);
                        }
                        
                        // 跳转到下一页
                        setTimeout(() => {
                            navigateToPage(button.nextPage);
                        }, button.message ? 3000 : 0);
                    });
                    
                    buttonContainer.appendChild(btn);
                });
                
                page.appendChild(buttonContainer);
            }
            
            container.appendChild(page);
            
            // 添加淡入效果
            setTimeout(() => {
                page.style.opacity = '1';
            }, 50);
        }

        // 预加载下一页可能的图片
        function preloadNextPossibleImages(currentPageId) {
            // 根据游戏流程预加载可能的下一页图片
            switch (currentPageId) {
                case 2001: // 开始画面
                    preloadImage(2101); // 画面01
                    break;
                case 2101: // 画面01
                    preloadImage(2102); // 画面02
                    break;
                case 2102: // 画面02
                    preloadImage(2103); // 画面03
                    break;
                case 2103: // 画面03
                    preloadImage(2104); // 画面04
                    break;
                case 2104: // 画面04
                    preloadImage(2201); // 画面05
                    break;
                // 继续为其他页面添加预加载逻辑...
                default:
                    // 默认预加载下一页
                    const nextPageId = getNextPageId(currentPageId);
                    if (nextPageId) preloadImage(nextPageId);
            }
        }

        // 获取下一页ID
        function getNextPageId(currentPageId) {
            // 根据游戏流程返回下一页ID
            // 这里简化处理，实际应根据游戏流程设计
            if (currentPageId < 2409) return currentPageId + 1;
            if (currentPageId === 2409) return 2501; // 游戏结束到排名画面
            return null;
        }

        // 导航到指定页面
        function navigateToPage(pageId) {
            if (!pageId) return;
            
            // 淡出当前页面
            const container = document.getElementById('game-container');
            if (container.firstChild) {
                container.firstChild.style.opacity = '0';
                
                // 等待淡出动画完成
                setTimeout(() => {
                    createPage(pageId);
                }, 300);
            } else {
                createPage(pageId);
            }
            
            // 如果是排名画面，跳转到排名页面
            if (pageId === 2501) {
                window.location.href = `index.html?room=${gameState.roomCode}&player=${encodeURIComponent(gameState.playerName)}`;
            }
        }

        // 更新玩家分数到Firebase
        function updatePlayerScore() {
            if (!gameState.roomCode || !gameState.playerName) return;
            
            const updates = {};
            updates[`rooms/${gameState.roomCode}/players/${gameState.playerName}/score`] = gameState.score;
            updates[`rooms/${gameState.roomCode}/players/${gameState.playerName}/correctAnswers`] = gameState.correctAnswers;
            
            database.ref().update(updates).catch(error => {
                console.error('更新分数失败:', error);
            });
        }

        // 更新玩家进度到Firebase
        function updatePlayerProgress() {
            if (!gameState.roomCode || !gameState.playerName) return;
            
            const progress = Math.round((gameState.currentPage / gameState.totalPages) * 100);
            database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerName}/progress`).set(progress)
                .catch(error => {
                    console.error('更新进度失败:', error);
                });
        }

        // 获取页面的文字内容
        function getTextContentForPage(pageId) {
            // 这里简化处理，实际应根据游戏设计提供完整内容
            const pageContents = {
                2101: "主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。",
                2102: "有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。",
                2103: "Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着：时态魔法棒。",
                2104: "Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。",
                // 继续为其他页面添加内容...
                2409: "Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道“赶紧回去给我打扫图书馆”....."
            };
            
            return pageContents[pageId] || `这是画面 ${pageId} 的内容`;
        }

        // 获取页面的按钮配置
        function getButtonsForPage(pageId) {
            // 这里简化处理，实际应根据游戏设计提供完整配置
            const buttonsConfig = {
                2101: [
                    { name: "打扫", position: "left", isCorrect: "true", nextPage: 2102 },
                    { name: "正在打扫", position: "right", isCorrect: "false", nextPage: 2102, 
                      message: "日常行为用一般现在时" }
                ],
                2102: [
                    { name: "锁上", position: "left", isCorrect: "true", nextPage: 2103 },
                    { name: "正在锁上", position: "right", isCorrect: "false", nextPage: 2103, 
                      message: "描述昨天发生的简单行为用一般过去时" }
                ],
                2103: [
                    { name: "继续", position: "center", isCorrect: "true", nextPage: 2104 }
                ],
                2104: [
                    { name: "将去", position: "left", isCorrect: "true", nextPage: 2201 },
                    { name: "已经去", position: "right", isCorrect: "false", nextPage: 2201, 
                      message: "描述未来发生的简单行为用一般将来时" }
                ],
                // 继续为其他页面添加按钮配置...
                2409: [
                    { name: "游戏结束", position: "center", isCorrect: "true", nextPage: 2501 }
                ]
            };
            
            return buttonsConfig[pageId];
        }

        // 初始化游戏
        function initGame() {
            parseQueryParams();
            
            // 设置开始时间
            gameState.startTime = new Date().getTime();
            
            // 从页面ID 2101开始游戏
            createPage(2101);
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
