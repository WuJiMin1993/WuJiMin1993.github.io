<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法冒险</title>
    <link href="https://fonts.googleapis.com/css2?family=Microsoft+YaHei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- 所有游戏页面 -->
    <!-- 章节1 -->
    <div id="page-2101" class="game-page">
        <img src="images/画面01.jpg" alt="画面01" class="game-image">
        <div class="text-box">主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2102" class="game-button left-button">打扫</button>
            <button data-correct="false" data-next="2102" class="game-button right-button">正在打扫</button>
        </div>
    </div>
    
    <div id="page-2102" class="game-page">
        <img src="images/画面02.jpg" alt="画面02" class="game-image">
        <div class="text-box">有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2103" class="game-button left-button">锁上</button>
            <button data-correct="false" data-next="2103" class="game-button right-button">正在锁上</button>
        </div>
    </div>
    
    <div id="page-2103" class="game-page">
        <img src="images/画面03.jpg" alt="画面03" class="game-image">
        <div class="text-box">Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着：时态魔法棒。</div>
        <div class="button-container">
            <button data-next="2104" class="game-button center-button">继续</button>
        </div>
    </div>
    
    <div id="page-2104" class="game-page">
        <img src="images/画面04.jpg" alt="画面04" class="game-image">
        <div class="text-box">Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2201" class="game-button left-button">将去</button>
            <button data-correct="false" data-next="2201" class="game-button right-button">已经去</button>
        </div>
    </div>
    
    <!-- 章节2 -->
    <div id="page-2201" class="game-page">
        <img src="images/画面05.jpg" alt="画面05" class="game-image">
        <div class="text-box">时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2202" class="game-button left-button">正在骑</button>
            <button data-correct="false" data-next="2202" class="game-button right-button">已经骑</button>
        </div>
    </div>
    
    <div id="page-2202" class="game-page">
        <img src="images/画面06.jpg" alt="画面06" class="game-image">
        <div class="text-box">昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2203" class="game-button left-button">正在打扫</button>
            <button data-correct="false" data-next="2203" class="game-button right-button">已经打扫</button>
        </div>
    </div>
    
    <div id="page-2203" class="game-page">
        <img src="images/画面07.jpg" alt="画面07" class="game-image">
        <div class="text-box">为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2301" class="game-button left-button">打扫</button>
            <button data-correct="false" data-next="2301" class="game-button right-button">已经打扫</button>
        </div>
    </div>
    
    <!-- 章节3 -->
    <div id="page-2301" class="game-page">
        <img src="images/画面08.jpg" alt="画面08" class="game-image">
        <div class="text-box">Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫时态魔法棒，难道启动它的咒语和时态有关？</div>
        <div class="button-container">
            <button data-correct="true" data-next="2302" class="game-button left-button">拿出</button>
            <button data-correct="false" data-next="2302" class="game-button right-button">已经拿出</button>
        </div>
    </div>
    
    <div id="page-2302" class="game-page">
        <img src="images/画面09.jpg" alt="画面09" class="game-image">
        <div class="text-box">于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼____了【现在完成】"</div>
        <div class="button-container">
            <button data-correct="true" data-next="2304" class="game-button left-button">已经被烤熟</button>
            <button data-correct="false" data-next="2304" class="game-button right-button">将来被烤熟</button>
        </div>
    </div>
    
    <div id="page-2303" class="game-page">
        <img src="images/画面10.jpg" alt="画面10" class="game-image">
        <div class="text-box">只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。</div>
        <div class="button-container">
            <button data-next="2304" class="game-button center-button">继续</button>
        </div>
    </div>
    
    <div id="page-2304" class="game-page">
        <img src="images/画面11.jpg" alt="画面11" class="game-image">
        <div class="text-box">Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2305" class="game-button left-button">已经烤好的鱼</button>
            <button data-correct="false" data-next="2305" class="game-button right-button">将要烤好</button>
        </div>
    </div>
    
    <div id="page-2305" class="game-page">
        <img src="images/画面12.jpg" alt="画面12" class="game-image">
        <div class="text-box">Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）</div>
        <div class="button-container">
            <button data-correct="true" data-next="2401" class="game-button left-button">将会被打败</button>
            <button data-correct="false" data-next="2401" class="game-button right-button">已经被打败</button>
        </div>
    </div>
    
    <!-- 章节4 -->
    <div id="page-2401" class="game-page">
        <img src="images/画面13.jpg" alt="画面13" class="game-image">
        <div class="text-box">虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2402" class="game-button left-button">学习了</button>
            <button data-correct="false" data-next="2402" class="game-button right-button">将学习</button>
        </div>
    </div>
    
    <div id="page-2402" class="game-page">
        <img src="images/画面14.jpg" alt="画面14" class="game-image">
        <div class="text-box">Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"</div>
        <div class="button-container">
            <button data-correct="true" data-next="2403" class="game-button left-button">可以用</button>
            <button data-correct="false" data-next="2403" class="game-button right-button">正在用</button>
        </div>
    </div>
    
    <div id="page-2403" class="game-page">
        <img src="images/画面15.jpg" alt="画面15" class="game-image">
        <div class="text-box">今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"</div>
        <div class="button-container">
            <button data-correct="true" data-next="2404" class="game-button left-button">输给</button>
            <button data-correct="false" data-next="2404" class="game-button right-button">将输给</button>
        </div>
    </div>
    
    <div id="page-2404" class="game-page">
        <img src="images/画面16.jpg" alt="画面16" class="game-image">
        <div class="text-box">只见Tom用魔法棒指向天空，用咒语说了一句："It's going to rain soon"，魔法棒发出来蓝光。</div>
        <div class="button-container">
            <button data-next="2405" class="game-button center-button">继续</button>
        </div>
    </div>
    
    <div id="page-2405" class="game-page">
        <img src="images/画面17.jpg" alt="画面17" class="game-image">
        <div class="text-box">果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。</div>
        <div class="button-container">
            <button data-next="2406" class="game-button center-button">继续</button>
        </div>
    </div>
    
    <div id="page-2406" class="game-page">
        <img src="images/画面18.jpg" alt="画面18" class="game-image">
        <div class="text-box">Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"</div>
        <div class="button-container">
            <button data-correct="true" data-next="2407" class="game-button left-button">已经学了</button>
            <button data-correct="false" data-next="2407" class="game-button right-button">将要学</button>
        </div>
    </div>
    
    <div id="page-2407" class="game-page">
        <img src="images/画面19.jpg" alt="画面19" class="game-image">
        <div class="text-box">Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。</div>
        <div class="button-container">
            <button data-next="2408" class="game-button center-button">继续</button>
        </div>
    </div>
    
    <div id="page-2408" class="game-page">
        <img src="images/画面20.jpg" alt="画面20" class="game-image">
        <div class="text-box">馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。</div>
        <div class="button-container">
            <button data-correct="true" data-next="2409" class="game-button left-button">找了</button>
            <button data-correct="false" data-next="2409" class="game-button right-button">将找</button>
        </div>
    </div>
    
    <div id="page-2409" class="game-page">
        <img src="images/画面21.jpg" alt="画面21" class="game-image">
        <div class="text-box">Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....</div>
        <div class="button-container">
            <button data-next="2501" class="game-button center-button">游戏结束</button>
        </div>
    </div>
    
    <!-- 排名页面 -->
    <div id="page-2501" class="game-page ranking-page">
        <div class="ranking-container">
            <h2 id="room-id-display">房间号: </h2>
            <div class="player-stats">
                <div>正确率: <span id="correct-rate">0%</span></div>
                <div>用时: <span id="time-used">0分钟</span></div>
                <div>得分: <span id="total-score">0</span></div>
                <div>房间人数: <span id="player-count">1</span></div>
            </div>
            <h3>Top 10排名</h3>
            <table id="ranking-table">
                <thead>
                    <tr>
                        <th>排名</th>
                        <th>玩家</th>
                        <th>得分</th>
                        <th>正确率</th>
                        <th>进度</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 排名数据将通过JavaScript动态填充 -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('roomId');
        const playerId = urlParams.get('playerId');
        const isTeacher = urlParams.get('isTeacher') === 'true';
        
        // 游戏状态
        let gameState = {
            roomId: roomId,
            playerId: playerId,
            isTeacher: isTeacher,
            startTime: new Date().getTime(),
            score: 0,
            correctAnswers: 0,
            currentPage: null,
            clickedButtons: new Set() // 用于记录已点击的按钮
        };
        
        // 预加载下一张图片
        function preloadNextImage(nextPageId) {
            if (!nextPageId) return;
            
            const nextImageNumber = nextPageId.substring(4); // 从"2101"中提取"01"
            const nextImageSrc = `images/画面${nextImageNumber}.jpg`;
            
            const img = new Image();
            img.src = nextImageSrc;
        }
        
        // 显示页面
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.game-page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // 显示当前页面
            const currentPage = document.getElementById(`page-${pageId}`);
            if (currentPage) {
                currentPage.style.display = 'block';
                setTimeout(() => {
                    currentPage.classList.add('active');
                }, 10);
                
                // 如果是排名页面，初始化排名数据
                if (pageId === '2501') {
                    initRankingPage();
                }
                
                // 更新当前页面状态
                gameState.currentPage = pageId;
                updatePlayerProgress();
            }
        }
        
        // 更新玩家进度到Firebase
        function updatePlayerProgress() {
            if (gameState.isTeacher || !gameState.playerId) return;
            
            // 计算进度 (1-21对应5%-100%)
            const progress = Math.round((parseInt(gameState.currentPage.substring(2)) / 21) * 100);
            
            // 计算正确率
            const correctRate = (gameState.correctAnswers / 15 * 100).toFixed(1);
            
            // 更新玩家数据
            database.ref(`rooms/${gameState.roomId}/players/${gameState.playerId}`).update({
                score: gameState.score,
                correctRate: correctRate,
                progress: progress,
                currentPage: gameState.currentPage
            });
        }
        
        // 初始化排名页面
        function initRankingPage() {
            if (!gameState.roomId) return;
            
            // 显示房间号
            document.getElementById('room-id-display').textContent = `房间号: ${gameState.roomId}`;
            
            // 如果是玩家(非老师)，计算并保存最终成绩
            if (!gameState.isTeacher && gameState.playerId) {
                const endTime = new Date().getTime();
                const timeUsed = Math.floor((endTime - gameState.startTime) / 1000); // 秒
                
                // 计算时间分数 (每分钟2分，不足1分钟1分)
                const timeScore = Math.floor(timeUsed / 60) * 2 + (timeUsed % 60 > 0 ? 1 : 0);
                
                // 总分数 = 答题分数 + 时间分数
                const totalScore = gameState.score + timeScore;
                
                // 计算正确率
                const correctRate = (gameState.correctAnswers / 15 * 100).toFixed(1);
                
                // 计算用时(分钟:秒)
                const minutes = Math.floor(timeUsed / 60);
                const seconds = timeUsed % 60;
                const timeUsedStr = `${minutes}分${seconds}秒`;
                
                // 更新玩家数据
                database.ref(`rooms/${gameState.roomId}/players/${gameState.playerId}`).update({
                    score: totalScore,
                    correctRate: correctRate,
                    progress: 100,
                    timeUsed: timeUsed,
                    currentPage: '2501'
                });
                
                // 更新显示
                document.getElementById('correct-rate').textContent = `${correctRate}%`;
                document.getElementById('time-used').textContent = timeUsedStr;
                document.getElementById('total-score').textContent = totalScore;
            }
            
            // 监听玩家数据变化
            database.ref(`rooms/${gameState.roomId}/players`).on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const playerCount = Object.keys(players).length;
                
                // 更新房间人数
                document.getElementById('player-count').textContent = playerCount;
                
                // 准备排名数据
                const rankingData = [];
                for (const [id, player] of Object.entries(players)) {
                    rankingData.push({
                        id: id,
                        name: player.name,
                        score: player.score || 0,
                        correctRate: player.correctRate || '0.0',
                        progress: player.progress || 0,
                        timeUsed: player.timeUsed || 0
                    });
                }
                
                // 按分数排序
                rankingData.sort((a, b) => b.score - a.score);
                
                // 更新排名表
                const tableBody = document.querySelector('#ranking-table tbody');
                tableBody.innerHTML = '';
                
                rankingData.slice(0, 10).forEach((player, index) => {
                    const row = document.createElement('tr');
                    
                    // 如果是当前玩家，高亮显示
                    if (player.id === gameState.playerId) {
                        row.classList.add('current-player');
                    }
                    
                    // 计算用时(分钟:秒)
                    const minutes = Math.floor(player.timeUsed / 60);
                    const seconds = player.timeUsed % 60;
                    const timeUsedStr = `${minutes}分${seconds}秒`;
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td>${player.score}</td>
                        <td>${player.correctRate}%</td>
                        <td>${player.progress}%</td>
                    `;
                    tableBody.appendChild(row);
                });
            });
        }
        
        // 显示提示框
        function showAlert(message, duration = 3000) {
            const alertBox = document.createElement('div');
            alertBox.className = 'alert-box';
            alertBox.textContent = message;
            document.body.appendChild(alertBox);
            
            setTimeout(() => {
                alertBox.remove();
            }, duration);
        }
        
        // 处理按钮点击
        function handleButtonClick(button) {
            const pageId = button.closest('.game-page').id.replace('page-', '');
            const buttonId = `${pageId}-${button.textContent}`;
            
            // 防止重复点击
            if (gameState.clickedButtons.has(buttonId)) return;
            gameState.clickedButtons.add(buttonId);
            
            // 禁用按钮
            button.disabled = true;
            
            // 如果是答题按钮，更新分数
            const isCorrect = button.getAttribute('data-correct') === 'true';
            const nextPageId = button.getAttribute('data-next');
            
            if (isCorrect !== null) {
                if (isCorrect) {
                    gameState.score += 6.7;
                    gameState.correctAnswers++;
                } else {
                    const hint = button.getAttribute('data-hint') || '请选择正确的时态';
                    showAlert(hint);
                }
                
                // 更新玩家进度
                updatePlayerProgress();
            }
            
            // 预加载下一张图片
            preloadNextImage(nextPageId);
            
            // 延迟跳转，让用户看到反馈
            setTimeout(() => {
                showPage(nextPageId);
            }, isCorrect === false ? 3000 : 100);
        }
        
        // 初始化游戏
        function initGame() {
            // 如果是老师，直接显示排名页面
            if (gameState.isTeacher) {
                showPage('2501');
                return;
            }
            
            // 否则从第一页开始
            showPage('2101');
            
            // 为所有按钮添加点击事件
            document.querySelectorAll('.game-button').forEach(button => {
                button.addEventListener('click', () => handleButtonClick(button));
            });
        }
        
        // 页面加载完成后初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
