<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法游戏 - 章节</title>
    <link rel="stylesheet" href="style.css">
    <!-- 引入Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- 章节1 -->
        <!-- 画面01 -->
        <div id="page-2101" class="game-page">
            <img src="images/画面01.jpg" alt="画面01" class="game-image">
            <div class="text-box">
                <p>主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2102">打扫</button>
                <button class="game-button wrong-btn" data-hint="日常行为用一般现在时" data-next="2102">正在打扫</button>
            </div>
        </div>

        <!-- 画面02 -->
        <div id="page-2102" class="game-page">
            <img src="images/画面02.jpg" alt="画面02" class="game-image">
            <div class="text-box">
                <p>有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2103">锁上</button>
                <button class="game-button wrong-btn" data-hint="描述昨天发生的简单行为用一般过去时" data-next="2103">正在锁上</button>
            </div>
        </div>

        <!-- 画面03 -->
        <div id="page-2103" class="game-page">
            <img src="images/画面03.jpg" alt="画面03" class="game-image">
            <div class="text-box">
                <p>Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着"时态魔法棒"。</p>
            </div>
            <div class="button-container">
                <button class="game-button single-btn" data-next="2104">继续</button>
            </div>
        </div>

        <!-- 画面04 -->
        <div id="page-2104" class="game-page">
            <img src="images/画面04.jpg" alt="画面04" class="game-image">
            <div class="text-box">
                <p>Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2201">将去</button>
                <button class="game-button wrong-btn" data-hint="描述未来发生的简单行为用一般将来时" data-next="2201">已经去</button>
            </div>
        </div>

        <!-- 章节2 -->
        <!-- 画面05 -->
        <div id="page-2201" class="game-page">
            <img src="images/画面05.jpg" alt="画面05" class="game-image">
            <div class="text-box">
                <p>时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2202">正在骑</button>
                <button class="game-button wrong-btn" data-hint="描述正在进行的行为用现在进行时" data-next="2202">已经骑</button>
            </div>
        </div>

        <!-- 画面06 -->
        <div id="page-2202" class="game-page">
            <img src="images/画面06.jpg" alt="画面06" class="game-image">
            <div class="text-box">
                <p>昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2203">正在打扫</button>
                <button class="game-button wrong-btn" data-hint="描述过去正在进行的行为用过去进行时" data-next="2203">已经打扫</button>
            </div>
        </div>

        <!-- 画面07 -->
        <div id="page-2203" class="game-page">
            <img src="images/画面07.jpg" alt="画面07" class="game-image">
            <div class="text-box">
                <p>为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2301">打扫</button>
                <button class="game-button wrong-btn" data-hint="描述将来正在进行的行为用将来进行时" data-next="2301">已经打扫</button>
            </div>
        </div>

        <!-- 章节3 -->
        <!-- 画面08 -->
        <div id="page-2301" class="game-page">
            <img src="images/画面08.jpg" alt="画面08" class="game-image">
            <div class="text-box">
                <p>Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫"时态"，难道启动它的咒语和时态有关？</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2302">拿出</button>
                <button class="game-button wrong-btn" data-hint="描述日常行为一般现在时" data-next="2302">已经拿出</button>
            </div>
        </div>

        <!-- 画面09 -->
        <div id="page-2302" class="game-page">
            <img src="images/画面09.jpg" alt="画面09" class="game-image">
            <div class="text-box">
                <p>于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼____了【现在完成】"</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2303">已经被烤熟</button>
                <button class="game-button wrong-btn" data-hint="咒语未生效，Tom重新念了一条香喷喷的鱼已经被烤熟了" data-next="2303">将来被烤熟</button>
            </div>
        </div>

        <!-- 画面10 -->
        <div id="page-2303" class="game-page">
            <img src="images/画面10.jpg" alt="画面10" class="game-image">
            <div class="text-box">
                <p>只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。</p>
            </div>
            <div class="button-container">
                <button class="game-button single-btn" data-next="2304">继续</button>
            </div>
        </div>

        <!-- 画面11 -->
        <div id="page-2304" class="game-page">
            <img src="images/画面11.jpg" alt="画面11" class="game-image">
            <div class="text-box">
                <p>Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2305">已经烤好的鱼</button>
                <button class="game-button wrong-btn" data-hint="描述已经完成的的行为用现在完成时" data-next="2305">将要烤好</button>
            </div>
        </div>

        <!-- 画面12 -->
        <div id="page-2305" class="game-page">
            <img src="images/画面12.jpg" alt="画面12" class="game-image">
            <div class="text-box">
                <p>Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2401">将会被打败</button>
                <button class="game-button wrong-btn" data-hint="描述将来完成的的行为用将来完成时" data-next="2401">已经被打败</button>
            </div>
        </div>

        <!-- 章节4 -->
        <!-- 画面13 -->
        <div id="page-2401" class="game-page">
            <img src="images/画面13.jpg" alt="画面13" class="game-image">
            <div class="text-box">
                <p>虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2402">学习了</button>
                <button class="game-button wrong-btn" data-hint="描述过去的行为持续到现在用现在完成进行" data-next="2402">将学习</button>
            </div>
        </div>

        <!-- 画面14 -->
        <div id="page-2402" class="game-page">
            <img src="images/画面14.jpg" alt="画面14" class="game-image">
            <div class="text-box">
                <p>Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2403">可以用</button>
                <button class="game-button wrong-btn" data-hint="描述正在进行的行为用现在进行时" data-next="2403">正在用</button>
            </div>
        </div>

        <!-- 画面15 -->
        <div id="page-2403" class="game-page">
            <img src="images/画面15.jpg" alt="画面15" class="game-image">
            <div class="text-box">
                <p>今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2404">输给</button>
                <button class="game-button wrong-btn" data-hint="描述正在进行的行为用现在进行时" data-next="2404">将输给</button>
            </div>
        </div>

        <!-- 画面16 -->
        <div id="page-2404" class="game-page">
            <img src="images/画面16.jpg" alt="画面16" class="game-image">
            <div class="text-box">
                <p>只见Tom用魔法棒指向天空，用咒语说了一句："It's going to rain soon"，魔法棒发出来蓝光。</p>
            </div>
            <div class="button-container">
                <button class="game-button single-btn" data-next="2405">继续</button>
            </div>
        </div>

        <!-- 画面17 -->
        <div id="page-2405" class="game-page">
            <img src="images/画面17.jpg" alt="画面17" class="game-image">
            <div class="text-box">
                <p>果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。</p>
            </div>
            <div class="button-container">
                <button class="game-button single-btn" data-next="2406">继续</button>
            </div>
        </div>

        <!-- 画面18 -->
        <div id="page-2406" class="game-page">
            <img src="images/画面18.jpg" alt="画面18" class="game-image">
            <div class="text-box">
                <p>Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2407">已经学了</button>
                <button class="game-button wrong-btn" data-hint="描述将来完成进行时" data-next="2407">将要学</button>
            </div>
        </div>

        <!-- 画面19 -->
        <div id="page-2407" class="game-page">
            <img src="images/画面19.jpg" alt="画面19" class="game-image">
            <div class="text-box">
                <p>Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。</p>
            </div>
            <div class="button-container">
                <button class="game-button single-btn" data-next="2408">继续</button>
            </div>
        </div>

        <!-- 画面20 -->
        <div id="page-2408" class="game-page">
            <img src="images/画面20.jpg" alt="画面20" class="game-image">
            <div class="text-box">
                <p>馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。</p>
            </div>
            <div class="button-container">
                <button class="game-button correct-btn" data-next="2409">找了</button>
                <button class="game-button wrong-btn" data-hint="描述过去完成" data-next="2409">将找</button>
            </div>
        </div>

        <!-- 画面21 -->
        <div id="page-2409" class="game-page">
            <img src="images/画面21.jpg" alt="画面21" class="game-image">
            <div class="text-box">
                <p>Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....</p>
            </div>
            <div class="button-container">
                <button class="game-button single-btn" data-next="2401">游戏结束</button>
            </div>
        </div>

        <!-- 画面22 - 游戏结果 -->
        <div id="page-2401-result" class="game-page">
            <div class="result-container">
                <h2>游戏结果</h2>
                <div class="result-item">
                    <span>正确率:</span>
                    <span id="accuracy">0%</span>
                </div>
                <div class="result-item">
                    <span>用时:</span>
                    <span id="time-used">0分0秒</span>
                </div>
                <div class="result-item">
                    <span>得分:</span>
                    <span id="total-score">0</span>
                </div>
                
                <h3>房间排名</h3>
                <div id="ranking-list" class="ranking-list">
                    <!-- 排名列表将在这里动态生成 -->
                </div>
                
                <button id="restart-btn" class="game-button">返回首页</button>
            </div>
        </div>

        <!-- 提示框 -->
        <div id="hint-modal" class="modal">
            <div class="modal-content">
                <p id="hint-message"></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 解析URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isHost = urlParams.get('host') === 'true';

        // 游戏状态
        let gameState = {
            currentPage: '2101', // 默认从第一关开始
            score: 0,
            correctAnswers: 0,
            startTime: null,
            endTime: null,
            totalQuestions: 15, // 总题数
            questionPoints: 6.7, // 每题分数
            roomCode: roomCode,
            playerId: playerId,
            isHost: isHost,
            playerName: `玩家${Math.floor(Math.random() * 1000)}`,
            buttonClicked: false // 防止重复点击
        };

        // 显示页面
        function showPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.game-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示指定页面
            const page = document.getElementById(`page-${pageId}`);
            if (page) {
                page.classList.add('active');
                gameState.currentPage = pageId;
                
                // 更新Firebase中的进度
                updatePlayerProgress(pageId);
                
                // 如果是结果页面，计算并显示结果
                if (pageId === '2401-result') {
                    showGameResults();
                }
                
                // 预加载下一张图片
                preloadNextImage(pageId);
            }
        }

        // 预加载下一张图片
        function preloadNextImage(currentPageId) {
            const pageOrder = [
                '2101', '2102', '2103', '2104', 
                '2201', '2202', '2203', 
                '2301', '2302', '2303', '2304', '2305', 
                '2401', '2402', '2403', '2404', '2405', '2406', '2407', '2408', '2409'
            ];
            
            const currentIndex = pageOrder.indexOf(currentPageId);
            if (currentIndex !== -1 && currentIndex < pageOrder.length - 1) {
                const nextPageId = pageOrder[currentIndex + 1];
                const nextImage = new Image();
                nextImage.src = `images/画面${nextPageId.substring(1)}.jpg`;
            }
        }

        // 显示提示信息
        function showHint(message, duration = 3000) {
            const hintModal = document.getElementById('hint-modal');
            document.getElementById('hint-message').textContent = message;
            hintModal.style.display = 'flex';
            
            setTimeout(() => {
                hintModal.style.display = 'none';
            }, duration);
        }

        // 更新玩家进度到Firebase
        function updatePlayerProgress(pageId) {
            if (!gameState.roomCode || !gameState.playerId) return;
            
            // 计算当前得分
            const playerRef = database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}`);
            
            playerRef.update({
                progress: pageId,
                score: gameState.score,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            }).catch(error => {
                console.error("更新玩家进度时出错:", error);
            });
        }

        // 计算游戏结果
        function calculateGameResults() {
            // 计算用时
            const timeElapsed = Math.floor((gameState.endTime - gameState.startTime) / 1000);
            const minutes = Math.floor(timeElapsed / 60);
            const seconds = timeElapsed % 60;
            
            // 计算时间分数 (每分钟2分，不满1分钟1分)
            const timeScore = minutes * 2 + (seconds > 0 ? 1 : 0);
            
            // 计算总分数
            const totalScore = Math.floor(gameState.score + timeScore);
            
            // 计算正确率
            const accuracy = (gameState.correctAnswers / gameState.totalQuestions * 100).toFixed(1);
            
            return {
                timeUsed: `${minutes}分${seconds}秒`,
                accuracy: `${accuracy}%`,
                totalScore: totalScore,
                correctAnswers: gameState.correctAnswers,
                timeElapsed: timeElapsed
            };
        }

        // 显示游戏结果
        function showGameResults() {
            const results = calculateGameResults();
            
            document.getElementById('accuracy').textContent = results.accuracy;
            document.getElementById('time-used').textContent = results.timeUsed;
            document.getElementById('total-score').textContent = results.totalScore;
            
            // 更新Firebase中的最终得分
            updateFinalScore(results.totalScore);
            
            // 获取房间排名
            getRoomRanking();
        }

        // 更新最终得分到Firebase
        function updateFinalScore(score) {
            if (!gameState.roomCode || !gameState.playerId) return;
            
            const playerRef = database.ref(`rooms/${gameState.roomCode}/players/${gameState.playerId}`);
            
            playerRef.update({
                score: score,
                completed: true,
                completedAt: firebase.database.ServerValue.TIMESTAMP,
                timeElapsed: Math.floor((gameState.endTime - gameState.startTime) / 1000)
            }).catch(error => {
                console.error("更新最终得分时出错:", error);
            });
        }

        // 获取房间排名
        function getRoomRanking() {
            if (!gameState.roomCode) return;
            
            const playersRef = database.ref(`rooms/${gameState.roomCode}/players`);
            
            playersRef.once('value').then(snapshot => {
                const players = snapshot.val() || {};
                const playersArray = [];
                
                // 转换为数组
                for (const playerId in players) {
                    if (players[playerId].completed) {
                        playersArray.push({
                            id: playerId,
                            name: players[playerId].name || `玩家${playerId.substring(7, 10)}`,
                            score: players[playerId].score || 0,
                            time: players[playerId].timeElapsed || 0
                        });
                    }
                }
                
                // 排序: 按分数降序，分数相同按用时升序
                playersArray.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    } else {
                        return a.time - b.time;
                    }
                });
                
                // 显示前10名
                displayRanking(playersArray.slice(0, 10));
            }).catch(error => {
                console.error("获取房间排名时出错:", error);
            });
        }

        // 显示排名
        function displayRanking(players) {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';
            
            if (players.length === 0) {
                rankingList.innerHTML = '<p>暂无排名数据</p>';
                return;
            }
            
            players.forEach((player, index) => {
                const rankItem = document.createElement('div');
                rankItem.className = 'rank-item';
                
                // 高亮显示当前玩家
                if (player.id === gameState.playerId) {
                    rankItem.classList.add('current-player');
                }
                
                rankItem.innerHTML = `
                    <span class="rank-position">${index + 1}</span>
                    <span class="rank-name">${player.name}</span>
                    <span class="rank-score">${player.score}分</span>
                `;
                
                rankingList.appendChild(rankItem);
            });
        }

        // 初始化游戏
        function initGame() {
            // 设置开始时间
            gameState.startTime = new Date().getTime();
            
            // 显示第一页
            showPage('2101');
            
            // 添加按钮事件监听器
            document.querySelectorAll('.game-button').forEach(button => {
                button.addEventListener('click', function() {
                    // 防止重复点击
                    if (gameState.buttonClicked) return;
                    gameState.buttonClicked = true;
                    
                    setTimeout(() => {
                        gameState.buttonClicked = false;
                    }, 1000);
                    
                    // 处理正确按钮点击
                    if (this.classList.contains('correct-btn')) {
                        gameState.score += gameState.questionPoints;
                        gameState.correctAnswers++;
                    }
                    
                    // 处理错误按钮点击 (显示提示)
                    if (this.classList.contains('wrong-btn')) {
                        const hint = this.getAttribute('data-hint');
                        if (hint) {
                            showHint(hint);
                        }
                    }
                    
                    // 获取下一个页面ID
                    const nextPage = this.getAttribute('data-next');
                    
                    // 如果是最后一题，记录结束时间
                    if (nextPage === '2401-result') {
                        gameState.endTime = new Date().getTime();
                    }
                    
                    // 跳转到下一个页面
                    if (nextPage) {
                        showPage(nextPage);
                    }
                });
            });
            
            // 返回首页按钮
            document.getElementById('restart-btn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        }

        // DOM加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            initGame();
            
            // 预加载第一张图片
            const firstImage = new Image();
            firstImage.src = 'images/画面01.jpg';
        });
    </script>
</body>
</html>
