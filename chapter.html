<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法棒 - 游戏章节</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- 所有游戏页面将在这里动态生成 -->
    </div>

    <!-- 提示框容器 -->
    <div id="alert-container" class="alert-hidden"></div>

    <script>
        // 初始化Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const playerName = urlParams.get('player') ? decodeURIComponent(urlParams.get('player')) : null;
        const isTeacher = urlParams.get('teacher') === 'true';
        
        // 游戏状态变量
        let currentPageId = isTeacher ? '2501' : '2101'; // 老师直接看排名，玩家从第一页开始
        let score = 0;
        let correctAnswers = 0;
        let startTime = Date.now();
        let gameData = {};
        let clickedButtons = {}; // 记录已点击的按钮
        
        // 预加载下一张图片
        let nextImageToPreload = null;
        
        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const alertContainer = document.getElementById('alert-container');
        
        // 页面数据
        const pages = {
            // 章节1
            '2101': {
                image: '画面01.jpg',
                text: '主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。',
                buttons: [
                    { text: '打扫', position: 'left', correct: true, nextPage: '2102', hint: '' },
                    { text: '正在打扫', position: 'right', correct: false, nextPage: '2102', hint: '日常行为用一般现在时' }
                ]
            },
            '2102': {
                image: '画面02.jpg',
                text: '有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。',
                buttons: [
                    { text: '锁上', position: 'left', correct: true, nextPage: '2103', hint: '' },
                    { text: '正在锁上', position: 'right', correct: false, nextPage: '2103', hint: '描述昨天发生的简单行为用一般过去时' }
                ]
            },
            '2103': {
                image: '画面03.jpg',
                text: 'Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着：时态魔法棒。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2104', hint: '' }
                ]
            },
            '2104': {
                image: '画面04.jpg',
                text: 'Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。',
                buttons: [
                    { text: '将去', position: 'left', correct: true, nextPage: '2201', hint: '' },
                    { text: '已经去', position: 'right', correct: false, nextPage: '2201', hint: '描述未来发生的简单行为用一般将来时' }
                ]
            },
            // 章节2
            '2201': {
                image: '画面05.jpg',
                text: '时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。',
                buttons: [
                    { text: '正在骑', position: 'left', correct: true, nextPage: '2202', hint: '' },
                    { text: '已经骑', position: 'right', correct: false, nextPage: '2202', hint: '描述正在进行的行为用现在进行时' }
                ]
            },
            '2202': {
                image: '画面06.jpg',
                text: '昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。',
                buttons: [
                    { text: '正在打扫', position: 'left', correct: true, nextPage: '2203', hint: '' },
                    { text: '已经打扫', position: 'right', correct: false, nextPage: '2203', hint: '描述过去正在进行的行为用过去进行时' }
                ]
            },
            '2203': {
                image: '画面07.jpg',
                text: '为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。',
                buttons: [
                    { text: '打扫', position: 'left', correct: true, nextPage: '2301', hint: '' },
                    { text: '已经打扫', position: 'right', correct: false, nextPage: '2301', hint: '描述将来正在进行的行为用将来进行时' }
                ]
            },
            // 章节3
            '2301': {
                image: '画面08.jpg',
                text: 'Tom停在了森林里的小溪旁边，然后从衣服里___魔法棒。他想，这魔法棒叫时态魔法棒，难道启动它的咒语和时态有关？',
                buttons: [
                    { text: '拿出', position: 'left', correct: true, nextPage: '2302', hint: '' },
                    { text: '已经拿出', position: 'right', correct: false, nextPage: '2302', hint: '描述日常行为一般现在时' }
                ]
            },
            '2302': {
                image: '画面09.jpg',
                text: '于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句一条香喷喷的鱼____了',
                buttons: [
                    { text: '已经被烤熟', position: 'left', correct: true, nextPage: '2304', hint: '' },
                    { text: '将来被烤熟', position: 'right', correct: false, nextPage: '2304', hint: '咒语未生效，Tom重新念了一条香喷喷的鱼已经被烤熟了' }
                ]
            },
            '2303': {
                image: '画面10.jpg',
                text: '只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2304', hint: '' }
                ]
            },
            '2304': {
                image: '画面11.jpg',
                text: 'Tom想，我来这之前，还没吃东西呢。正好可以包餐一顿。Tom拿起吃了起来。',
                buttons: [
                    { text: '已经烤好的鱼', position: 'left', correct: true, nextPage: '2305', hint: '' },
                    { text: '将要烤好', position: 'right', correct: false, nextPage: '2305', hint: '描述已经完成的的行为用现在完成时' }
                ]
            },
            '2305': {
                image: '画面12.jpg',
                text: 'Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）',
                buttons: [
                    { text: '将会被打败', position: 'left', correct: true, nextPage: '2401', hint: '' },
                    { text: '已经被打败', position: 'right', correct: false, nextPage: '2401', hint: '描述将来完成的的行为用将来完成时' }
                ]
            },
            // 章节4
            '2401': {
                image: '画面13.jpg',
                text: '虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。',
                buttons: [
                    { text: '学习了', position: 'left', correct: true, nextPage: '2402', hint: '' },
                    { text: '将学习', position: 'right', correct: false, nextPage: '2402', hint: '描述过去的行为持续到现在用现在完成进行' }
                ]
            },
            '2402': {
                image: '画面14.jpg',
                text: 'Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说Mike，现在我_____魔法打败你了，你出来接受我的挑战吧',
                buttons: [
                    { text: '可以用', position: 'left', correct: true, nextPage: '2403', hint: '' },
                    { text: '正在用', position: 'right', correct: false, nextPage: '2403', hint: '描述正在进行的行为用现在进行时' }
                ]
            },
            '2403': {
                image: '画面15.jpg',
                text: '今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了。（You had been repeatedly losing to me over the past year.）还是不服输吗"',
                buttons: [
                    { text: '输给', position: 'left', correct: true, nextPage: '2404', hint: '' },
                    { text: '将输给', position: 'right', correct: false, nextPage: '2404', hint: '描述正在进行的行为用现在进行时' }
                ]
            },
            '2404': {
                image: '画面16.jpg',
                text: '只见Tom用魔法棒指向天空，用咒语说了一句It\'s going to rain soon，魔法棒发出来蓝光。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2405', hint: '' }
                ]
            },
            '2405': {
                image: '画面17.jpg',
                text: '果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2406', hint: '' }
                ]
            },
            '2406': {
                image: '画面18.jpg',
                text: 'Mike看见后下了一跳，说到到明天为止，我已经学了魔法2年了（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了',
                buttons: [
                    { text: '已经学了', position: 'left', correct: true, nextPage: '2407', hint: '' },
                    { text: '将要学', position: 'right', correct: false, nextPage: '2407', hint: '描述将来完成进行时' }
                ]
            },
            '2407': {
                image: '画面19.jpg',
                text: 'Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextPage: '2408', hint: '' }
                ]
            },
            '2408': {
                image: '画面20.jpg',
                text: '馆长说到Tom，我找了它找了一整天，原来被你拿走了。',
                buttons: [
                    { text: '找了', position: 'left', correct: true, nextPage: '2409', hint: '' },
                    { text: '将找', position: 'right', correct: false, nextPage: '2409', hint: '描述过去完成' }
                ]
            },
            '2409': {
                image: '画面21.jpg',
                text: 'Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道:赶紧回去给我打扫图书馆.....',
                buttons: [
                    { text: '游戏结束', position: 'center', correct: null, nextPage: '2501', hint: '' }
                ]
            },
            // 排名画面
            '2501': {
                image: null,
                text: '',
                buttons: []
            }
        };
        
        // 初始化游戏
        function initGame() {
            if (isTeacher) {
                // 老师直接显示排名
                showRankingPage();
                listenForPlayerUpdates();
            } else {
                // 玩家显示当前页面
                showPage(currentPageId);
                
                // 开始计时
                startTime = Date.now();
                
                // 监听游戏结束事件
                window.addEventListener('beforeunload', () => {
                    if (currentPageId !== '2501') {
                        // 玩家中途退出，更新状态
                        updatePlayerStatus('quit');
                    }
                });
            }
        }
        
        // 显示指定页面
        function showPage(pageId) {
            // 清除已点击按钮记录
            clickedButtons = {};
            
            // 更新当前页面ID
            currentPageId = pageId;
            
            // 计算进度 (1-21页对应5%-100%)
            const progress = Math.round((parseInt(pageId.substring(1)) - 100) / 21 * 100);
            
            // 更新玩家进度
            if (playerName && !isTeacher) {
                updatePlayerProgress(progress);
            }
            
            // 如果是排名页面，特殊处理
            if (pageId === '2501') {
                showRankingPage();
                return;
            }
            
            // 获取页面数据
            const page = pages[pageId];
            if (!page) {
                console.error('无效的页面ID:', pageId);
                return;
            }
            
            // 预加载下一张图片
            preloadNextImage(pageId);
            
            // 创建页面HTML
            let html = `<div id="page-${pageId}" class="game-page active">`;
            
            // 添加图片
            if (page.image) {
                html += `<img src="images/${page.image}" alt="游戏画面" class="game-image">`;
            }
            
            // 添加文本
            html += `<div class="game-text">${page.text}</div>`;
            
            // 添加按钮容器
            html += '<div class="button-container">';
            
            // 添加按钮
            page.buttons.forEach((btn, index) => {
                const buttonId = `btn-${pageId}-${index}`;
                const positionClass = btn.position === 'left' ? 'left-button' : btn.position === 'right' ? 'right-button' : 'center-button';
                
                html += `<button id="${buttonId}" class="game-button ${positionClass}">${btn.text}</button>`;
            });
            
            html += '</div></div>';
            
            // 更新游戏容器
            gameContainer.innerHTML = html;
            
            // 添加按钮事件
            page.buttons.forEach((btn, index) => {
                const buttonId = `btn-${pageId}-${index}`;
                const button = document.getElementById(buttonId);
                
                if (button) {
                    button.addEventListener('click', () => {
                        // 防止重复点击
                        if (clickedButtons[buttonId]) return;
                        clickedButtons[buttonId] = true;
                        
                        // 处理按钮点击
                        handleButtonClick(btn, pageId);
                    });
                }
            });
            
            // 添加淡入效果
            setTimeout(() => {
                const pageElement = document.getElementById(`page-${pageId}`);
                if (pageElement) {
                    pageElement.classList.add('fade-in');
                }
            }, 10);
        }
        
        // 处理按钮点击
        function handleButtonClick(button, currentPageId) {
            // 如果是正确答案，增加分数
            if (button.correct === true) {
                score += 6.7;
                correctAnswers++;
                
                // 更新玩家分数
                if (playerName && !isTeacher) {
                    updatePlayerScore(score, correctAnswers);
                }
            }
            
            // 显示提示信息
            if (button.hint) {
                showAlert(button.hint, 3000);
            }
            
            // 跳转到下一页
            if (button.nextPage) {
                // 添加淡出效果
                const currentPage = document.getElementById(`page-${currentPageId}`);
                if (currentPage) {
                    currentPage.classList.add('fade-out');
                }
                
                // 延迟跳转以显示动画
                setTimeout(() => {
                    showPage(button.nextPage);
                }, 500);
            }
        }
        
        // 预加载下一张图片
        function preloadNextImage(currentPageId) {
            // 取消之前的预加载
            if (nextImageToPreload) {
                nextImageToPreload.onload = null;
                nextImageToPreload = null;
            }
            
            // 获取当前页面索引
            const currentPageNum = parseInt(currentPageId.substring(1));
            const nextPageNum = currentPageNum + 1;
            const nextPageId = '2' + nextPageNum.toString().padStart(3, '0');
            
            // 检查下一页是否存在且有图片
            if (pages[nextPageId] && pages[nextPageId].image) {
                nextImageToPreload = new Image();
                nextImageToPreload.src = 'images/' + pages[nextPageId].image;
            }
        }
        
        // 显示排名页面
        function showRankingPage() {
            // 如果是玩家且第一次到达排名页面，计算最终分数
            if (playerName && !isTeacher && currentPageId === '2501') {
                calculateFinalScore();
            }
            
            // 创建排名页面HTML
            let html = `<div id="page-2501" class="game-page active ranking-page">`;
            html += `<h2>房间号: ${roomId}</h2>`;
            html += `<div id="player-count">玩家人数: 加载中...</div>`;
            html += `<div class="ranking-table-container">`;
            html += `<table class="ranking-table">`;
            html += `<thead><tr><th>名称</th><th>总分数</th><th>正确率</th><th>用时</th></tr></thead>`;
            html += `<tbody id="ranking-body"></tbody>`;
            html += `</table></div></div>`;
            
            // 更新游戏容器
            gameContainer.innerHTML = html;
            
            // 添加淡入效果
            setTimeout(() => {
                const pageElement = document.getElementById('page-2501');
                if (pageElement) {
                    pageElement.classList.add('fade-in');
                }
            }, 10);
            
            // 加载排名数据
            loadRankingData();
        }
        
        // 加载排名数据
        function loadRankingData() {
            if (!roomId) return;
            
            database.ref('rooms/' + roomId + '/players').orderByChild('score').limitToLast(10).once('value')
                .then((snapshot) => {
                    const players = [];
                    snapshot.forEach((childSnapshot) => {
                        const player = childSnapshot.val();
                        players.push(player);
                    });
                    
                    // 按分数降序排序
                    players.sort((a, b) => b.score - a.score);
                    
                    // 更新玩家数量 (排除老师)
                    const playerCount = players.filter(p => p.status !== 'teacher').length;
                    document.getElementById('player-count').textContent = `玩家人数: ${playerCount}`;
                    
                    // 更新排名表
                    const tbody = document.getElementById('ranking-body');
                    tbody.innerHTML = '';
                    
                    players.forEach((player, index) => {
                        if (player.status === 'teacher') return;
                        
                        const row = document.createElement('tr');
                        if (player.name === playerName) {
                            row.classList.add('highlight-player');
                        }
                        
                        // 计算正确率
                        const accuracy = player.correctAnswers ? (player.correctAnswers / 15 * 100).toFixed(1) + '%' : '0%';
                        
                        // 计算用时 (分钟:秒)
                        const timePlayed = player.endTime ? player.endTime - player.joinTime : 0;
                        const minutes = Math.floor(timePlayed / 60000);
                        const seconds = Math.floor((timePlayed % 60000) / 1000);
                        const timeStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                        
                        row.innerHTML = `
                            <td>${player.name}</td>
                            <td>${Math.round(player.score)}</td>
                            <td>${accuracy}</td>
                            <td>${timeStr}</td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                })
                .catch((error) => {
                    console.error('加载排名数据时出错:', error);
                });
        }
        
        // 监听玩家更新
        function listenForPlayerUpdates() {
            if (!roomId) return;
            
            database.ref('rooms/' + roomId + '/players').on('value', (snapshot) => {
                loadRankingData();
            });
        }
        
        // 更新玩家分数
        function updatePlayerScore(newScore, newCorrectAnswers) {
            if (!roomId || !playerName) return;
            
            const updates = {
                score: newScore,
                correctAnswers: newCorrectAnswers
            };
            
            database.ref('rooms/' + roomId + '/players/' + playerName).update(updates)
                .catch((error) => {
                    console.error('更新玩家分数时出错:', error);
                });
        }
        
        // 更新玩家进度
        function updatePlayerProgress(progress) {
            if (!roomId || !playerName) return;
            
            database.ref('rooms/' + roomId + '/players/' + playerName).update({
                progress: progress
            })
            .catch((error) => {
                console.error('更新玩家进度时出错:', error);
            });
        }
        
        // 更新玩家状态
        function updatePlayerStatus(status) {
            if (!roomId || !playerName) return;
            
            const updates = {
                status: status,
                endTime: Date.now()
            };
            
            database.ref('rooms/' + roomId + '/players/' + playerName).update(updates)
                .catch((error) => {
                    console.error('更新玩家状态时出错:', error);
                });
        }
        
        // 计算最终分数
        function calculateFinalScore() {
            // 计算时间分数
            const endTime = Date.now();
            const timePlayed = endTime - startTime; // 毫秒
            const minutesPlayed = Math.floor(timePlayed / 60000);
            const timeScore = minutesPlayed * 2 + (timePlayed % 60000 > 0 ? 1 : 0);
            
            // 计算总分数
            let totalScore = score - timeScore;
            totalScore = Math.max(0, Math.min(100, Math.round(totalScore)));
            
            // 更新玩家状态
            updatePlayerStatus('completed');
            
            // 更新最终分数
            database.ref('rooms/' + roomId + '/players/' + playerName).update({
                score: totalScore,
                endTime: endTime,
                status: 'completed'
            })
            .catch((error) => {
                console.error('更新最终分数时出错:', error);
            });
        }
        
        // 显示提示框
        function showAlert(message, duration = 3000) {
            alertContainer.textContent = message;
            alertContainer.classList.remove('alert-hidden');
            alertContainer.classList.add('alert-visible');
            
            if (duration > 0) {
                setTimeout(() => {
                    alertContainer.classList.remove('alert-visible');
                    alertContainer.classList.add('alert-hidden');
                }, duration);
            }
        }
        
        // 隐藏提示框
        function hideAlert() {
            alertContainer.classList.remove('alert-visible');
            alertContainer.classList.add('alert-hidden');
        }
        
        // 初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
