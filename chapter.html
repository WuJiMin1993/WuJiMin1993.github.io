<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game - Chapters</title>
    <link href="https://fonts.googleapis.com/css2?family=Microsoft+YaHei&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
</head>
<body>
    <!-- Game screens container -->
    <div id="game-container">
        <!-- All chapter screens will be dynamically loaded here -->
    </div>

    <!-- Leaderboard screen -->
    <div id="leaderboard-screen" class="screen">
        <div class="leaderboard-container">
            <h2 id="room-number-display"></h2>
            <p id="player-count"></p>
            <table id="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Leaderboard data will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Message box for feedback -->
    <div id="message-box" class="message-box hidden">
        <p id="message-text"></p>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>

    <!-- Game Logic -->
    <script>
        // Global variables
        let currentScreenId = '';
        let currentRoom = '';
        let playerId = '';
        let playerName = '';
        let isLeaderboard = false;
        let correctAnswers = 0;
        let gameStartTime = 0;
        let currentImage = '';
        let nextImage = '';
        
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentRoom = urlParams.get('room');
        playerId = urlParams.get('player');
        isLeaderboard = urlParams.has('leaderboard');
        
        // Initialize game
        document.addEventListener('DOMContentLoaded', () => {
            if (isLeaderboard) {
                showLeaderboard();
            } else {
                loadInitialScreen();
            }
        });
        
        // Load initial screen based on URL
        function loadInitialScreen() {
            // Get player data from Firebase
            database.ref('rooms/' + currentRoom + '/players/' + playerId).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const playerData = snapshot.val();
                        playerName = playerData.name;
                        gameStartTime = playerData.startTime || Date.now();
                        
                        // Start with screen 2101 (first question)
                        showScreen('2101');
                        
                        // Start game timer
                        updatePlayerStats();
                    } else {
                        console.error("Player data not found");
                        // Fallback to first screen
                        showScreen('2101');
                    }
                })
                .catch((error) => {
                    console.error("Error loading player data:", error);
                    // Fallback to first screen
                    showScreen('2101');
                });
        }
        
        // Show a specific screen
        function showScreen(screenId) {
            currentScreenId = screenId;
            
            // Clear previous screen
            document.getElementById('game-container').innerHTML = '';
            
            // Create new screen
            const screen = document.createElement('div');
            screen.className = 'screen active';
            screen.id = 'screen-' + screenId;
            
            // Add image
            const img = document.createElement('img');
            img.className = 'full-width-image';
            img.src = `images/画面${getImageNumber(screenId)}.jpg`;
            img.alt = `Screen ${screenId}`;
            screen.appendChild(img);
            
            // Add text content
            const textDiv = document.createElement('div');
            textDiv.className = 'text-content';
            textDiv.textContent = getScreenText(screenId);
            screen.appendChild(textDiv);
            
            // Add buttons
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'button-container';
            
            const buttons = getScreenButtons(screenId);
            buttons.forEach(button => {
                const btn = document.createElement('button');
                btn.className = 'blue-btn';
                btn.textContent = button.name;
                
                // Position button
                if (button.position === 'left') {
                    btn.style.float = 'left';
                } else if (button.position === 'right') {
                    btn.style.float = 'right';
                } else {
                    btn.style.margin = '0 auto';
                }
                
                // Add click handler
                btn.addEventListener('click', () => {
                    handleButtonClick(screenId, button);
                });
                
                buttonsDiv.appendChild(btn);
            });
            
            screen.appendChild(buttonsDiv);
            document.getElementById('game-container').appendChild(screen);
            
            // Update player progress
            updatePlayerProgress();
            
            // Preload next image
            preloadNextImage(screenId);
        }
        
        // Handle button clicks
        function handleButtonClick(screenId, button) {
            // Disable all buttons to prevent multiple clicks
            const buttons = document.querySelectorAll(`#screen-${screenId} .blue-btn`);
            buttons.forEach(btn => {
                btn.disabled = true;
            });
            
            // Check if answer is correct
            if (button.isCorrect) {
                correctAnswers++;
                updatePlayerScore();
            }
            
            // Show feedback if available
            if (button.feedback) {
                showMessage(button.feedback);
            }
            
            // Determine next screen
            let nextScreenId = getNextScreenId(screenId);
            
            // If this is the last screen, go to leaderboard
            if (screenId === '2409') {
                setTimeout(() => {
                    endGame();
                }, 3000);
            } else if (button.feedback) {
                // Wait for feedback to be shown before proceeding
                setTimeout(() => {
                    showScreen(nextScreenId);
                }, 3000);
            } else {
                // Proceed immediately
                showScreen(nextScreenId);
            }
        }
        
        // Show feedback message
        function showMessage(message) {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            
            // Center the message box
            messageBox.style.left = '50%';
            messageBox.style.top = '50%';
            messageBox.style.transform = 'translate(-50%, -50%)';
            
            // Hide after 3 seconds
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }
        
        // Update player score in Firebase
        function updatePlayerScore() {
            const score = Math.min(correctAnswers * 6.7, 100);
            database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                score: score
            });
        }
        
        // Update player progress in Firebase
        function updatePlayerProgress() {
            const progress = Math.floor((parseInt(currentScreenId.substring(1)) - 2000) / 21 * 100);
            database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                progress: progress
            });
        }
        
        // Update player stats (time spent, accuracy)
        function updatePlayerStats() {
            const timeSpent = Math.floor((Date.now() - gameStartTime) / 1000); // in seconds
            const accuracy = parseFloat((correctAnswers / 15 * 100).toFixed(1));
            
            database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                timeSpent: timeSpent,
                accuracy: accuracy
            });
            
            // Update every 10 seconds
            setTimeout(updatePlayerStats, 10000);
        }
        
        // End game and show leaderboard
        function endGame() {
            // Calculate final score
            const timeSpentMinutes = Math.floor((Date.now() - gameStartTime) / 60000);
            const timeScore = Math.min(timeSpentMinutes * 2, 120);
            const questionScore = correctAnswers * 6.7;
            const totalScore = Math.min(questionScore + timeScore, 100);
            const accuracy = parseFloat((correctAnswers / 15 * 100).toFixed(1));
            
            // Update final stats
            database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                score: totalScore,
                accuracy: accuracy,
                timeSpent: Math.floor((Date.now() - gameStartTime) / 1000),
                completed: true
            });
            
            // Show leaderboard
            showLeaderboard();
        }
        
        // Show leaderboard
        function showLeaderboard() {
            document.getElementById('game-container').classList.remove('active');
            document.getElementById('leaderboard-screen').classList.add('active');
            
            // Display room number
            document.getElementById('room-number-display').textContent = `Room: ${currentRoom}`;
            
            // Listen for player updates
            const playersRef = database.ref('rooms/' + currentRoom + '/players');
            playersRef.on('value', (snapshot) => {
                const players = [];
                snapshot.forEach((childSnapshot) => {
                    const player = childSnapshot.val();
                    if (!player.teacherId) { // Exclude teacher
                        players.push({
                            id: childSnapshot.key,
                            name: player.name,
                            score: player.score || 0,
                            accuracy: player.accuracy || 0,
                            timeSpent: player.timeSpent || 0,
                            isCurrentPlayer: childSnapshot.key === playerId
                        });
                    }
                });
                
                // Sort by score (descending)
                players.sort((a, b) => b.score - a.score);
                
                // Update player count
                document.getElementById('player-count').textContent = `Players: ${players.length}`;
                
                // Update leaderboard table
                const tbody = document.getElementById('leaderboard-body');
                tbody.innerHTML = '';
                
                // Show top 10 players
                players.slice(0, 10).forEach((player, index) => {
                    const row = document.createElement('tr');
                    if (player.isCurrentPlayer) {
                        row.classList.add('highlight');
                    }
                    
                    // Format time (minutes:seconds)
                    const minutes = Math.floor(player.timeSpent / 60);
                    const seconds = player.timeSpent % 60;
                    const timeString = `${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.name}</td>
                        <td>${Math.floor(player.score)}</td>
                        <td>${player.accuracy}%</td>
                        <td>${timeString}</td>
                    `;
                    
                    tbody.appendChild(row);
                });
            });
        }
        
        // Helper functions for screen data
        function getImageNumber(screenId) {
            const num = parseInt(screenId.substring(1));
            return num < 10 ? '0' + num : num;
        }
        
        function getScreenText(screenId) {
            // This would be replaced with actual screen text from your game flow
            const screenTexts = {
                '2101': 'Tom lives in a magical world and ____ the school library every day.',
                '2102': 'Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.',
                // Add all other screen texts here...
            };
            
            return screenTexts[screenId] || `Screen ${screenId} content`;
        }
        
        function getScreenButtons(screenId) {
            // This would be replaced with actual button data from your game flow
            const screenButtons = {
                '2101': [
                    { name: 'cleans', position: 'left', isCorrect: true, nextScreen: '2102' },
                    { name: 'cleaning', position: 'right', isCorrect: false, nextScreen: '2102', 
                      feedback: 'Daily behavior is expressed in the present tense' }
                ],
                '2102': [
                    { name: 'locked', position: 'left', isCorrect: true, nextScreen: '2103' },
                    { name: 'locks', position: 'right', isCorrect: false, nextScreen: '2103', 
                      feedback: 'Describe the simple behavior that occurred yesterday in the past simple tense' }
                ],
                // Add all other screen buttons here...
                '2409': [
                    { name: 'Game over', position: 'center', isCorrect: false, nextScreen: '2501' }
                ]
            };
            
            return screenButtons[screenId] || [{ name: 'Continue', position: 'center', isCorrect: false, nextScreen: '2501' }];
        }
        
        function getNextScreenId(currentScreenId) {
            const buttons = getScreenButtons(currentScreenId);
            return buttons[0].nextScreen;
        }
        
        // Preload next image
        function preloadNextImage(currentScreenId) {
            const nextScreenId = getNextScreenId(currentScreenId);
            if (nextScreenId) {
                const nextImageNumber = getImageNumber(nextScreenId);
                const img = new Image();
                img.src = `images/画面${nextImageNumber}.jpg`;
            }
        }
    </script>
</body>
</html>
