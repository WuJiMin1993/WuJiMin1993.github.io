<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- 所有章节页面 -->
        <!-- 章节1 -->
        <div id="page-2101" class="game-page">
            <img src="images/画面01.jpg" alt="画面01" class="game-image">
            <div class="text-container">
                <p>Tom lives in a magical world and ____ the school library every day.</p>
            </div>
            <div class="button-container">
                <button data-page="2102" data-correct="true" class="game-btn">cleans</button>
                <button data-page="2102" data-correct="false" class="game-btn">cleaning</button>
            </div>
            <div class="hint-text" style="display:none;">Daily behavior is expressed in the present tense</div>
        </div>

        <div id="page-2102" class="game-page">
            <img src="images/画面02.jpg" alt="画面02" class="game-image">
            <div class="text-container">
                <p>Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.</p>
            </div>
            <div class="button-container">
                <button data-page="2103" data-correct="true" class="game-btn">locked</button>
                <button data-page="2103" data-correct="false" class="game-btn">locks</button>
            </div>
            <div class="hint-text" style="display:none;">Describe the simple behavior that occurred yesterday in the past simple tense</div>
        </div>

        <div id="page-2103" class="game-page">
            <img src="images/画面03.jpg" alt="画面03" class="game-image">
            <div class="text-container">
                <p>Tom walked over curiously and saw a magic wand with a flashing blue light, with a label next to it that read: Tense Magic wand.</p>
            </div>
            <div class="button-container">
                <button data-page="2104" class="game-btn">continue</button>
            </div>
        </div>

        <div id="page-2104" class="game-page">
            <img src="images/画面04.jpg" alt="画面04" class="game-image">
            <div class="text-container">
                <p>Tom became curious and hid his magic wand in his clothes before taking it away from the library He ____ outdoors tomorrow to test the power of the magic wand.</p>
            </div>
            <div class="button-container">
                <button data-page="2201" data-correct="true" class="game-btn">will go</button>
                <button data-page="2201" data-correct="false" class="game-btn">is going</button>
            </div>
            <div class="hint-text" style="display:none;">Describe simple behaviors that will occur in the future using general future tense</div>
        </div>

        <!-- 章节2 -->
        <div id="page-2201" class="game-page">
            <img src="images/画面05.jpg" alt="画面05" class="game-image">
            <div class="text-container">
                <p>The next morning, he ____ a magic broom towards a forest next to the school.</p>
            </div>
            <div class="button-container">
                <button data-page="2202" data-correct="true" class="game-btn">is riding</button>
                <button data-page="2202" data-correct="false" class="game-btn">has ridden</button>
            </div>
            <div class="hint-text" style="display:none;">Describe the ongoing behavior in present continuous tense</div>
        </div>

        <div id="page-2202" class="game-page">
            <img src="images/画面06.jpg" alt="画面06" class="game-image">
            <div class="text-container">
                <p>At this time yesterday, Tom was cleaning the library. He was supposed to be organizing books in the library today, but he thought this magic wand would be fun. So I decided to slack off and not go to the library anymore.</p>
            </div>
            <div class="button-container">
                <button data-page="2203" data-correct="true" class="game-btn">was cleaning</button>
                <button data-page="2203" data-correct="false" class="game-btn">is cleaning</button>
            </div>
            <div class="hint-text" style="display:none;">描述过去正在进行的行为用过去进行时</div>
        </div>

        <div id="page-2203" class="game-page">
            <img src="images/画面07.jpg" alt="画面07" class="game-image">
            <div class="text-container">
                <p>Tom will be tidying up the library early tomorrow to prevent library director Jimmy from discovering his laziness.</p>
            </div>
            <div class="button-container">
                <button data-page="2301" data-correct="true" class="game-btn">will be tidying up</button>
                <button data-page="2301" data-correct="false" class="game-btn">is tidying up</button>
            </div>
            <div class="hint-text" style="display:none;">Describe the ongoing behavior in the future using future continuous tense</div>
        </div>

        <!-- 章节3 -->
        <div id="page-2301" class="game-page">
            <img src="images/画面08.jpg" alt="画面08" class="game-image">
            <div class="text-container">
                <p>Tom stops by the stream in the forest and ____ the magic wand from his clothes. He thought that the magic wand is called a tense magic wand. Is the spell that activates it related to tense?</p>
            </div>
            <div class="button-container">
                <button data-page="2302" data-correct="true" class="game-btn">takes out</button>
                <button data-page="2302" data-correct="false" class="game-btn">will take out</button>
            </div>
            <div class="hint-text" style="display:none;">Describe daily behavior in the present tense</div>
        </div>

        <div id="page-2302" class="game-page">
            <img src="images/画面09.jpg" alt="画面09" class="game-image">
            <div class="text-container">
                <p>So he decided to try combining the spells he learned at the magic school. Tom pointed his magic wand at the stream and said, 'A delicious fish ____.'</p>
            </div>
            <div class="button-container">
                <button data-page="2304" data-correct="true" class="game-btn">has been grilled</button>
                <button data-page="2304" data-correct="false" class="game-btn">will be grilled</button>
            </div>
            <div class="hint-text" style="display:none;">The spell didn't take effect, Tom recited a delicious fish that had already been grilled</div>
        </div>

        <div id="page-2303" class="game-page">
            <img src="images/画面10.jpg" alt="画面10" class="game-image">
            <div class="text-container">
                <p>After reciting the spell, a sudden blue flash appeared. Then a grill made of tree branches appeared in front of Tom, with a fragrant grilled fish on top.</p>
            </div>
            <div class="button-container">
                <button data-page="2304" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="page-2304" class="game-page">
            <img src="images/画面11.jpg" alt="画面11" class="game-image">
            <div class="text-container">
                <p>Tom hadn't had breakfast before coming here, and his stomach was growling. Tom ____ the grilled fish and begins eating..</p>
            </div>
            <div class="button-container">
                <button data-page="2305" data-correct="true" class="game-btn">has taken</button>
                <button data-page="2305" data-correct="false" class="game-btn">will take</button>
            </div>
            <div class="hint-text" style="display:none;">Describe completed actions in present perfect tense</div>
        </div>

        <div id="page-2305" class="game-page">
            <img src="images/画面12.jpg" alt="画面12" class="game-image">
            <div class="text-container">
                <p>Tom thinks that now he has the powerful wand.And the wizard who always bullies me ____ by him.</p>
            </div>
            <div class="button-container">
                <button data-page="2401" data-correct="true" class="game-btn">will have been defeated</button>
                <button data-page="2401" data-correct="false" class="game-btn">has been defeated</button>
            </div>
            <div class="hint-text" style="display:none;">Describe the behavior to be completed in the future using the future perfect tense</div>
        </div>

        <!-- 章节4 -->
        <div id="page-2401" class="game-page">
            <img src="images/画面13.jpg" alt="画面13" class="game-image">
            <div class="text-container">
                <p>Although Tom ____ magic at the school for a year, his knowledge of magic is still inferior to that of wizard Mike.</p>
            </div>
            <div class="button-container">
                <button data-page="2402" data-correct="true" class="game-btn">has been studying</button>
                <button data-page="2402" data-correct="false" class="game-btn">will studying</button>
            </div>
            <div class="hint-text" style="display:none;">The action has been ongoing from the past to the present, and may have just ended or is still ongoing, using the present to complete the ongoing tense</div>
        </div>

        <div id="page-2402" class="game-page">
            <img src="images/画面14.jpg" alt="画面14" class="game-image">
            <div class="text-container">
                <p>So Tom came to the house of the wizard Mike who used to tease him. Tom shouted at Mike, 'I ____ magic to defeat you. Come out and accept my challenge.'</p>
            </div>
            <div class="button-container">
                <button data-page="2403" data-correct="true" class="game-btn">will use</button>
                <button data-page="2403" data-correct="false" class="game-btn">am using</button>
            </div>
            <div class="hint-text" style="display:none;">Describe future actions using future continuous tense</div>
        </div>

        <div id="page-2403" class="game-page">
            <img src="images/画面15.jpg" alt="画面15" class="game-image">
            <div class="text-container">
                <p>Mike walked out of the room and said, 'Tom, you ____ to me over the past year. Are you still not willing to give up?'</p>
            </div>
            <div class="button-container">
                <button data-page="2404" data-correct="true" class="game-btn">had been repeatedly losing</button>
                <button data-page="2404" data-correct="false" class="game-btn">was losing</button>
            </div>
            <div class="hint-text" style="display:none;">A certain past action started earlier in the past and continued until a certain point in time, possibly still continuing or just stopped</div>
        </div>

        <div id="page-2404" class="game-page">
            <img src="images/画面16.jpg" alt="画面16" class="game-image">
            <div class="text-container">
                <p>Tom pointed his magic wand at the sky and cursed 'It's going to rain soon,' and the wand emitted blue light.</p>
            </div>
            <div class="button-container">
                <button data-page="2405" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="page-2405" class="game-page">
            <img src="images/画面17.jpg" alt="画面17" class="game-image">
            <div class="text-container">
                <p>Before long, dark clouds appeared in the sky, thunder started to strike, and raindrops began to fall.</p>
            </div>
            <div class="button-container">
                <button data-page="2406" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="page-2406" class="game-page">
            <img src="images/画面18.jpg" alt="画面18" class="game-image">
            <div class="text-container">
                <p>By tomorrow, Mike ____ magic for 2 years now. But Mike was still stunned when he saw Tom's magic. Mike had never seen such a powerful magic before and said to Tom, 'I admit you're already better than me.'</p>
            </div>
            <div class="button-container">
                <button data-page="2407" data-correct="true" class="game-btn">will have been studying</button>
                <button data-page="2407" data-correct="false" class="game-btn">will be studying</button>
            </div>
            <div class="hint-text" style="display:none;">Emphasize how long a certain action has been ongoing until a certain point in the future, using the future completion continuous time</div>
        </div>

        <div id="page-2407" class="game-page">
            <img src="images/画面19.jpg" alt="画面19" class="game-image">
            <div class="text-container">
                <p>Tom wants to show off the power of his magic wand again and is ready to recite the next spell. But suddenly a beam of light flashed and the library director Jimmy appeared in front of him.</p>
            </div>
            <div class="button-container">
                <button data-page="2408" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="page-2408" class="game-page">
            <img src="images/画面20.jpg" alt="画面20" class="game-image">
            <div class="text-container">
                <p>Library director Jimmy said to Tom, 'I ____ for it all day, but you took it away.'.</p>
            </div>
            <div class="button-container">
                <button data-page="2409" data-correct="true" class="game-btn">have been looking</button>
                <button data-page="2409" data-correct="false" class="game-btn">am looking</button>
            </div>
            <div class="hint-text" style="display:none;">Describe actions that have been completed in the past and use them to complete them</div>
        </div>

        <div id="page-2409" class="game-page">
            <img src="images/画面21.jpg" alt="画面21" class="game-image">
            <div class="text-container">
                <p>Jimmy raised his hand, and the magic wand automatically flew into Jimmy's hand. Then Jimmy shouted at Tom, 'Hurry back and clean the library for me.'</p>
            </div>
            <div class="button-container">
                <button id="game-over-btn" class="game-btn">Game over</button>
            </div>
        </div>

        <!-- 排名画面22 (页面ID:2501) -->
        <div id="page-2501" class="game-page">
            <div class="ranking-header">
                <h2>排行榜</h2>
                <div class="room-info">
                    <p>房间号: <span id="room-id-display"></span></p>
                    <p>当前玩家: <span id="player-count">0</span>人</p>
                </div>
            </div>
            <div class="ranking-table-container">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>名称</th>
                            <th>总分数</th>
                            <th>正确率</th>
                            <th>用时</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body">
                        <!-- 排行榜数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 提示信息弹窗 -->
        <div id="message-modal" class="modal">
            <div class="modal-content">
                <p id="message-text"></p>
            </div>
        </div>

        <!-- 语法提示弹窗 -->
        <div id="hint-modal" class="modal">
            <div class="modal-content">
                <p id="hint-text"></p>
            </div>
        </div>
    </div>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const currentRoomId = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isTeacher = urlParams.get('teacher') === 'true';
        let playerNickname = urlParams.get('nickname') ? decodeURIComponent(urlParams.get('nickname')) : 'Teacher';

        // 游戏状态变量
        let currentPageId = '2101'; // 默认从第一页开始
        let correctAnswers = 0;
        let startTime = Date.now();
        let endTime = 0;
        let totalScore = 0;
        let accuracy = 0;
        let timeUsed = 0;
        let playerDataRef = null;
        let roomPlayersRef = null;
        let hasSubmittedScore = false;
        let clickedButtons = {}; // 记录已点击的按钮

        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const hintModal = document.getElementById('hint-modal');
        const hintText = document.getElementById('hint-text');
        const gameOverBtn = document.getElementById('game-over-btn');
        const roomIdDisplay = document.getElementById('room-id-display');
        const playerCountDisplay = document.getElementById('player-count');
        const rankingTableBody = document.getElementById('ranking-table-body');

        // 显示消息弹窗
        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageModal.style.display = 'none';
                }, duration);
            }
        }

        // 隐藏消息弹窗
        function hideMessage() {
            messageModal.style.display = 'none';
        }

        // 显示语法提示弹窗
        function showHint(hint, duration = 3000) {
            hintText.textContent = hint;
            hintModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    hintModal.style.display = 'none';
                }, duration);
            }
        }

        // 隐藏语法提示弹窗
        function hideHint() {
            hintModal.style.display = 'none';
        }

        // 切换页面
        function goToPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.game-page').forEach(page => {
                page.classList.remove('active');
                page.classList.remove('fade-in');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
                setTimeout(() => {
                    targetPage.classList.add('fade-in');
                }, 10);
                currentPageId = pageId;
                
                // 如果是老师，直接显示排行榜
                if (isTeacher && pageId !== '2501') {
                    goToPage('2501');
                    return;
                }
                
                // 更新玩家进度
                updatePlayerProgress();
                
                // 预加载下一张可能的图片
                preloadNextImage(pageId);
            } else {
                console.error('找不到页面:', pageId);
            }
        }

        // 预加载下一张可能的图片
        function preloadNextImage(currentPageId) {
            const pageOrder = [
                '2101', '2102', '2103', '2104', 
                '2201', '2202', '2203', 
                '2301', '2302', '2303', '2304', '2305', 
                '2401', '2402', '2403', '2404', '2405', '2406', '2407', '2408', '2409'
            ];
            
            const currentIndex = pageOrder.indexOf(currentPageId);
            if (currentIndex !== -1 && currentIndex < pageOrder.length - 1) {
                const nextPageId = pageOrder[currentIndex + 1];
                const nextPageNumber = parseInt(nextPageId.substring(1));
                const imageName = `画面${nextPageNumber.toString().padStart(2, '0')}.jpg`;
                preloadImage(`images/${imageName}`);
            }
        }

        // 预加载图片
        function preloadImage(url) {
            const img = new Image();
            img.src = url;
        }

        // 计算游戏进度 (1-21)
        function calculateProgress() {
            const pageOrder = [
                '2101', '2102', '2103', '2104', 
                '2201', '2202', '2203', 
                '2301', '2302', '2303', '2304', '2305', 
                '2401', '2402', '2403', '2404', '2405', '2406', '2407', '2408', '2409'
            ];
            
            const currentIndex = pageOrder.indexOf(currentPageId);
            return currentIndex !== -1 ? currentIndex + 1 : 0;
        }

        // 计算用时 (分钟)
        function calculateTimeUsed() {
            const now = Date.now();
            const milliseconds = now - startTime;
            const minutes = Math.floor(milliseconds / 60000);
            const seconds = Math.floor((milliseconds % 60000) / 1000);
            
            // 最大60分钟
            return Math.min(minutes + (seconds > 0 ? 1 : 0), 60);
        }

        // 计算分数
        function calculateScore() {
            // 每题6.7分
            const questionScore = correctAnswers * 6.7;
            
            // 时间分数: 每分钟2分
            timeUsed = calculateTimeUsed();
            const timeScore = timeUsed * 2;
            
            // 总分数 = 问题分数 - 时间分数 (最低0分, 最高100分)
            totalScore = Math.max(0, Math.round(questionScore - timeScore));
            totalScore = Math.min(totalScore, 100);
            
            // 正确率
            accuracy = (correctAnswers / 15 * 100).toFixed(1);
            
            return {
                score: totalScore,
                accuracy: accuracy,
                timeUsed: timeUsed
            };
        }

        // 更新玩家进度到数据库
        function updatePlayerProgress() {
            if (isTeacher || !playerDataRef) return;
            
            const progress = calculateProgress();
            const timeUsed = calculateTimeUsed();
            
            playerDataRef.update({
                progress: progress,
                timeUsed: timeUsed,
                lastUpdated: Date.now()
            }).catch(error => {
                console.error('更新玩家进度失败:', error);
            });
        }

        // 提交最终分数到数据库
        function submitFinalScore() {
            if (isTeacher || hasSubmittedScore || !playerDataRef) return;
            
            const scoreData = calculateScore();
            
            playerDataRef.update({
                score: scoreData.score,
                accuracy: scoreData.accuracy,
                timeUsed: scoreData.timeUsed,
                finished: true,
                endTime: Date.now()
            }).then(() => {
                hasSubmittedScore = true;
                console.log('分数提交成功');
            }).catch(error => {
                console.error('提交分数失败:', error);
            });
        }

        // 初始化玩家数据
        function initPlayerData() {
            if (isTeacher) {
                // 老师不需要记录数据
                goToPage('2501');
                return;
            }
            
            // 玩家数据引用
            playerDataRef = database.ref(`rooms/${currentRoomId}/players/${playerId}`);
            roomPlayersRef = database.ref(`rooms/${currentRoomId}/players`);
            
            // 初始化玩家数据
            playerDataRef.set({
                nickname: playerNickname,
                progress: 1,
                score: 0,
                accuracy: 0,
                timeUsed: 0,
                startTime: startTime,
                finished: false,
                endTime: 0
            }).then(() => {
                console.log('玩家数据初始化成功');
            }).catch(error => {
                console.error('初始化玩家数据失败:', error);
            });
            
            // 监听房间玩家数据变化
            roomPlayersRef.on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const playerCount = Object.keys(players).length;
                playerCountDisplay.textContent = playerCount;
            });
            
            // 默认从第一页开始
            goToPage('2101');
        }

        // 加载排行榜数据
        function loadRankingData() {
            if (!roomPlayersRef) return;
            
            roomPlayersRef.on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const playerList = [];
                
                // 转换玩家数据为数组
                for (const playerId in players) {
                    const player = players[playerId];
                    if (player.finished && player.nickname !== 'Teacher') {
                        playerList.push({
                            id: playerId,
                            nickname: player.nickname,
                            score: player.score || 0,
                            accuracy: player.accuracy || '0.0',
                            timeUsed: player.timeUsed || 0
                        });
                    }
                }
                
                // 按分数排序
                playerList.sort((a, b) => b.score - a.score);
                
                // 只显示前10名
                const topPlayers = playerList.slice(0, 10);
                
                // 更新排行榜
                updateRankingTable(topPlayers);
            });
        }

        // 更新排行榜表格
        function updateRankingTable(players) {
            rankingTableBody.innerHTML = '';
            
            players.forEach((player, index) => {
                const row = document.createElement('tr');
                
                // 如果是当前玩家，高亮显示
                if (player.id === playerId) {
                    row.classList.add('highlight-player');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.nickname}</td>
                    <td>${player.score}</td>
                    <td>${player.accuracy}%</td>
                    <td>${player.timeUsed}分钟</td>
                `;
                
                rankingTableBody.appendChild(row);
            });
        }

        // 游戏结束处理
        function handleGameOver() {
            if (isTeacher) return;
            
            endTime = Date.now();
            submitFinalScore();
            goToPage('2501');
        }

        // 初始化游戏
        function initGame() {
            // 显示房间号
            roomIdDisplay.textContent = currentRoomId;
            
            // 初始化玩家数据
            initPlayerData();
            
            // 加载排行榜数据
            loadRankingData();
            
            // 按钮点击事件
            document.querySelectorAll('.game-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetPage = this.getAttribute('data-page');
                    const isCorrect = this.getAttribute('data-correct') === 'true';
                    
                    // 防止重复点击
                    if (clickedButtons[targetPage]) return;
                    clickedButtons[targetPage] = true;
                    
                    // 记录正确答案
                    if (isCorrect) {
                        correctAnswers++;
                    }
                    
                    // 显示语法提示 (如果是错误答案)
                    if (targetPage && this.getAttribute('data-correct') === 'false') {
                        const hint = this.parentElement.parentElement.querySelector('.hint-text');
                        if (hint) {
                            showHint(hint.textContent);
                        }
                    }
                    
                    // 跳转到目标页面
                    if (targetPage) {
                        setTimeout(() => {
                            goToPage(targetPage);
                        }, isCorrect ? 0 : 3000); // 错误答案延迟3秒跳转
                    }
                });
            });
            
            // 游戏结束按钮
            if (gameOverBtn) {
                gameOverBtn.addEventListener('click', handleGameOver);
            }
            
            // 预加载第一张图片
            preloadImage('images/画面01.jpg');
            
            // 添加页面切换动画
            document.querySelectorAll('.game-page').forEach(page => {
                page.addEventListener('animationend', function() {
                    this.classList.remove('fade-in');
                });
            });
        }

        // 页面加载完成后初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
