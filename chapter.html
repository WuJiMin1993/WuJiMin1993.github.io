<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔法世界 - 英语时态冒险</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container" id="game-container">
        <!-- 场景内容将通过JavaScript动态加载 -->
    </div>

    <!-- 错误提示弹窗 -->
    <div id="error-popup" class="popup">
        <div class="popup-content">
            <p id="error-message"></p>
        </div>
    </div>

    <script>
        // 游戏状态管理
        const gameState = {
            score: 0,
            correctAnswers: 0,
            startTime: null,
            currentScene: null,
            totalQuestions: 15
        };

        // 所有游戏场景数据
        const scenes = {
            // 索引场景
            '2101': {
                image: '画面01.jpg',
                text: '主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆',
                buttons: [
                    { text: '打扫', position: 'left', correct: true, nextScene: '2102', feedback: null },
                    { text: '正在打扫', position: 'right', correct: false, nextScene: '2102', 
                      feedback: '日常行为用一般现在时' }
                ]
            },
            '2102': {
                image: '画面02.jpg',
                text: '有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。',
                buttons: [
                    { text: '锁上', position: 'left', correct: true, nextScene: '2103', feedback: null },
                    { text: '正在锁上', position: 'right', correct: false, nextScene: '2103', 
                      feedback: '描述昨天发生的简单行为用一般过去时' }
                ]
            },
            '2103': {
                image: '画面03.jpg',
                text: 'Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着"时态魔法棒"。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextScene: '2104', feedback: null }
                ]
            },
            '2104': {
                image: '画面04.jpg',
                text: 'Tom心生好奇，他把魔法棒藏在衣服里，明天一早_____户外试一下魔法棒的威力。',
                buttons: [
                    { text: '将去', position: 'left', correct: true, nextScene: '2201', feedback: null },
                    { text: '已经去', position: 'right', correct: false, nextScene: '2201', 
                      feedback: '描述未来发生的简单行为用一般将来时' }
                ]
            },
            '2201': {
                image: '画面05.jpg',
                text: '时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。',
                buttons: [
                    { text: '正在骑', position: 'left', correct: true, nextScene: '2202', feedback: null },
                    { text: '已经骑', position: 'right', correct: false, nextScene: '2203', 
                      feedback: '描述正在进行的行为用现在进行时' }
                ]
            },
            '2202': {
                image: '画面06.jpg',
                text: '昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。',
                buttons: [
                    { text: '正在打扫', position: 'left', correct: true, nextScene: '2203', feedback: null },
                    { text: '已经打扫', position: 'right', correct: false, nextScene: '2202', 
                      feedback: '描述过去正在进行的行为用过去进行时' }
                ]
            },
            '2203': {
                image: '画面07.jpg',
                text: '为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。',
                buttons: [
                    { text: '打扫', position: 'left', correct: true, nextScene: '2301', feedback: null },
                    { text: '已经打扫', position: 'right', correct: false, nextScene: '2301', 
                      feedback: '描述将来正在进行的行为用将来进行时' }
                ]
            },
            '2301': {
                image: '画面08.jpg',
                text: 'Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫"时态"，难道启动它的咒语和时态有关？',
                buttons: [
                    { text: '拿出', position: 'left', correct: true, nextScene: '2302', feedback: null },
                    { text: '已经拿出', position: 'right', correct: false, nextScene: '2302', 
                      feedback: '描述日常行为一般现在时' }
                ]
            },
            '2302': {
                image: '画面09.jpg',
                text: '于是，他决定结合在魔法学校学习的咒语试一下。<br>Tom用魔法棒指向小溪，念了一句："一条香喷喷的鱼已经被烤熟了【现在完成】"。',
                buttons: [
                    { text: '已经被烤熟', position: 'left', correct: true, nextScene: '2303', feedback: null },
                    { text: '将来被烤熟', position: 'right', correct: false, nextScene: '2302', 
                      feedback: '咒语未生效，请重新试' }
                ]
            },
            '2303': {
                image: '画面10.jpg',
                text: '只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextScene: '2304', feedback: null }
                ]
            },
            '2304': {
                image: '画面11.jpg',
                text: 'Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。<br>Tom拿起吃了起来。',
                buttons: [
                    { text: '已经烤好的鱼', position: 'left', correct: true, nextScene: '2305', feedback: null },
                    { text: '将要烤好', position: 'right', correct: false, nextScene: '2305', 
                      feedback: '描述已经完成的的行为用现在完成时' }
                ]
            },
            '2305': {
                image: '画面12.jpg',
                text: 'Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）',
                buttons: [
                    { text: '将会被打败', position: 'left', correct: true, nextScene: '2401', feedback: null },
                    { text: '已经被打败', position: 'right', correct: false, nextScene: '2401', 
                      feedback: '描述将来完成的的行为用将来完成时' }
                ]
            },
            '2401': {
                image: '画面13.jpg',
                text: '虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。',
                buttons: [
                    { text: '学习了', position: 'left', correct: true, nextScene: '2402', feedback: null },
                    { text: '将学习', position: 'right', correct: false, nextScene: '2402', 
                      feedback: '描述过去的行为持续到现在用现在完成进行' }
                ]
            },
            '2402': {
                image: '画面14.jpg',
                text: 'Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。<br>Tom说："Mike，现在我_____魔法打败你了，你出来接受我的挑战吧"',
                buttons: [
                    { text: '可以用', position: 'left', correct: true, nextScene: '2403', feedback: null },
                    { text: '正在用', position: 'right', correct: false, nextScene: '2403', 
                      feedback: '描述正在进行的行为用现在进行时' }
                ]
            },
            '2403': {
                image: '画面15.jpg',
                text: '今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗"',
                buttons: [
                    { text: '输给', position: 'left', correct: true, nextScene: '2404', feedback: null },
                    { text: '将输给', position: 'right', correct: false, nextScene: '2404', 
                      feedback: '描述正在进行的行为用现在进行时' }
                ]
            },
            '2404': {
                image: '画面16.jpg',
                text: '只见Tom用魔法棒指向天空，用咒语说了一句："It\'s going to rain soon"，魔法棒发出来蓝光。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextScene: '2405', feedback: null }
                ]
            },
            '2405': {
                image: '画面17.jpg',
                text: '果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextScene: '2406', feedback: null }
                ]
            },
            '2406': {
                image: '画面18.jpg',
                text: 'Mike看见后下了一跳，说到："到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了"',
                buttons: [
                    { text: '已经学了', position: 'left', correct: true, nextScene: '2407', feedback: null },
                    { text: '将要学', position: 'right', correct: false, nextScene: '2407', 
                      feedback: '描述将来完成进行时' }
                ]
            },
            '2407': {
                image: '画面19.jpg',
                text: 'Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextScene: '2408', feedback: null }
                ]
            },
            '2408': {
                image: '画面20.jpg',
                text: '馆长说到："Tom，我找了它找了一整天，原来被你拿走了"。',
                buttons: [
                    { text: '找了', position: 'left', correct: true, nextScene: '2409', feedback: null },
                    { text: '将找', position: 'right', correct: false, nextScene: '2409', 
                      feedback: '描述过去完成' }
                ]
            },
            '2409': {
                image: '画面21.jpg',
                text: 'Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道"赶紧回去给我打扫图书馆".....',
                buttons: [
                    { text: '继续', position: 'center', correct: null, nextScene: '2410', feedback: null }
                ]
            },
            '2410': {
                image: '画面22.jpg',
                text: '',
                buttons: []
            }
        };

        // 初始化游戏
        function initGame() {
            // 从URL参数获取当前场景
            const urlParams = new URLSearchParams(window.location.search);
            const sceneId = urlParams.get('scene') || '2101';
            
            // 尝试从本地存储加载游戏状态
            loadGameState();
            
            // 如果游戏刚刚开始，初始化时间
            if (sceneId === '2101' && !gameState.startTime) {
                gameState.startTime = new Date();
            }
            
            // 设置当前场景
            gameState.currentScene = sceneId;
            
            // 渲染场景
            renderScene(sceneId);
        }

        // 加载游戏状态
        function loadGameState() {
            const savedState = localStorage.getItem('magicWorldGameState');
            if (savedState) {
                Object.assign(gameState, JSON.parse(savedState));
                // 将字符串时间转换为Date对象
                if (gameState.startTime && typeof gameState.startTime === 'string') {
                    gameState.startTime = new Date(gameState.startTime);
                }
            }
        }

        // 保存游戏状态
        function saveGameState() {
            localStorage.setItem('magicWorldGameState', JSON.stringify(gameState));
        }

        // 渲染场景
        function renderScene(sceneId) {
            const scene = scenes[sceneId];
            const container = document.getElementById('game-container');
            
            if (!scene) {
                console.error('场景不存在:', sceneId);
                return;
            }
            
            // 如果是结束场景，显示结果
            if (sceneId === '2410') {
                showResults();
                return;
            }
            
            // 创建场景HTML
            let html = `
                <div class="game-screen">
                    <div class="scene-text">${scene.text}</div>
                    <img src="images/${scene.image}" alt="游戏场景" class="game-image">
                    <div class="buttons-container">
            `;
            
            // 添加按钮
            scene.buttons.forEach((button, index) => {
                const buttonClass = button.position === 'center' ? 'center-button' : 
                                  button.position === 'left' ? 'left-button' : 'right-button';
                
                html += `
                    <button class="action-button ${buttonClass}" 
                            data-correct="${button.correct}" 
                            data-next="${button.nextScene}"
                            data-feedback="${button.feedback || ''}">
                        ${button.text}
                    </button>
                `;
            });
            
            html += `</div></div>`;
            
            // 更新容器内容
            container.innerHTML = html;
            
            // 添加按钮事件监听器
            document.querySelectorAll('.action-button').forEach(button => {
                button.addEventListener('click', handleButtonClick);
            });
        }

        // 处理按钮点击
        function handleButtonClick(event) {
            const button = event.target;
            const isCorrect = button.getAttribute('data-correct');
            const nextScene = button.getAttribute('data-next');
            const feedback = button.getAttribute('data-feedback');
            
            // 更新分数（如果是正确答案）
            if (isCorrect === 'true') {
                gameState.score += 6.7;
                gameState.correctAnswers++;
                saveGameState();
            }
            
            // 显示错误反馈（如果有）
            if (isCorrect === 'false' && feedback) {
                showErrorFeedback(feedback);
                
                // 延迟跳转到下一个场景
                setTimeout(() => {
                    navigateToScene(nextScene);
                }, 3000);
            } else {
                // 直接跳转到下一个场景
                navigateToScene(nextScene);
            }
        }

        // 显示错误反馈
        function showErrorFeedback(message) {
            const popup = document.getElementById('error-popup');
            const messageElement = document.getElementById('error-message');
            
            messageElement.textContent = message;
            popup.style.display = 'block';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                popup.style.display = 'none';
            }, 3000);
        }

        // 导航到指定场景
        function navigateToScene(sceneId) {
            if (!sceneId) return;
            
            // 更新URL而不重新加载页面
            window.history.pushState({}, '', `?scene=${sceneId}`);
            
            // 渲染新场景
            renderScene(sceneId);
        }

        // 显示最终结果
        function showResults() {
            const endTime = new Date();
            const timeDiff = (endTime - gameState.startTime) / 1000; // 秒
            
            // 计算时间分数（每分钟2分，不满1分钟1分）
            const minutes = Math.floor(timeDiff / 60);
            const seconds = timeDiff % 60;
            const timeScore = minutes * 2 + (seconds > 0 ? 1 : 0);
            
            // 计算总分
            const totalScore = Math.max(0, gameState.score - timeScore);
            
            // 计算正确率
            const accuracy = (gameState.correctAnswers / gameState.totalQuestions * 100).toFixed(1);
            
            // 显示结果
            const container = document.getElementById('game-container');
            container.innerHTML = `
                <div class="results-screen">
                    <h1>游戏结束</h1>
                    <img src="images/画面22.jpg" alt="游戏结果" class="game-image">
                    <div class="results-stats">
                        <p>正确率: <span>${accuracy}%</span></p>
                        <p>用时: <span>${minutes}分${Math.floor(seconds)}秒</span></p>
                        <p>总得分: <span>${totalScore.toFixed(1)}</span></p>
                    </div>
                    <button id="restart-button" class="main-button">重新开始</button>
                </div>
            `;
            
            // 添加重新开始按钮事件
            document.getElementById('restart-button').addEventListener('click', () => {
                // 重置游戏状态
                gameState.score = 0;
                gameState.correctAnswers = 0;
                gameState.startTime = null;
                saveGameState();
                
                // 返回首页
                window.location.href = 'index.html';
            });
        }

        // 初始化游戏
        window.addEventListener('DOMContentLoaded', initGame);
        
        // 处理浏览器前进/后退按钮
        window.addEventListener('popstate', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sceneId = urlParams.get('scene') || '2101';
            renderScene(sceneId);
        });
    </script>
</body>
</html>
