<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game - Chapters</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- Game screens container -->
    <div id="game-container">
        <!-- Chapter 1 Screens -->
        <div id="screen-2101" class="screen">
            <img src="images/画面01.jpg" alt="Scene 1" class="full-width-image">
            <div class="text-box">
                <p>Tom lives in a magical world and ____ the school library every day.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2102" class="game-btn">cleans</button>
                <button data-correct="false" data-next="2102" class="game-btn">cleaning</button>
            </div>
        </div>

        <div id="screen-2102" class="screen">
            <img src="images/画面02.jpg" alt="Scene 2" class="full-width-image">
            <div class="text-box">
                <p>Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2103" class="game-btn">locked</button>
                <button data-correct="false" data-next="2103" class="game-btn">locks</button>
            </div>
        </div>

        <div id="screen-2103" class="screen">
            <img src="images/画面03.jpg" alt="Scene 3" class="full-width-image">
            <div class="text-box">
                <p>Tom walked over curiously and saw a magic wand with a flashing blue light, with a label next to it that read: Tense Magic wand.</p>
            </div>
            <div class="button-container">
                <button data-next="2104" class="game-btn">continue</button>
            </div>
        </div>

        <div id="screen-2104" class="screen">
            <img src="images/画面04.jpg" alt="Scene 4" class="full-width-image">
            <div class="text-box">
                <p>Tom became curious and hid his magic wand in his clothes before taking it away from the library He ____ outdoors tomorrow to test the power of the magic wand.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2201" class="game-btn">will go</button>
                <button data-correct="false" data-next="2201" class="game-btn">is going</button>
            </div>
        </div>

        <!-- Chapter 2 Screens -->
        <div id="screen-2201" class="screen">
            <img src="images/画面05.jpg" alt="Scene 5" class="full-width-image">
            <div class="text-box">
                <p>The next morning, he ____ a magic broom towards a forest next to the school.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2202" class="game-btn">is riding</button>
                <button data-correct="false" data-next="2202" class="game-btn">has ridden</button>
            </div>
        </div>

        <div id="screen-2202" class="screen">
            <img src="images/画面06.jpg" alt="Scene 6" class="full-width-image">
            <div class="text-box">
                <p>At this time yesterday, Tom was cleaning the library. He was supposed to be organizing books in the library today, but he thought this magic wand would be fun. So I decided to slack off and not go to the library anymore.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2203" class="game-btn">was cleaning</button>
                <button data-correct="false" data-next="2203" class="game-btn">is cleaning</button>
            </div>
        </div>

        <div id="screen-2203" class="screen">
            <img src="images/画面07.jpg" alt="Scene 7" class="full-width-image">
            <div class="text-box">
                <p>Tom will be tidying up the library early tomorrow to prevent library director Jimmy from discovering his laziness.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2301" class="game-btn">will be tidying up</button>
                <button data-correct="false" data-next="2301" class="game-btn">is tidying up</button>
            </div>
        </div>

        <!-- Chapter 3 Screens -->
        <div id="screen-2301" class="screen">
            <img src="images/画面08.jpg" alt="Scene 8" class="full-width-image">
            <div class="text-box">
                <p>Tom stops by the stream in the forest and ____ the magic wand from his clothes. He thought that the magic wand is called a tense magic wand. Is the spell that activates it related to tense?</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2302" class="game-btn">takes out</button>
                <button data-correct="false" data-next="2302" class="game-btn">will take out</button>
            </div>
        </div>

        <div id="screen-2302" class="screen">
            <img src="images/画面09.jpg" alt="Scene 9" class="full-width-image">
            <div class="text-box">
                <p>So he decided to try combining the spells he learned at the magic school. Tom pointed his magic wand at the stream and said, 'A delicious fish ____.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2304" class="game-btn">has been grilled</button>
                <button data-correct="false" data-next="2304" class="game-btn">will be grilled</button>
            </div>
        </div>

        <div id="screen-2303" class="screen">
            <img src="images/画面10.jpg" alt="Scene 10" class="full-width-image">
            <div class="text-box">
                <p>After reciting the spell, a sudden blue flash appeared. Then a grill made of tree branches appeared in front of Tom, with a fragrant grilled fish on top.</p>
            </div>
            <div class="button-container">
                <button data-next="2304" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="screen-2304" class="screen">
            <img src="images/画面11.jpg" alt="Scene 11" class="full-width-image">
            <div class="text-box">
                <p>Tom hadn't had breakfast before coming here, and his stomach was growling. Tom ____ the grilled fish and begins eating.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2305" class="game-btn">has taken</button>
                <button data-correct="false" data-next="2305" class="game-btn">will take</button>
            </div>
        </div>

        <div id="screen-2305" class="screen">
            <img src="images/画面12.jpg" alt="Scene 12" class="full-width-image">
            <div class="text-box">
                <p>Tom thinks that now he has the powerful wand.And the wizard who always bullies me ____ by him.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2401" class="game-btn">will have been defeated</button>
                <button data-correct="false" data-next="2401" class="game-btn">has been defeated</button>
            </div>
        </div>

        <!-- Chapter 4 Screens -->
        <div id="screen-2401" class="screen">
            <img src="images/画面13.jpg" alt="Scene 13" class="full-width-image">
            <div class="text-box">
                <p>Although Tom ____ magic at the school for a year, his knowledge of magic is still inferior to that of wizard Mike.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2402" class="game-btn">has been studying</button>
                <button data-correct="false" data-next="2402" class="game-btn">will studying</button>
            </div>
        </div>

        <div id="screen-2402" class="screen">
            <img src="images/画面14.jpg" alt="Scene 14" class="full-width-image">
            <div class="text-box">
                <p>So Tom came to the house of the wizard Mike who used to tease him. Tom shouted at Mike, 'I ____ magic to defeat you. Come out and accept my challenge.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2403" class="game-btn">will use</button>
                <button data-correct="false" data-next="2403" class="game-btn">am using</button>
            </div>
        </div>

        <div id="screen-2403" class="screen">
            <img src="images/画面15.jpg" alt="Scene 15" class="full-width-image">
            <div class="text-box">
                <p>Mike walked out of the room and said, 'Tom, you ____ to me over the past year. Are you still not willing to give up?'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2404" class="game-btn">had been repeatedly losing</button>
                <button data-correct="false" data-next="2404" class="game-btn">was losing</button>
            </div>
        </div>

        <div id="screen-2404" class="screen">
            <img src="images/画面16.jpg" alt="Scene 16" class="full-width-image">
            <div class="text-box">
                <p>Tom pointed his magic wand at the sky and cursed 'It's going to rain soon,' and the wand emitted blue light.</p>
            </div>
            <div class="button-container">
                <button data-next="2405" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="screen-2405" class="screen">
            <img src="images/画面17.jpg" alt="Scene 17" class="full-width-image">
            <div class="text-box">
                <p>Before long, dark clouds appeared in the sky, thunder started to strike, and raindrops began to fall.</p>
            </div>
            <div class="button-container">
                <button data-next="2406" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="screen-2406" class="screen">
            <img src="images/画面18.jpg" alt="Scene 18" class="full-width-image">
            <div class="text-box">
                <p>By tomorrow, Mike ____ magic for 2 years now. But Mike was still stunned when he saw Tom's magic. Mike had never seen such a powerful magic before and said to Tom, 'I admit you're already better than me.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2407" class="game-btn">will have been studying</button>
                <button data-correct="false" data-next="2407" class="game-btn">will be studying</button>
            </div>
        </div>

        <div id="screen-2407" class="screen">
            <img src="images/画面19.jpg" alt="Scene 19" class="full-width-image">
            <div class="text-box">
                <p>Tom wants to show off the power of his magic wand again and is ready to recite the next spell. But suddenly a beam of light flashed and the library director Jimmy appeared in front of him.</p>
            </div>
            <div class="button-container">
                <button data-next="2408" class="game-btn">Continue</button>
            </div>
        </div>

        <div id="screen-2408" class="screen">
            <img src="images/画面20.jpg" alt="Scene 20" class="full-width-image">
            <div class="text-box">
                <p>Library director Jimmy said to Tom, 'I ____ for it all day, but you took it away.'.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2409" class="game-btn">have been looking</button>
                <button data-correct="false" data-next="2409" class="game-btn">am looking</button>
            </div>
        </div>

        <div id="screen-2409" class="screen">
            <img src="images/画面21.jpg" alt="Scene 21" class="full-width-image">
            <div class="text-box">
                <p>Jimmy raised his hand, and the magic wand automatically flew into Jimmy's hand. Then Jimmy shouted at Tom, 'Hurry back and clean the library for me.'</p>
            </div>
            <div class="button-container">
                <button id="game-over-btn" class="game-btn">Game over</button>
            </div>
        </div>

        <!-- Leaderboard Screen (Page ID: 2501) -->
        <div id="screen-2501" class="screen">
            <div class="room-info">
                <h2 id="room-number-display">Room: Loading...</h2>
                <p id="player-count">Players: 0</p>
            </div>
            <div class="leaderboard-container">
                <h2>Leaderboard</h2>
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Accuracy</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Leaderboard rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Hint Message -->
    <div id="hint-message" class="message-box">
        <p id="hint-text"></p>
    </div>

    <!-- Game logic and Firebase integration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state variables
        let currentScreenId = null;
        let isTeacher = false;
        let roomNumber = null;
        let playerId = null;
        let playerNickname = null;
        let gameStartTime = null;
        let correctAnswers = 0;
        let totalQuestions = 15; // Total questions in the game
        let currentQuestion = 0;
        let playerRef = null;
        let roomRef = null;
        let leaderboardUpdateInterval = null;

        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const hintMessage = document.getElementById('hint-message');
        const hintText = document.getElementById('hint-text');
        const gameOverBtn = document.getElementById('game-over-btn');
        const roomNumberDisplay = document.getElementById('room-number-display');
        const playerCountDisplay = document.getElementById('player-count');
        const leaderboardBody = document.getElementById('leaderboard-body');

        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        roomNumber = urlParams.get('room');
        playerId = urlParams.get('player');
        isTeacher = urlParams.get('teacher') === 'true';

        // Initialize game
        function initGame() {
            // Hide all screens initially
            const screens = document.querySelectorAll('.screen');
            screens.forEach(screen => {
                screen.classList.remove('active');
            });

            // Set up button click handlers
            setupButtonHandlers();

            // If teacher, go directly to leaderboard
            if (isTeacher) {
                showScreen('2501');
                setupLeaderboardUpdates();
                return;
            }

            // If player, initialize game state
            if (playerId && roomNumber) {
                playerRef = database.ref(`rooms/${roomNumber}/players/${playerId}`);
                roomRef = database.ref(`rooms/${roomNumber}`);
                
                // Get player data
                playerRef.once('value').then((snapshot) => {
                    const playerData = snapshot.val();
                    if (playerData) {
                        playerNickname = playerData.nickname;
                        correctAnswers = playerData.correctAnswers || 0;
                        
                        // Start game timer
                        gameStartTime = Date.now();
                        startGameTimer();
                        
                        // Show first screen
                        showScreen('2101');
                        
                        // Setup leaderboard updates (for future use)
                        setupLeaderboardUpdates();
                    } else {
                        console.error('Player data not found');
                        // Handle error - maybe redirect to start
                    }
                }).catch((error) => {
                    console.error('Error loading player data:', error);
                });
            } else {
                console.error('Missing room or player ID');
                // Handle error - maybe redirect to start
            }
        }

        // Set up button click handlers
        function setupButtonHandlers() {
            // Game buttons
            const buttons = document.querySelectorAll('.game-btn');
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Disable button to prevent multiple clicks
                    this.disabled = true;
                    
                    // Check if it's an answer button
                    const isCorrect = this.getAttribute('data-correct') === 'true';
                    const nextScreen = this.getAttribute('data-next');
                    
                    if (isCorrect !== null) {
                        // It's an answer button
                        currentQuestion++;
                        
                        // Update correct answers if correct
                        if (isCorrect) {
                            correctAnswers++;
                            updatePlayerScore();
                        } else {
                            // Show hint for wrong answer
                            showHintForButton(this);
                        }
                        
                        // Update player progress
                        updatePlayerProgress(currentQuestion);
                    }
                    
                    // If there's a next screen, go there
                    if (nextScreen) {
                        setTimeout(() => {
                            hideHint();
                            showScreen(nextScreen);
                        }, isCorrect ? 0 : 3000); // Delay for hint display if wrong answer
                    }
                });
            });
            
            // Special handler for game over button
            if (gameOverBtn) {
                gameOverBtn.addEventListener('click', endGame);
            }
        }

        // Show a screen
        function showScreen(screenId) {
            // Hide current screen
            if (currentScreenId) {
                const currentScreen = document.getElementById(`screen-${currentScreenId}`);
                if (currentScreen) {
                    currentScreen.classList.remove('active');
                }
            }
            
            // Show new screen
            const newScreen = document.getElementById(`screen-${screenId}`);
            if (newScreen) {
                newScreen.classList.add('active');
                currentScreenId = screenId;
                
                // If this is the leaderboard screen, update it
                if (screenId === '2501') {
                    updateLeaderboard();
                }
                
                // Preload next image if available
                preloadNextImage(screenId);
            }
        }

        // Preload next image for smoother transitions
        function preloadNextImage(currentScreenId) {
            const screenOrder = [
                '2101', '2102', '2103', '2104',
                '2201', '2202', '2203',
                '2301', '2302', '2303', '2304', '2305',
                '2401', '2402', '2403', '2404', '2405', '2406', '2407', '2408', '2409',
                '2501'
            ];
            
            const currentIndex = screenOrder.indexOf(currentScreenId);
            if (currentIndex !== -1 && currentIndex < screenOrder.length - 1) {
                const nextScreenId = screenOrder[currentIndex + 1];
                const nextImage = new Image();
                nextImage.src = `images/画面${nextScreenId.substring(1)}.jpg`;
            }
        }

        // Show hint for wrong answer
        function showHintForButton(button) {
            let hint = '';
            
            // Determine hint based on button text
            switch(button.textContent.trim()) {
                case 'cleaning':
                    hint = 'Daily behavior is expressed in the present tense';
                    break;
                case 'locks':
                    hint = 'Describe the simple behavior that occurred yesterday in the past simple tense';
                    break;
                case 'is going':
                    hint = 'Describe simple behaviors that will occur in the future using general future tense';
                    break;
                case 'has ridden':
                    hint = 'Describe the ongoing behavior in present continuous tense';
                    break;
                case 'is cleaning':
                    hint = '描述过去正在进行的行为用过去进行时';
                    break;
                case 'is tidying up':
                    hint = 'Describe the ongoing behavior in the future using future continuous tense';
                    break;
                case 'will take out':
                    hint = 'Describe daily behavior in the present tense';
                    break;
                case 'will be grilled':
                    hint = 'The spell didn\'t take effect, Tom recited a delicious fish that had already been grilled';
                    break;
                case 'will take':
                    hint = 'Describe completed actions in present perfect tense';
                    break;
                case 'has been defeated':
                    hint = 'Describe the behavior to be completed in the future using the future perfect tense';
                    break;
                case 'will studying':
                    hint = 'The action has been ongoing from the past to the present, and may have just ended or is still ongoing, using the present to complete the ongoing tense';
                    break;
                case 'am using':
                    hint = 'Describe future actions using future continuous tense';
                    break;
                case 'was losing':
                    hint = 'A certain past action started earlier in the past and continued until a certain point in time, possibly still continuing or just stopped';
                    break;
                case 'am looking':
                    hint = 'Describe actions that have been completed in the past and use them to complete them';
                    break;
                case 'will be studying':
                    hint = 'Emphasize how long a certain action has been ongoing until a certain point in the future, using the future completion continuous time';
                    break;
                default:
                    hint = 'Incorrect answer';
            }
            
            hintText.textContent = hint;
            hintMessage.style.display = 'block';
        }

        // Hide hint
        function hideHint() {
            hintMessage.style.display = 'none';
        }

        // Start game timer
        function startGameTimer() {
            // Update time spent every second
            setInterval(() => {
                if (gameStartTime && playerRef) {
                    const timeSpent = Math.floor((Date.now() - gameStartTime) / 1000); // in seconds
                    playerRef.update({
                        timeSpent: timeSpent
                    });
                }
            }, 1000);
        }

        // Update player score
        function updatePlayerScore() {
            if (playerRef) {
                playerRef.update({
                    correctAnswers: correctAnswers
                });
            }
        }

        // Update player progress
        function updatePlayerProgress(currentQuestion) {
            if (playerRef) {
                const progress = Math.floor((currentQuestion / 21) * 100);
                playerRef.update({
                    progress: progress
                });
            }
        }

        // Calculate player score
        function calculateScore(correctCount, timeSpentSeconds) {
            // Question score: 6.7 points per correct answer
            const questionScore = correctCount * 6.7;
            
            // Time score: 2 points per full minute, 1 point for partial minute
            const timeScore = Math.floor(timeSpentSeconds / 60) * 2 + 
                             (timeSpentSeconds % 60 > 0 ? 1 : 0);
            
            // Total score is question score minus time score
            let totalScore = Math.max(0, questionScore - timeScore);
            
            // Cap at 100
            totalScore = Math.min(100, Math.round(totalScore));
            
            // Calculate accuracy
            const accuracy = (correctCount / totalQuestions) * 100;
            
            return {
                score: totalScore,
                accuracy: accuracy.toFixed(1),
                timeSpent: formatTime(timeSpentSeconds)
            };
        }

        // Format time from seconds to MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // End game and go to leaderboard
        function endGame() {
            if (playerRef) {
                const timeSpent = Math.floor((Date.now() - gameStartTime) / 1000);
                
                // Calculate final score
                const scoreData = calculateScore(correctAnswers, timeSpent);
                
                // Update player data
                playerRef.update({
                    status: 'completed',
                    score: scoreData.score,
                    accuracy: scoreData.accuracy,
                    timeSpent: timeSpent,
                    progress: 100
                }).then(() => {
                    // Show leaderboard
                    showScreen('2501');
                    
                    // Stop game timer updates
                    clearInterval(leaderboardUpdateInterval);
                }).catch((error) => {
                    console.error('Error updating player data:', error);
                });
            }
        }

        // Set up leaderboard updates
        function setupLeaderboardUpdates() {
            if (roomRef) {
                // Update room info
                roomRef.on('value', (snapshot) => {
                    const roomData = snapshot.val();
                    if (roomData) {
                        // Update room number display
                        roomNumberDisplay.textContent = `Room: ${roomNumber}`;
                        
                        // Count active players (excluding teacher and completed players)
                        const players = roomData.players || {};
                        let playerCount = 0;
                        
                        for (const playerId in players) {
                            if (players[playerId].status === 'playing') {
                                playerCount++;
                            }
                        }
                        
                        playerCountDisplay.textContent = `Players: ${playerCount}`;
                    }
                });
                
                // Update leaderboard every 3 seconds
                leaderboardUpdateInterval = setInterval(updateLeaderboard, 3000);
            }
        }

        // Update leaderboard
        function updateLeaderboard() {
            if (roomRef) {
                roomRef.once('value').then((snapshot) => {
                    const roomData = snapshot.val();
                    if (roomData && roomData.players) {
                        const players = roomData.players;
                        const playerArray = [];
                        
                        // Convert players object to array and calculate scores
                        for (const playerId in players) {
                            const player = players[playerId];
                            if (player.status === 'completed') {
                                const scoreData = calculateScore(
                                    player.correctAnswers || 0, 
                                    player.timeSpent || 0
                                );
                                
                                playerArray.push({
                                    id: playerId,
                                    nickname: player.nickname,
                                    score: scoreData.score,
                                    accuracy: scoreData.accuracy,
                                    timeSpent: scoreData.timeSpent
                                });
                            }
                        }
                        
                        // Sort players by score (descending)
                        playerArray.sort((a, b) => b.score - a.score);
                        
                        // Clear current leaderboard
                        leaderboardBody.innerHTML = '';
                        
                        // Add top 10 players to leaderboard
                        const topPlayers = playerArray.slice(0, 10);
                        topPlayers.forEach((player, index) => {
                            const row = document.createElement('tr');
                            
                            // Highlight current player's row
                            if (playerId && player.id === playerId) {
                                row.classList.add('highlight-player');
                            }
                            
                            row.innerHTML = `
                                <td>${index + 1}</td>
                                <td>${player.nickname}</td>
                                <td>${player.score}</td>
                                <td>${player.accuracy}%</td>
                                <td>${player.timeSpent}</td>
                            `;
                            
                            leaderboardBody.appendChild(row);
                        });
                    }
                }).catch((error) => {
                    console.error('Error updating leaderboard:', error);
                });
            }
        }

        // Initialize the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
