<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语时态魔法冒险 - 章节</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- 游戏主容器 -->
    <div id="game-container">
        <!-- 背景图片 -->
        <img id="background-image" src="" alt="游戏背景" class="fade-in">
        
        <!-- 文本内容 -->
        <div id="text-content" class="fade-in"></div>
        
        <!-- 按钮容器 -->
        <div id="buttons-container"></div>
        
        <!-- 提示框 -->
        <div id="hint-box" class="hidden">
            <p id="hint-text"></p>
        </div>
    </div>

    <script>
        // 游戏状态管理
        const gameState = JSON.parse(sessionStorage.getItem('gameState')) || {
            score: 0,
            correctAnswers: 0,
            startTime: new Date().getTime(),
            endTime: null,
            currentScene: 2101, // 默认从第一个场景开始
            clickedButtons: new Set()
        };

        // 游戏场景数据
        const scenes = {
            // 章节1
            2101: {
                text: "主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。",
                image: "images/画面01.jpg",
                buttons: [
                    { text: "打扫", id: "3101", position: "left", correct: true, nextScene: 2102 },
                    { text: "正在打扫", id: "3102", position: "right", correct: false, hint: "日常行为用一般现在时", nextScene: 2102 }
                ]
            },
            2102: {
                text: "有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。",
                image: "images/画面02.jpg",
                buttons: [
                    { text: "锁上", id: "3103", position: "left", correct: true, nextScene: 2103 },
                    { text: "正在锁上", id: "3104", position: "right", correct: false, hint: "描述昨天发生的简单行为用一般过去时", nextScene: 2103 }
                ]
            },
            2103: {
                text: "Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着'时态魔法棒'。",
                image: "images/画面03.jpg",
                buttons: [
                    { text: "继续", id: "3105", position: "full", correct: true, nextScene: 2104 }
                ]
            },
            2104: {
                text: "Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。",
                image: "images/画面04.jpg",
                buttons: [
                    { text: "将去", id: "3106", position: "left", correct: true, nextScene: 2201 },
                    { text: "已经去", id: "3107", position: "right", correct: false, hint: "描述未来发生的简单行为用一般将来时", nextScene: 2201 }
                ]
            },
            
            // 章节2
            2201: {
                text: "时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。",
                image: "images/画面05.jpg",
                buttons: [
                    { text: "正在骑", id: "3201", position: "left", correct: true, nextScene: 2202 },
                    { text: "已经骑", id: "3202", position: "right", correct: false, hint: "描述正在进行的行为用现在进行时", nextScene: 2203 }
                ]
            },
            2202: {
                text: "昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。",
                image: "images/画面06.jpg",
                buttons: [
                    { text: "正在打扫", id: "3203", position: "left", correct: true, nextScene: 2203 },
                    { text: "已经打扫", id: "3204", position: "right", correct: false, hint: "描述过去正在进行的行为用过去进行时", nextScene: 2202 }
                ]
            },
            2203: {
                text: "为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。",
                image: "images/画面07.jpg",
                buttons: [
                    { text: "打扫", id: "3205", position: "left", correct: true, nextScene: 2301 },
                    { text: "已经打扫", id: "3206", position: "right", correct: false, hint: "描述将来正在进行的行为用将来进行时", nextScene: 2301 }
                ]
            },
            
            // 章节3
            2301: {
                text: "Tom停在了森林里的小溪旁边，然后从衣服里拿出【一般现在】魔法棒。他想，这魔法棒叫'时态'，难道启动它的咒语和时态有关？",
                image: "images/画面08.jpg",
                buttons: [
                    { text: "拿出", id: "3301", position: "left", correct: true, nextScene: 2302 },
                    { text: "已经拿出", id: "3302", position: "right", correct: false, hint: "描述日常行为一般现在时", nextScene: 2302 }
                ]
            },
            2302: {
                text: "于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句：'一条香喷喷的鱼已经被烤熟了【现在完成】'。",
                image: "images/画面09.jpg",
                buttons: [
                    { text: "已经被烤熟", id: "3303", position: "left", correct: true, nextScene: 2303 },
                    { text: "将来被烤熟", id: "3304", position: "right", correct: false, hint: "咒语未生效，请重新试", nextScene: 2302 }
                ]
            },
            2303: {
                text: "只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。",
                image: "images/画面10.jpg",
                buttons: [
                    { text: "继续", id: "3305", position: "full", correct: true, nextScene: 2304 }
                ]
            },
            2304: {
                text: "Tom想，我来这之前，还没吃东西呢【过去完成】。正好可以包餐一顿。Tom拿起吃了起来。",
                image: "images/画面11.jpg",
                buttons: [
                    { text: "已经烤好的鱼", id: "3306", position: "left", correct: true, nextScene: 2305 },
                    { text: "将要烤好", id: "3307", position: "right", correct: false, hint: "描述已经完成的的行为用现在完成时", nextScene: 2305 }
                ]
            },
            2305: {
                text: "Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）",
                image: "images/画面12.jpg",
                buttons: [
                    { text: "将会被打败", id: "3308", position: "left", correct: true, nextScene: 2401 },
                    { text: "已经被打败", id: "3309", position: "right", correct: false, hint: "描述将来完成的的行为用将来完成时", nextScene: 2401 }
                ]
            },
            
            // 章节4
            2401: {
                text: "虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。",
                image: "images/画面13.jpg",
                buttons: [
                    { text: "学习了", id: "3401", position: "left", correct: true, nextScene: 2402 },
                    { text: "将学习", id: "3402", position: "right", correct: false, hint: "描述过去的行为持续到现在用现在完成进行", nextScene: 2402 }
                ]
            },
            2402: {
                text: "Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说：'Mike，现在我_____魔法打败你了，你出来接受我的挑战吧'",
                image: "images/画面14.jpg",
                buttons: [
                    { text: "可以用", id: "3403", position: "left", correct: true, nextScene: 2403 },
                    { text: "正在用", id: "3404", position: "right", correct: false, hint: "描述正在进行的行为用现在进行时", nextScene: 2403 }
                ]
            },
            2403: {
                text: "今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到'Tom，在过去的一年时间里，已经多次_____我了【过去完成进行时】。（You had been repeatedly losing to me over the past year.）还是不服输吗'",
                image: "images/画面15.jpg",
                buttons: [
                    { text: "输给", id: "3405", position: "left", correct: true, nextScene: 2404 },
                    { text: "将输给", id: "3406", position: "right", correct: false, hint: "描述正在进行的行为用现在进行时", nextScene: 2404 }
                ]
            },
            2404: {
                text: "只见Tom用魔法棒指向天空，用咒语说了一句：'It's going to rain soon'，魔法棒发出来蓝光。",
                image: "images/画面16.jpg",
                buttons: [
                    { text: "继续", id: "3407", position: "full", correct: true, nextScene: 2405 }
                ]
            },
            2405: {
                text: "果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。",
                image: "images/画面17.jpg",
                buttons: [
                    { text: "继续", id: "3408", position: "full", correct: true, nextScene: 2406 }
                ]
            },
            2406: {
                text: "Mike看见后下了一跳，说到：'到明天为止，我已经学了魔法2年了【将来完成进行时】（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了'",
                image: "images/画面18.jpg",
                buttons: [
                    { text: "已经学了", id: "3409", position: "left", correct: true, nextScene: 2407 },
                    { text: "将要学", id: "3410", position: "right", correct: false, hint: "描述将来完成进行时", nextScene: 2407 }
                ]
            },
            2407: {
                text: "Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。",
                image: "images/画面19.jpg",
                buttons: [
                    { text: "继续", id: "3411", position: "full", correct: true, nextScene: 2408 }
                ]
            },
            2408: {
                text: "馆长说到：'Tom，我找了它找了一整天，原来被你拿走了'。",
                image: "images/画面20.jpg",
                buttons: [
                    { text: "找了", id: "3412", position: "left", correct: true, nextScene: 2409 },
                    { text: "将找", id: "3413", position: "right", correct: false, hint: "描述过去完成", nextScene: 2409 }
                ]
            },
            2409: {
                text: "Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道'赶紧回去给我打扫图书馆'.....",
                image: "images/画面21.jpg",
                buttons: [
                    { text: "继续", id: "3414", position: "full", correct: true, nextScene: 2410 }
                ]
            },
            2410: {
                text: "",
                image: "",
                buttons: []
            }
        };

        // 初始化章节游戏
        function initializeChapterGame() {
            // 从sessionStorage恢复游戏状态
            if (sessionStorage.getItem('gameState')) {
                const savedState = JSON.parse(sessionStorage.getItem('gameState'));
                gameState.score = savedState.score || 0;
                gameState.correctAnswers = savedState.correctAnswers || 0;
                gameState.startTime = savedState.startTime || new Date().getTime();
                gameState.currentScene = savedState.currentScene || 2101;
                
                // 恢复点击过的按钮集合
                gameState.clickedButtons = new Set(savedState.clickedButtons || []);
            } else {
                // 新游戏，初始化状态
                gameState.score = 0;
                gameState.correctAnswers = 0;
                gameState.startTime = new Date().getTime();
                gameState.currentScene = 2101;
                gameState.clickedButtons = new Set();
            }

            // 加载当前场景
            loadScene(gameState.currentScene);
        }

        // 加载场景
        function loadScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) {
                // 游戏结束，显示结果
                showResults();
                return;
            }

            // 更新当前场景
            gameState.currentScene = sceneId;
            saveGameState();

            // 设置背景图片
            const bgImage = document.getElementById('background-image');
            if (scene.image) {
                bgImage.src = scene.image;
                bgImage.style.display = 'block';
                bgImage.classList.add('fade-in');
            } else {
                bgImage.style.display = 'none';
            }

            // 设置文本内容
            const textContent = document.getElementById('text-content');
            textContent.textContent = scene.text;
            textContent.classList.add('fade-in');

            // 清除旧按钮
            const buttonsContainer = document.getElementById('buttons-container');
            buttonsContainer.innerHTML = '';

            // 添加新按钮
            scene.buttons.forEach(buttonData => {
                const button = document.createElement('button');
                button.textContent = buttonData.text;
                button.id = buttonData.id;
                button.dataset.correct = buttonData.correct;
                button.dataset.nextScene = buttonData.nextScene;
                
                // 设置按钮位置类
                if (buttonData.position === 'left') {
                    button.classList.add('left-button');
                } else if (buttonData.position === 'right') {
                    button.classList.add('right-button');
                } else {
                    button.classList.add('full-button');
                }
                
                // 如果按钮已点击过，禁用它
                if (gameState.clickedButtons.has(buttonData.id)) {
                    button.disabled = true;
                    button.classList.add('disabled');
                }
                
                // 添加点击事件
                button.addEventListener('click', function() {
                    handleButtonClick(this, buttonData);
                });
                
                buttonsContainer.appendChild(button);
            });

            // 预加载下一个场景的图片
            if (scene.buttons.length > 0) {
                const nextSceneId = scene.buttons[0].nextScene;
                if (scenes[nextSceneId] && scenes[nextSceneId].image) {
                    const nextImage = new Image();
                    nextImage.src = scenes[nextSceneId].image;
                }
            }
        }

        // 处理按钮点击
        function handleButtonClick(button, buttonData) {
            // 标记按钮为已点击
            gameState.clickedButtons.add(buttonData.id);
            saveGameState();
            
            // 禁用所有按钮防止多次点击
            document.querySelectorAll('#buttons-container button').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });
            
            // 如果是正确答案，增加分数
            if (buttonData.correct) {
                gameState.score += 6.7;
                gameState.correctAnswers++;
                saveGameState();
            } else {
                // 显示错误提示
                showHint(buttonData.hint);
            }
            
            // 延迟跳转到下一个场景
            setTimeout(() => {
                loadScene(buttonData.nextScene);
            }, buttonData.correct ? 500 : 3000); // 正确选项立即跳转，错误选项显示提示3秒后跳转
        }

        // 显示提示
        function showHint(hintText) {
            const hintBox = document.getElementById('hint-box');
            const hintTextElement = document.getElementById('hint-text');
            
            hintTextElement.textContent = hintText;
            hintBox.classList.remove('hidden');
            hintBox.classList.add('fade-in');
            
            // 3秒后隐藏提示
            setTimeout(() => {
                hintBox.classList.add('fade-out');
                setTimeout(() => {
                    hintBox.classList.remove('fade-in', 'fade-out');
                    hintBox.classList.add('hidden');
                }, 500);
            }, 3000);
        }

        // 显示结果
        function showResults() {
            gameState.endTime = new Date().getTime();
            saveGameState();
            
            // 计算游戏时间（分钟）
            const timeInMinutes = (gameState.endTime - gameState.startTime) / (1000 * 60);
            
            // 计算时间分数（每满1分钟2分，不满1分钟1分）
            const timeScore = Math.floor(timeInMinutes) * 2 + (timeInMinutes % 1 >= 0.5 ? 1 : 0);
            
            // 计算总分数
            const totalScore = Math.max(0, gameState.score - timeScore);
            
            // 计算正确率
            const accuracy = (gameState.correctAnswers / 15 * 100).toFixed(1);
            
            // 创建结果HTML
            const resultsHTML = `
                <div id="results-container" class="fade-in">
                    <h1>游戏结束</h1>
                    <div class="result-item">
                        <span class="result-label">正确率:</span>
                        <span class="result-value">${accuracy}%</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">用时:</span>
                        <span class="result-value">${timeInMinutes.toFixed(1)} 分钟</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">答题得分:</span>
                        <span class="result-value">${gameState.score.toFixed(1)} 分</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">时间扣分:</span>
                        <span class="result-value">-${timeScore} 分</span>
                    </div>
                    <div class="result-item total-score">
                        <span class="result-label">总得分:</span>
                        <span class="result-value">${totalScore.toFixed(1)} 分</span>
                    </div>
                    <button id="restart-button">重新开始</button>
                </div>
            `;
            
            // 显示结果
            document.getElementById('game-container').innerHTML = resultsHTML;
            
            // 重新开始按钮事件
            document.getElementById('restart-button').addEventListener('click', function() {
                // 重置游戏状态
                gameState.score = 0;
                gameState.correctAnswers = 0;
                gameState.startTime = new Date().getTime();
                gameState.endTime = null;
                gameState.currentScene = 2101;
                gameState.clickedButtons = new Set();
                saveGameState();
                
                // 重新加载游戏
                window.location.href = 'index.html';
            });
        }

        // 保存游戏状态到sessionStorage
        function saveGameState() {
            sessionStorage.setItem('gameState', JSON.stringify({
                ...gameState,
                clickedButtons: Array.from(gameState.clickedButtons) // 转换Set为数组以便序列化
            }));
        }

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', initializeChapterGame);
    </script>
</body>
</html>
