<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tenses Journey - Game</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <!-- All game screens will be dynamically shown/hidden -->
    <div id="game-container">
        <!-- Chapter 1 Screens -->
        <div id="screen-2101" class="game-screen hidden">
            <img src="images/画面01.jpg" alt="Scene 1" class="game-image">
            <div class="text-box">
                <p>Tom lives in a magical world and ____ the school library every day.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2102" class="game-button">cleans</button>
                <button data-correct="false" data-next="2102" class="game-button">cleaning</button>
            </div>
        </div>

        <div id="screen-2102" class="game-screen hidden">
            <img src="images/画面02.jpg" alt="Scene 2" class="game-image">
            <div class="text-box">
                <p>Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2103" class="game-button">locked</button>
                <button data-correct="false" data-next="2103" class="game-button">locks</button>
            </div>
        </div>

        <div id="screen-2103" class="game-screen hidden">
            <img src="images/画面03.jpg" alt="Scene 3" class="game-image">
            <div class="text-box">
                <p>Tom walked over curiously and saw a magic wand with a flashing blue light, with a label next to it that read: Tense Magic wand.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2104" class="game-button">continue</button>
            </div>
        </div>

        <div id="screen-2104" class="game-screen hidden">
            <img src="images/画面04.jpg" alt="Scene 4" class="game-image">
            <div class="text-box">
                <p>Tom became curious and hid his magic wand in his clothes before taking it away from the library He ____ outdoors tomorrow to test the power of the magic wand.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2201" class="game-button">will go</button>
                <button data-correct="false" data-next="2201" class="game-button">is going</button>
            </div>
        </div>

        <!-- Chapter 2 Screens -->
        <div id="screen-2201" class="game-screen hidden">
            <img src="images/画面05.jpg" alt="Scene 5" class="game-image">
            <div class="text-box">
                <p>The next morning, he ____ a magic broom towards a forest next to the school.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2202" class="game-button">is riding</button>
                <button data-correct="false" data-next="2202" class="game-button">has ridden</button>
            </div>
        </div>

        <div id="screen-2202" class="game-screen hidden">
            <img src="images/画面06.jpg" alt="Scene 6" class="game-image">
            <div class="text-box">
                <p>At this time yesterday, Tom was cleaning the library. He was supposed to be organizing books in the library today, but he thought this magic wand would be fun. So I decided to slack off and not go to the library anymore.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2203" class="game-button">was cleaning</button>
                <button data-correct="false" data-next="2203" class="game-button">is cleaning</button>
            </div>
        </div>

        <div id="screen-2203" class="game-screen hidden">
            <img src="images/画面07.jpg" alt="Scene 7" class="game-image">
            <div class="text-box">
                <p>Tom will be tidying up the library early tomorrow to prevent library director Jimmy from discovering his laziness.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2301" class="game-button">will be tidying up</button>
                <button data-correct="false" data-next="2301" class="game-button">is tidying up</button>
            </div>
        </div>

        <!-- Chapter 3 Screens -->
        <div id="screen-2301" class="game-screen hidden">
            <img src="images/画面08.jpg" alt="Scene 8" class="game-image">
            <div class="text-box">
                <p>Tom stops by the stream in the forest and ____ the magic wand from his clothes. He thought that the magic wand is called a tense magic wand. Is the spell that activates it related to tense?</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2302" class="game-button">takes out</button>
                <button data-correct="false" data-next="2302" class="game-button">will take out</button>
            </div>
        </div>

        <div id="screen-2302" class="game-screen hidden">
            <img src="images/画面09.jpg" alt="Scene 9" class="game-image">
            <div class="text-box">
                <p>So he decided to try combining the spells he learned at the magic school. Tom pointed his magic wand at the stream and said, 'A delicious fish ____.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2304" class="game-button">has been grilled</button>
                <button data-correct="false" data-next="2304" class="game-button">will be grilled</button>
            </div>
        </div>

        <div id="screen-2303" class="game-screen hidden">
            <img src="images/画面10.jpg" alt="Scene 10" class="game-image">
            <div class="text-box">
                <p>After reciting the spell, a sudden blue flash appeared. Then a grill made of tree branches appeared in front of Tom, with a fragrant grilled fish on top.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2304" class="game-button">Continue</button>
            </div>
        </div>

        <div id="screen-2304" class="game-screen hidden">
            <img src="images/画面11.jpg" alt="Scene 11" class="game-image">
            <div class="text-box">
                <p>Tom hadn't had breakfast before coming here, and his stomach was growling. Tom ____ the grilled fish and begins eating.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2305" class="game-button">has taken</button>
                <button data-correct="false" data-next="2305" class="game-button">will take</button>
            </div>
        </div>

        <div id="screen-2305" class="game-screen hidden">
            <img src="images/画面12.jpg" alt="Scene 12" class="game-image">
            <div class="text-box">
                <p>Tom thinks that now he has the powerful wand. And the wizard who always bullies me ____ by him.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2401" class="game-button">will have been defeated</button>
                <button data-correct="false" data-next="2401" class="game-button">has been defeated</button>
            </div>
        </div>

        <!-- Chapter 4 Screens -->
        <div id="screen-2401" class="game-screen hidden">
            <img src="images/画面13.jpg" alt="Scene 13" class="game-image">
            <div class="text-box">
                <p>Although Tom ____ magic at the school for a year, his knowledge of magic is still inferior to that of wizard Mike.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2402" class="game-button">has been studying</button>
                <button data-correct="false" data-next="2402" class="game-button">will studying</button>
            </div>
        </div>

        <div id="screen-2402" class="game-screen hidden">
            <img src="images/画面14.jpg" alt="Scene 14" class="game-image">
            <div class="text-box">
                <p>So Tom came to the house of the wizard Mike who used to tease him. Tom shouted at Mike, 'I ____ magic to defeat you. Come out and accept my challenge.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2403" class="game-button">will use</button>
                <button data-correct="false" data-next="2403" class="game-button">am using</button>
            </div>
        </div>

        <div id="screen-2403" class="game-screen hidden">
            <img src="images/画面15.jpg" alt="Scene 15" class="game-image">
            <div class="text-box">
                <p>Mike walked out of the room and said, 'Tom, you ____ to me over the past year. Are you still not willing to give up?'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2404" class="game-button">had been repeatedly losing</button>
                <button data-correct="false" data-next="2404" class="game-button">was losing</button>
            </div>
        </div>

        <div id="screen-2404" class="game-screen hidden">
            <img src="images/画面16.jpg" alt="Scene 16" class="game-image">
            <div class="text-box">
                <p>Tom pointed his magic wand at the sky and cursed 'It's going to rain soon,' and the wand emitted blue light.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2405" class="game-button">Continue</button>
            </div>
        </div>

        <div id="screen-2405" class="game-screen hidden">
            <img src="images/画面17.jpg" alt="Scene 17" class="game-image">
            <div class="text-box">
                <p>Before long, dark clouds appeared in the sky, thunder started to strike, and raindrops began to fall.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2406" class="game-button">Continue</button>
            </div>
        </div>

        <div id="screen-2406" class="game-screen hidden">
            <img src="images/画面18.jpg" alt="Scene 18" class="game-image">
            <div class="text-box">
                <p>By tomorrow, Mike ____ magic for 2 years now. But Mike was still stunned when he saw Tom's magic. Mike had never seen such a powerful magic before and said to Tom, 'I admit you're already better than me.'</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2407" class="game-button">will have been studying</button>
                <button data-correct="false" data-next="2407" class="game-button">will be studying</button>
            </div>
        </div>

        <div id="screen-2407" class="game-screen hidden">
            <img src="images/画面19.jpg" alt="Scene 19" class="game-image">
            <div class="text-box">
                <p>Tom wants to show off the power of his magic wand again and is ready to recite the next spell. But suddenly a beam of light flashed and the library director Jimmy appeared in front of him.</p>
            </div>
            <div class="button-container single-button">
                <button data-next="2408" class="game-button">Continue</button>
            </div>
        </div>

        <div id="screen-2408" class="game-screen hidden">
            <img src="images/画面20.jpg" alt="Scene 20" class="game-image">
            <div class="text-box">
                <p>Library director Jimmy said to Tom, 'I ____ for it all day, but you took it away.'.</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2409" class="game-button">have been looking</button>
                <button data-correct="false" data-next="2409" class="game-button">am looking</button>
            </div>
        </div>

        <div id="screen-2409" class="game-screen hidden">
            <img src="images/画面21.jpg" alt="Scene 21" class="game-image">
            <div class="text-box">
                <p>Jimmy raised his hand, and the magic wand automatically flew into Jimmy's hand. Then Jimmy shouted at Tom, 'Hurry back and clean the library for me.'</p>
            </div>
            <div class="button-container single-button">
                <button id="game-over-btn" class="game-button">Game over</button>
            </div>
        </div>

        <!-- Leaderboard Screen (ID:2501) -->
        <div id="screen-2501" class="game-screen hidden">
            <div class="info-box">
                <h2>Room: <span id="room-display"></span></h2>
                <p>Players: <span id="player-count">0</span></p>
            </div>
            <div class="leaderboard-container">
                <table id="leaderboard-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Accuracy</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboard-body">
                        <!-- Leaderboard rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Hint Modal -->
    <div id="hint-modal" class="modal">
        <div class="modal-content">
            <p id="hint-message"></p>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const roomId = urlParams.get('room');
        const isTeacher = urlParams.get('teacher') === 'true';
        const playerId = urlParams.get('player') || generatePlayerId();
        const playerNickname = decodeURIComponent(urlParams.get('nickname') || '');

        // Game state variables
        let currentScreen = '';
        let correctAnswers = 0;
        let startTime = 0;
        let gameFinished = false;
        let playerRef;
        let roomRef;
        let playerData = {
            nickname: playerNickname,
            score: 0,
            accuracy: 0,
            time: 0,
            progress: 0,
            finished: false,
            lastUpdated: 0
        };

        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const hintModal = document.getElementById('hint-modal');
        const hintMessage = document.getElementById('hint-message');
        const gameOverBtn = document.getElementById('game-over-btn');
        const roomDisplay = document.getElementById('room-display');
        const playerCount = document.getElementById('player-count');
        const leaderboardBody = document.getElementById('leaderboard-body');

        // Initialize game
        function initGame() {
            // Set up Firebase references
            roomRef = database.ref('rooms/' + roomId);
            playerRef = database.ref('rooms/' + roomId + '/players/' + playerId);
            
            // Set up room display
            if (roomDisplay) {
                roomDisplay.textContent = roomId;
            }
            
            // If teacher, just show leaderboard
            if (isTeacher) {
                showScreen('2501');
                setupLeaderboardUpdates();
                return;
            }
            
            // Validate player data
            if (!playerNickname || playerNickname.length > 12) {
                alert('Invalid nickname. Redirecting to home page.');
                window.location.href = 'index.html';
                return;
            }
            
            // Start game timer
            startTime = Date.now();
            
            // Set up player data in Firebase
            playerData = {
                nickname: playerNickname,
                score: 0,
                accuracy: 0,
                time: 0,
                progress: 0,
                finished: false,
                lastUpdated: firebase.database.ServerValue.TIMESTAMP
            };
            
            playerRef.set(playerData)
                .then(() => {
                    // Start game
                    showScreen('2101');
                    
                    // Set up periodic updates
                    setInterval(updatePlayerData, 3000);
                    
                    // Set up button event listeners
                    setupButtonListeners();
                    
                    // Set up game over button
                    if (gameOverBtn) {
                        gameOverBtn.addEventListener('click', finishGame);
                    }
                    
                    // Preload next image
                    preloadImage('画面02.jpg');
                })
                .catch((error) => {
                    console.error('Error setting player data:', error);
                    alert('Error joining game. Please try again.');
                    window.location.href = 'index.html';
                });
        }

        // Generate player ID if not provided
        function generatePlayerId() {
            return 'player-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }

        // Show a specific screen
        function showScreen(screenId) {
            // Hide all screens
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Show the requested screen
            const screen = document.getElementById('screen-' + screenId);
            if (screen) {
                screen.classList.remove('hidden');
                currentScreen = screenId;
                
                // Update progress if not on leaderboard
                if (screenId !== '2501') {
                    updateProgress();
                }
                
                // Preload next image if available
                const nextScreen = getNextScreen(screenId);
                if (nextScreen) {
                    const nextScreenId = nextScreen.replace('screen-', '');
                    const nextImage = getImageForScreen(nextScreenId);
                    if (nextImage) {
                        preloadImage(nextImage);
                    }
                }
            }
        }

        // Get the next screen element after the current one
        function getNextScreen(currentScreenId) {
            const screens = Array.from(document.querySelectorAll('.game-screen'));
            const currentIndex = screens.findIndex(screen => screen.id === 'screen-' + currentScreenId);
            
            if (currentIndex !== -1 && currentIndex < screens.length - 1) {
                return screens[currentIndex + 1].id;
            }
            return null;
        }

        // Get image filename for a screen
        function getImageForScreen(screenId) {
            // This is a simplified version - in a real app you might want a more robust mapping
            if (screenId.startsWith('21')) return '画面0' + screenId.slice(-1) + '.jpg';
            if (screenId.startsWith('22')) return '画面0' + (parseInt(screenId.slice(-1)) + 4) + '.jpg';
            if (screenId.startsWith('23')) return '画面' + (parseInt(screenId.slice(-1)) + 7) + '.jpg';
            if (screenId.startsWith('24')) return '画面' + (parseInt(screenId.slice(-1)) + 12) + '.jpg';
            return null;
        }

        // Preload an image
        function preloadImage(imageName) {
            const img = new Image();
            img.src = 'images/' + imageName;
        }

        // Set up button event listeners
        function setupButtonListeners() {
            document.querySelectorAll('.game-button').forEach(button => {
                button.addEventListener('click', function() {
                    // Disable button to prevent multiple clicks
                    this.disabled = true;
                    
                    // Get button data attributes
                    const isCorrect = this.getAttribute('data-correct') === 'true';
                    const nextScreen = this.getAttribute('data-next');
                    
                    // Update score if answer is correct
                    if (isCorrect === true) {
                        correctAnswers++;
                        updateScore();
                    } else {
                        // Show hint for incorrect answer
                        showHint(this);
                    }
                    
                    // Move to next screen after delay if needed
                    if (nextScreen) {
                        if (isCorrect || !nextScreen) {
                            setTimeout(() => showScreen(nextScreen), isCorrect ? 0 : 3000);
                        }
                    }
                });
            });
        }

        // Show hint for incorrect answer
        function showHint(button) {
            const screenId = button.closest('.game-screen').id.replace('screen-', '');
            let hintText = '';
            
            // Set hint text based on screen
            switch(screenId) {
                case '2101':
                    hintText = 'Daily behavior is expressed in the present tense';
                    break;
                case '2102':
                    hintText = 'Describe the simple behavior that occurred yesterday in the past simple tense';
                    break;
                case '2104':
                    hintText = 'Describe simple behaviors that will occur in the future using general future tense';
                    break;
                case '2201':
                    hintText = 'Describe the ongoing behavior in present continuous tense';
                    break;
                case '2202':
                    hintText = '描述过去正在进行的行为用过去进行时';
                    break;
                case '2203':
                    hintText = 'Describe the ongoing behavior in the future using future continuous tense';
                    break;
                case '2301':
                    hintText = 'Describe daily behavior in the present tense';
                    break;
                case '2302':
                    hintText = 'The spell didn\'t take effect, Tom recited a delicious fish that had already been grilled';
                    break;
                case '2304':
                    hintText = 'Describe completed actions in present perfect tense';
                    break;
                case '2305':
                    hintText = 'Describe the behavior to be completed in the future using the future perfect tense';
                    break;
                case '2401':
                    hintText = 'The action has been ongoing from the past to the present, and may have just ended or is still ongoing, using the present to complete the ongoing tense';
                    break;
                case '2402':
                    hintText = 'Describe future actions using future continuous tense';
                    break;
                case '2403':
                    hintText = 'A certain past action started earlier in the past and continued until a certain point in time, possibly still continuing or just stopped';
                    break;
                case '2406':
                    hintText = 'Emphasize how long a certain action has been ongoing until a certain point in the future, using the future completion continuous time';
                    break;
                case '2408':
                    hintText = 'Describe actions that have been completed in the past and use them to complete them';
                    break;
                default:
                    hintText = 'Incorrect answer';
            }
            
            // Show hint
            hintMessage.textContent = hintText;
            hintModal.style.display = 'flex';
            
            // Hide hint after 3 seconds
            setTimeout(() => {
                hintModal.style.display = 'none';
            }, 3000);
        }

        // Update player score
        function updateScore() {
            // Each correct answer is worth 6.7 points
            playerData.score = Math.min(100, Math.round(correctAnswers * 6.7));
            playerData.accuracy = parseFloat(((correctAnswers / 15) * 100).toFixed(1));
            updatePlayerData();
        }

        // Update player progress
        function updateProgress() {
            // Calculate progress based on current screen
            const screenNumber = parseInt(currentScreen.replace(/^\D+/g, ''));
            playerData.progress = Math.round((screenNumber - 2100) / 21 * 100);
            updatePlayerData();
        }

        // Update player time
        function updateTime() {
            const elapsedTime = Date.now() - startTime;
            const minutes = Math.floor(elapsedTime / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);
            
            // Time score: 2 points per full minute, 1 point for partial minute
            const timeScore = minutes * 2 + (seconds > 0 ? 1 : 0);
            
            playerData.time = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            playerData.score = Math.min(100, Math.round(correctAnswers * 6.7 + timeScore));
            updatePlayerData();
        }

        // Update player data in Firebase
        function updatePlayerData() {
            if (!gameFinished) {
                updateTime();
                playerData.lastUpdated = firebase.database.ServerValue.TIMESTAMP;
                
                playerRef.update(playerData)
                    .catch(error => {
                        console.error('Error updating player data:', error);
                    });
            }
        }

        // Finish the game
        function finishGame() {
            gameFinished = true;
            playerData.finished = true;
            playerData.lastUpdated = firebase.database.ServerValue.TIMESTAMP;
            
            // Calculate final score
            updateTime();
            
            // Update Firebase
            playerRef.update(playerData)
                .then(() => {
                    // Show leaderboard
                    showScreen('2501');
                    setupLeaderboardUpdates();
                })
                .catch(error => {
                    console.error('Error finishing game:', error);
                    showScreen('2501');
                    setupLeaderboardUpdates();
                });
        }

        // Set up leaderboard updates
        function setupLeaderboardUpdates() {
            // Listen for player count changes
            roomRef.child('players').on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const activePlayers = Object.values(players).filter(p => !p.finished).length;
                const totalPlayers = Object.keys(players).length;
                
                if (playerCount) {
                    playerCount.textContent = `${activePlayers}/${totalPlayers}`;
                }
                
                // Update leaderboard
                updateLeaderboard(players);
            });
        }

        // Update leaderboard with player data
        function updateLeaderboard(players) {
            if (!leaderboardBody) return;
            
            // Convert players object to array and filter finished players
            const playersArray = Object.entries(players)
                .filter(([_, player]) => player.finished)
                .map(([id, player]) => ({
                    id,
                    ...player
                }));
            
            // Sort by score (descending)
            playersArray.sort((a, b) => b.score - a.score);
            
            // Clear current leaderboard
            leaderboardBody.innerHTML = '';
            
            // Add top 10 players to leaderboard
            playersArray.slice(0, 10).forEach((player, index) => {
                const row = document.createElement('tr');
                
                // Highlight current player's row
                if (player.id === playerId) {
                    row.classList.add('highlight');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.nickname}</td>
                    <td>${player.score}</td>
                    <td>${player.accuracy}%</td>
                    <td>${player.time}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
        }

        // Initialize the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
