<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>英语时态魔法棒 - 游戏</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- 章节1 -->
        <!-- 画面01 (页面ID:2101) -->
        <div id="page-2101" class="game-page">
            <img src="images/画面01.jpg" alt="画面01" class="game-image">
            <div class="text-box">
                <p>主人公Tom生活在魔法世界的魔法学校里，他每天都_____图书馆。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2102" class="game-button">打扫</button>
                <button data-correct="false" data-next="2102" class="game-button">正在打扫</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>日常行为用一般现在时</p>
            </div>
        </div>

        <!-- 画面02 (页面ID:2102) -->
        <div id="page-2102" class="game-page">
            <img src="images/画面02.jpg" alt="画面02" class="game-image">
            <div class="text-box">
                <p>有一天，Tom发现他昨天_____的一个箱子今天被打开了，并且里面冒着蓝光。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2103" class="game-button">锁上</button>
                <button data-correct="false" data-next="2103" class="game-button">正在锁上</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述昨天发生的简单行为用一般过去时</p>
            </div>
        </div>

        <!-- 画面03 (页面ID:2103) -->
        <div id="page-2103" class="game-page">
            <img src="images/画面03.jpg" alt="画面03" class="game-image">
            <div class="text-box">
                <p>Tom好奇，走进一看，是个闪着蓝光的魔法棒，旁白有个标签，写着：时态魔法棒。</p>
            </div>
            <div class="button-container">
                <button data-next="2104" class="game-button">继续</button>
            </div>
        </div>

        <!-- 画面04 (页面ID:2104) -->
        <div id="page-2104" class="game-page">
            <img src="images/画面04.jpg" alt="画面04" class="game-image">
            <div class="text-box">
                <p>Tom心生好奇，他把魔法棒藏在衣服里，带离了图书馆，准备明天_____户外试一下魔法棒的威力。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2201" class="game-button">将去</button>
                <button data-correct="false" data-next="2201" class="game-button">已经去</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述未来发生的简单行为用一般将来时</p>
            </div>
        </div>

        <!-- 章节2 -->
        <!-- 画面05 (页面ID:2201) -->
        <div id="page-2201" class="game-page">
            <img src="images/画面05.jpg" alt="画面05" class="game-image">
            <div class="text-box">
                <p>时间来到第二天早上，他_____着魔法扫帚飞往学习旁边的一个森林里。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2202" class="game-button">正在骑</button>
                <button data-correct="false" data-next="2202" class="game-button">已经骑</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述正在进行的行为用现在进行时</p>
            </div>
        </div>

        <!-- 画面06 (页面ID:2202) -->
        <div id="page-2202" class="game-page">
            <img src="images/画面06.jpg" alt="画面06" class="game-image">
            <div class="text-box">
                <p>昨天这个时候，Tom正_____图书馆，但他觉得这个魔法棒会很好玩，所以决定今天不去打扫图书馆了。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2203" class="game-button">正在打扫</button>
                <button data-correct="false" data-next="2203" class="game-button">已经打扫</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述过去正在进行的行为用过去进行时</p>
            </div>
        </div>

        <!-- 画面07 (页面ID:2203) -->
        <div id="page-2203" class="game-page">
            <img src="images/画面07.jpg" alt="画面07" class="game-image">
            <div class="text-box">
                <p>为了防止图书馆馆长Jimmy发现Tom偷懒，Tom将很早到达将图书馆进行_____。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2301" class="game-button">打扫</button>
                <button data-correct="false" data-next="2301" class="game-button">已经打扫</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述将来正在进行的行为用将来进行时</p>
            </div>
        </div>

        <!-- 章节3 -->
        <!-- 画面08 (页面ID:2301) -->
        <div id="page-2301" class="game-page">
            <img src="images/画面08.jpg" alt="画面08" class="game-image">
            <div class="text-box">
                <p>Tom停在了森林里的小溪旁边，然后从衣服里___魔法棒。他想，这魔法棒叫时态魔法棒，难道启动它的咒语和时态有关？</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2302" class="game-button">拿出</button>
                <button data-correct="false" data-next="2302" class="game-button">已经拿出</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述日常行为一般现在时</p>
            </div>
        </div>

        <!-- 画面09 (页面ID:2302) -->
        <div id="page-2302" class="game-page">
            <img src="images/画面09.jpg" alt="画面09" class="game-image">
            <div class="text-box">
                <p>于是，他决定结合在魔法学校学习的咒语试一下。Tom用魔法棒指向小溪，念了一句一条香喷喷的鱼____了</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2304" class="game-button">已经被烤熟</button>
                <button data-correct="false" data-next="2304" class="game-button">将来被烤熟</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>咒语未生效，Tom重新念了一条香喷喷的鱼已经被烤熟了</p>
            </div>
        </div>

        <!-- 画面10 (页面ID:2303) -->
        <div id="page-2303" class="game-page">
            <img src="images/画面10.jpg" alt="画面10" class="game-image">
            <div class="text-box">
                <p>只见念完咒语之后，突然一道蓝色闪光过后，一个用树枝做的烤架，上面有一条香喷喷的烤鱼出现在了Tom的面前。</p>
            </div>
            <div class="button-container">
                <button data-next="2304" class="game-button">继续</button>
            </div>
        </div>

        <!-- 画面11 (页面ID:2304) -->
        <div id="page-2304" class="game-page">
            <img src="images/画面11.jpg" alt="画面11" class="game-image">
            <div class="text-box">
                <p>Tom想，我来这之前，还没吃东西呢。正好可以包餐一顿。Tom拿起吃了起来。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2305" class="game-button">已经烤好的鱼</button>
                <button data-correct="false" data-next="2305" class="game-button">将要烤好</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述已经完成的的行为用现在完成时</p>
            </div>
        </div>

        <!-- 画面12 (页面ID:2305) -->
        <div id="page-2305" class="game-page">
            <img src="images/画面12.jpg" alt="画面12" class="game-image">
            <div class="text-box">
                <p>Tom边吃边想，当我掌握了这根魔杖，那个总是欺负我的巫师就会被打败。【将来完成】。（By the time I have mastered this magic wand, the wizard who always bullies me will have been defeated.）</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2401" class="game-button">将会被打败</button>
                <button data-correct="false" data-next="2401" class="game-button">已经被打败</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述将来完成的的行为用将来完成时</p>
            </div>
        </div>

        <!-- 章节4 -->
        <!-- 画面13 (页面ID:2401) -->
        <div id="page-2401" class="game-page">
            <img src="images/画面13.jpg" alt="画面13" class="game-image">
            <div class="text-box">
                <p>虽然Tom已经来到魔法学校_____一年时间【现在完成进行】，但是魔法的知识还是比不过巫师Mike。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2402" class="game-button">学习了</button>
                <button data-correct="false" data-next="2402" class="game-button">将学习</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述过去的行为持续到现在用现在完成进行</p>
            </div>
        </div>

        <!-- 画面14 (页面ID:2402) -->
        <div id="page-2402" class="game-page">
            <img src="images/画面14.jpg" alt="画面14" class="game-image">
            <div class="text-box">
                <p>Tom意识到了魔法棒的厉害之处，于是Tom来到了以前经常戏弄他的巫师Mike的家里。Tom说Mike，现在我_____魔法打败你了，你出来接受我的挑战吧</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2403" class="game-button">可以用</button>
                <button data-correct="false" data-next="2403" class="game-button">正在用</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述正在进行的行为用现在进行时</p>
            </div>
        </div>

        <!-- 画面15 (页面ID:2403) -->
        <div id="page-2403" class="game-page">
            <img src="images/画面15.jpg" alt="画面15" class="game-image">
            <div class="text-box">
                <p>今天是个阳光明媚的日子，只见Mike带着一个大大的灰色巫师帽从房间里走了出来，说到"Tom，在过去的一年时间里，已经多次_____我了。（You had been repeatedly losing to me over the past year.）还是不服输吗"</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2404" class="game-button">输给</button>
                <button data-correct="false" data-next="2404" class="game-button">将输给</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述正在进行的行为用现在进行时</p>
            </div>
        </div>

        <!-- 画面16 (页面ID:2404) -->
        <div id="page-2404" class="game-page">
            <img src="images/画面16.jpg" alt="画面16" class="game-image">
            <div class="text-box">
                <p>只见Tom用魔法棒指向天空，用咒语说了一句It's going to rain soon，魔法棒发出来蓝光。</p>
            </div>
            <div class="button-container">
                <button data-next="2405" class="game-button">继续</button>
            </div>
        </div>

        <!-- 画面17 (页面ID:2405) -->
        <div id="page-2405" class="game-page">
            <img src="images/画面17.jpg" alt="画面17" class="game-image">
            <div class="text-box">
                <p>果然，不一会儿天空出现了乌云，打起了雷，开始下起了下雨点。</p>
            </div>
            <div class="button-container">
                <button data-next="2406" class="game-button">继续</button>
            </div>
        </div>

        <!-- 画面18 (页面ID:2406) -->
        <div id="page-2406" class="game-page">
            <img src="images/画面18.jpg" alt="画面18" class="game-image">
            <div class="text-box">
                <p>Mike看见后下了一跳，说到到明天为止，我已经学了魔法2年了（By tomorrow, I have been studying magic for 2 years now）。却从来没看过这么厉害的魔法，我承认你已经比我厉害了</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2407" class="game-button">已经学了</button>
                <button data-correct="false" data-next="2407" class="game-button">将要学</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述将来完成进行时</p>
            </div>
        </div>

        <!-- 画面19 (页面ID:2407) -->
        <div id="page-2407" class="game-page">
            <img src="images/画面19.jpg" alt="画面19" class="game-image">
            <div class="text-box">
                <p>Tom想再炫耀一下魔法棒的威力，准备念出下一个咒语时，突然一道光闪过，图书馆馆长Jimmy出现在面前。</p>
            </div>
            <div class="button-container">
                <button data-next="2408" class="game-button">继续</button>
            </div>
        </div>

        <!-- 画面20 (页面ID:2408) -->
        <div id="page-2408" class="game-page">
            <img src="images/画面20.jpg" alt="画面20" class="game-image">
            <div class="text-box">
                <p>馆长说到Tom，我找了它找了一整天，原来被你拿走了。</p>
            </div>
            <div class="button-container">
                <button data-correct="true" data-next="2409" class="game-button">找了</button>
                <button data-correct="false" data-next="2409" class="game-button">将找</button>
            </div>
            <div class="hint-box" style="display: none;">
                <p>描述过去完成</p>
            </div>
        </div>

        <!-- 画面21 (页面ID:2409) -->
        <div id="page-2409" class="game-page">
            <img src="images/画面21.jpg" alt="画面21" class="game-image">
            <div class="text-box">
                <p>Jimmy举起手，魔法棒自动飞到Jimmy的手里。然后，Jimmy领着Tom，说道:赶紧回去给我打扫图书馆.....</p>
            </div>
            <div class="button-container">
                <button id="end-game-btn" class="game-button">游戏结束</button>
            </div>
        </div>

        <!-- 排名画面22 (页面ID:2501) -->
        <div id="page-2501" class="game-page">
            <div class="ranking-header">
                <h2>排行榜</h2>
                <div class="room-info">
                    <p>房间号: <span id="room-code-display"></span></p>
                    <p>当前玩家: <span id="player-count">0</span>人</p>
                </div>
            </div>
            <div class="ranking-table-container">
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>名称</th>
                            <th>总分数</th>
                            <th>正确率</th>
                            <th>用时</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-table-body">
                        <!-- 排行榜数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 提示框 (隐藏) -->
        <div id="hint-modal" class="modal">
            <div class="modal-content">
                <p id="hint-message"></p>
            </div>
        </div>
    </div>

    <script>
        // 初始化游戏变量
        let currentPage = '';
        let nextPage = '';
        let correctAnswers = 0;
        let startTime = 0;
        let endTime = 0;
        let timeUsed = 0;
        let totalScore = 0;
        let accuracy = 0;
        let progress = 0;
        let playerData = {};
        
        // 从URL获取参数
        const urlParams = new URLSearchParams(window.location.search);
        const roomCode = urlParams.get('room');
        const playerId = urlParams.get('player');
        const isTeacher = urlParams.get('teacher') === 'true';
        
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.appspot.com",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // 初始化Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();
        } catch (error) {
            console.error("Firebase初始化错误:", error);
            showHint("数据库连接失败，请刷新页面重试");
        }

        // DOM元素
        const gameContainer = document.getElementById('game-container');
        const endGameBtn = document.getElementById('end-game-btn');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const playerCountDisplay = document.getElementById('player-count');
        const rankingTableBody = document.getElementById('ranking-table-body');
        const hintModal = document.getElementById('hint-modal');
        const hintMessage = document.getElementById('hint-message');

        // 显示提示框
        function showHint(message, duration = 3000) {
            hintMessage.textContent = message;
            hintModal.style.display = 'flex';
            
            if (duration > 0) {
                setTimeout(() => {
                    hintModal.style.display = 'none';
                }, duration);
            }
        }

        // 隐藏提示框
        function hideHint() {
            hintModal.style.display = 'none';
        }

        // 计算分数
        function calculateScore() {
            // 计算正确率 (保留一位小数)
            accuracy = Math.round((correctAnswers / 15) * 100 * 10) / 10;
            
            // 计算时间分数 (每满一分钟2分，不满1分)
            const minutes = Math.floor(timeUsed / 60);
            const seconds = timeUsed % 60;
            const timeScore = minutes * 2 + (seconds > 0 ? 1 : 0);
            
            // 计算总分数 (N-时间分数，不超过100)
            totalScore = Math.min(100, Math.round(correctAnswers * 6.7 - timeScore));
            totalScore = Math.max(0, totalScore); // 确保分数不为负
            
            return {
                score: totalScore,
                accuracy: accuracy,
                timeUsed: timeUsed
            };
        }

        // 更新玩家数据到数据库
        function updatePlayerData() {
            const database = firebase.database();
            const playerRef = database.ref(`rooms/${roomCode}/players/${playerId}`);
            
            // 计算当前进度 (当前页数/21)
            const currentPageNumber = parseInt(currentPage.split('-')[1]);
            progress = Math.round((currentPageNumber - 2100) / 21 * 100);
            
            // 计算用时 (秒)
            timeUsed = Math.floor((Date.now() - startTime) / 1000);
            
            // 准备玩家数据
            playerData = {
                ...playerData,
                progress: progress,
                timeUsed: timeUsed,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            // 更新到数据库
            playerRef.update(playerData)
                .catch((error) => {
                    console.error("更新玩家数据错误:", error);
                });
        }

        // 游戏结束时更新最终数据
        function updateFinalData() {
            const database = firebase.database();
            const playerRef = database.ref(`rooms/${roomCode}/players/${playerId}`);
            
            // 计算最终分数
            const scores = calculateScore();
            
            // 准备最终数据
            playerData = {
                ...playerData,
                score: scores.score,
                accuracy: scores.accuracy,
                timeUsed: scores.timeUsed,
                progress: 100,
                status: 'completed',
                completedAt: firebase.database.ServerValue.TIMESTAMP
            };
            
            // 更新到数据库
            playerRef.update(playerData)
                .catch((error) => {
                    console.error("更新最终数据错误:", error);
                });
        }

        // 加载排行榜数据
        function loadRankingData() {
            const database = firebase.database();
            const playersRef = database.ref(`rooms/${roomCode}/players`);
            
            // 监听玩家数据变化
            playersRef.on('value', (snapshot) => {
                const players = snapshot.val() || {};
                const playerList = [];
                
                // 转换玩家数据为数组
                for (const [id, data] of Object.entries(players)) {
                    // 排除老师
                    if (id !== players[roomCode]?.teacherId) {
                        playerList.push({
                            id: id,
                            ...data
                        });
                    }
                }
                
                // 更新玩家数量
                playerCountDisplay.textContent = playerList.length;
                
                // 按分数排序
                playerList.sort((a, b) => (b.score || 0) - (a.score || 0));
                
                // 清空排行榜
                rankingTableBody.innerHTML = '';
                
                // 填充排行榜 (最多10个)
                playerList.slice(0, 10).forEach((player, index) => {
                    const row = document.createElement('tr');
                    
                    // 如果是当前玩家，高亮显示
                    if (player.id === playerId) {
                        row.classList.add('current-player');
                    }
                    
                    // 计算用时显示 (分钟:秒)
                    const minutes = Math.floor((player.timeUsed || 0) / 60);
                    const seconds = (player.timeUsed || 0) % 60;
                    const timeDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.name || '未知'}</td>
                        <td>${player.score || 0}</td>
                        <td>${player.accuracy || 0}%</td>
                        <td>${timeDisplay}</td>
                    `;
                    
                    rankingTableBody.appendChild(row);
                });
            });
        }

        // 切换页面
        function switchPage(pageId) {
            // 隐藏所有页面
            document.querySelectorAll('.game-page').forEach(page => {
                page.classList.remove('active');
            });
            
            // 显示目标页面
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
                currentPage = `page-${pageId}`;
                
                // 如果是排行榜页面，加载数据
                if (pageId === '2501') {
                    roomCodeDisplay.textContent = roomCode;
                    loadRankingData();
                }
                
                // 更新玩家进度数据
                if (pageId !== '2501') {
                    updatePlayerData();
                }
            } else {
                console.error(`找不到页面: ${pageId}`);
            }
        }

        // 预加载下一张图片
        function preloadNextImage(nextPageId) {
            const nextImageNumber = parseInt(nextPageId) - 2000;
            const nextImageName = `画面${nextImageNumber.toString().padStart(2, '0')}.jpg`;
            const nextImage = new Image();
            nextImage.src = `images/${nextImageName}`;
        }

        // 初始化游戏
        function initGame() {
            // 设置初始页面
            if (isTeacher) {
                switchPage('2501'); // 老师直接进入排行榜
                return;
            }
            
            // 玩家从第一页开始
            switchPage('2101');
            startTime = Date.now();
            
            // 获取玩家初始数据
            const database = firebase.database();
            const playerRef = database.ref(`rooms/${roomCode}/players/${playerId}`);
            
            playerRef.once('value')
                .then((snapshot) => {
                    playerData = snapshot.val() || {};
                    correctAnswers = playerData.correctAnswers || 0;
                })
                .catch((error) => {
                    console.error("获取玩家数据错误:", error);
                });
            
            // 为所有按钮添加点击事件
            document.querySelectorAll('.game-button').forEach(button => {
                button.addEventListener('click', function() {
                    // 禁用按钮防止重复点击
                    this.disabled = true;
                    
                    // 检查是否是正确答案
                    const isCorrect = this.getAttribute('data-correct') === 'true';
                    if (isCorrect) {
                        correctAnswers++;
                    }
                    
                    // 获取下一页ID
                    const nextPageId = this.getAttribute('data-next');
                    
                    // 如果有提示框且回答错误，显示提示
                    const hintBox = this.closest('.game-page').querySelector('.hint-box');
                    if (hintBox && !isCorrect) {
                        hintBox.style.display = 'block';
                        setTimeout(() => {
                            hintBox.style.display = 'none';
                            if (nextPageId) {
                                preloadNextImage(nextPageId);
                                switchPage(nextPageId);
                            }
                        }, 3000);
                    } else {
                        if (nextPageId) {
                            preloadNextImage(nextPageId);
                            switchPage(nextPageId);
                        }
                    }
                });
            });
            
            // 游戏结束按钮事件
            if (endGameBtn) {
                endGameBtn.addEventListener('click', function() {
                    endTime = Date.now();
                    updateFinalData();
                    switchPage('2501');
                });
            }
            
            // 预加载下一张图片
            preloadNextImage('2102');
        }

        // 页面加载完成后初始化游戏
        document.addEventListener('DOMContentLoaded', initGame);
    </script>
</body>
</html>
