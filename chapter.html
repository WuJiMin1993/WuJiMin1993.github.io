<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>English Tense Game - Chapters</title>
    <link rel="stylesheet" href="style.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div id="game-container">
        <!-- All chapter screens will be dynamically shown here -->
        <div id="current-screen" class="screen"></div>
        
        <!-- Hint box -->
        <div id="hint-box" class="hint-box">
            <p id="hint-text"></p>
        </div>
    </div>

    <!-- Ranking Screen (Page ID: 2501) -->
    <div id="ranking-screen" class="screen" data-page-id="2501" style="display: none;">
        <div class="room-info">
            <h2>Room: <span id="room-display"></span></h2>
            <p>Players: <span id="player-count"></span></p>
        </div>
        <div class="ranking-table-container">
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Name</th>
                        <th>Score</th>
                        <th>Accuracy</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="ranking-body">
                    <!-- Rankings will be populated here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHRYTBU74r31MPYVAAnRMwKM76c_-BduQ",
            authDomain: "tetrisonline-ca400.firebaseapp.com",
            projectId: "tetrisonline-ca400",
            storageBucket: "tetrisonline-ca400.firebasestorage.app",
            messagingSenderId: "58207939196",
            appId: "1:58207939196:web:b34f403204096084ee37f9",
            measurementId: "G-GG7GNEQ718"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state variables
        const urlParams = new URLSearchParams(window.location.search);
        const currentRoom = urlParams.get('room');
        const isTeacher = urlParams.get('teacher') === 'true';
        const playerId = urlParams.get('player');
        
        let currentPageId = '2101'; // Start with first chapter screen
        let score = 0;
        let correctAnswers = 0;
        let startTime = null;
        let timeInterval = null;
        let timeSpent = 0; // in seconds
        let hasClicked = false; // To prevent multiple clicks on same screen

        // DOM elements
        const gameContainer = document.getElementById('game-container');
        const currentScreen = document.getElementById('current-screen');
        const hintBox = document.getElementById('hint-box');
        const hintText = document.getElementById('hint-text');
        const rankingScreen = document.getElementById('ranking-screen');
        const roomDisplay = document.getElementById('room-display');
        const playerCount = document.getElementById('player-count');
        const rankingBody = document.getElementById('ranking-body');

        // Screens data - this would be all your chapter screens from 2101 to 2409
        const screens = {
            // Chapter 1
            '2101': {
                image: 'images/画面01.jpg',
                text: 'Tom lives in a magical world and ____ the school library every day.',
                buttons: [
                    { text: 'cleans', position: 'left', correct: true, next: '2102' },
                    { text: 'cleaning', position: 'right', correct: false, 
                      hint: 'Daily behavior is expressed in the present tense', next: '2102' }
                ]
            },
            '2102': {
                image: 'images/画面02.jpg',
                text: 'Tom found that a box he _____ yesterday has been opened today, and there is blue light coming from inside.',
                buttons: [
                    { text: 'locked', position: 'left', correct: true, next: '2103' },
                    { text: 'locks', position: 'right', correct: false, 
                      hint: 'Describe the simple behavior that occurred yesterday in the past simple tense', next: '2103' }
                ]
            },
            '2103': {
                image: 'images/画面03.jpg',
                text: 'Tom walked over curiously and saw a magic wand with a flashing blue light, with a label next to it that read: Tense Magic wand.',
                buttons: [
                    { text: 'continue', position: 'center', correct: null, next: '2104' }
                ]
            },
            '2104': {
                image: 'images/画面04.jpg',
                text: 'Tom became curious and hid his magic wand in his clothes before taking it away from the library He ____ outdoors tomorrow to test the power of the magic wand.',
                buttons: [
                    { text: 'will go', position: 'left', correct: true, next: '2201' },
                    { text: 'is going', position: 'right', correct: false, 
                      hint: 'Describe simple behaviors that will occur in the future using general future tense', next: '2201' }
                ]
            },
            // Chapter 2
            '2201': {
                image: 'images/画面05.jpg',
                text: 'The next morning, he ____ a magic broom towards a forest next to the school.',
                buttons: [
                    { text: 'is riding', position: 'left', correct: true, next: '2202' },
                    { text: 'has ridden', position: 'right', correct: false, 
                      hint: 'Describe the ongoing behavior in present continuous tense', next: '2202' }
                ]
            },
            '2202': {
                image: 'images/画面06.jpg',
                text: 'At this time yesterday, Tom was cleaning the library. He was supposed to be organizing books in the library today, but he thought this magic wand would be fun. So I decided to slack off and not go to the library anymore.',
                buttons: [
                    { text: 'was cleaning', position: 'left', correct: true, next: '2203' },
                    { text: 'is cleaning', position: 'right', correct: false, 
                      hint: '描述过去正在进行的行为用过去进行时', next: '2203' }
                ]
            },
            '2203': {
                image: 'images/画面07.jpg',
                text: 'Tom will be tidying up the library early tomorrow to prevent library director Jimmy from discovering his laziness.',
                buttons: [
                    { text: 'will be tidying up', position: 'left', correct: true, next: '2301' },
                    { text: 'is tidying up', position: 'right', correct: false, 
                      hint: 'Describe the ongoing behavior in the future using future continuous tense', next: '2301' }
                ]
            },
            // Chapter 3
            '2301': {
                image: 'images/画面08.jpg',
                text: 'Tom stops by the stream in the forest and ____ the magic wand from his clothes. He thought that the magic wand is called a tense magic wand. Is the spell that activates it related to tense?',
                buttons: [
                    { text: 'takes out', position: 'left', correct: true, next: '2302' },
                    { text: 'will take out', position: 'right', correct: false, 
                      hint: 'Describe daily behavior in the present tense', next: '2302' }
                ]
            },
            '2302': {
                image: 'images/画面09.jpg',
                text: 'So he decided to try combining the spells he learned at the magic school. Tom pointed his magic wand at the stream and said, \'A delicious fish ____.\'',
                buttons: [
                    { text: 'has been grilled', position: 'left', correct: true, next: '2304' },
                    { text: 'will be grilled', position: 'right', correct: false, 
                      hint: 'The spell didn\'t take effect, Tom recited a delicious fish that had already been grilled', next: '2304' }
                ]
            },
            '2303': {
                image: 'images/画面10.jpg',
                text: 'After reciting the spell, a sudden blue flash appeared. Then a grill made of tree branches appeared in front of Tom, with a fragrant grilled fish on top.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, next: '2304' }
                ]
            },
            '2304': {
                image: 'images/画面11.jpg',
                text: 'Tom hadn\'t had breakfast before coming here, and his stomach was growling. Tom ____ the grilled fish and begins eating.',
                buttons: [
                    { text: 'has taken', position: 'left', correct: true, next: '2305' },
                    { text: 'will take', position: 'right', correct: false, 
                      hint: 'Describe completed actions in present perfect tense', next: '2305' }
                ]
            },
            '2305': {
                image: 'images/画面12.jpg',
                text: 'Tom thinks that now he has the powerful wand.And the wizard who always bullies me ____ by him.',
                buttons: [
                    { text: 'will have been defeated', position: 'left', correct: true, next: '2401' },
                    { text: 'has been defeated', position: 'right', correct: false, 
                      hint: 'Describe the behavior to be completed in the future using the future perfect tense', next: '2401' }
                ]
            },
            // Chapter 4
            '2401': {
                image: 'images/画面13.jpg',
                text: 'Although Tom ____ magic at the school for a year, his knowledge of magic is still inferior to that of wizard Mike.',
                buttons: [
                    { text: 'has been studying', position: 'left', correct: true, next: '2402' },
                    { text: 'will studying', position: 'right', correct: false, 
                      hint: 'The action has been ongoing from the past to the present, and may have just ended or is still ongoing, using the present to complete the ongoing tense', next: '2402' }
                ]
            },
            '2402': {
                image: 'images/画面14.jpg',
                text: 'So Tom came to the house of the wizard Mike who used to tease him. Tom shouted at Mike, \'I ____ magic to defeat you. Come out and accept my challenge.\'',
                buttons: [
                    { text: 'will use', position: 'left', correct: true, next: '2403' },
                    { text: 'am using', position: 'right', correct: false, 
                      hint: 'Describe future actions using future continuous tense', next: '2403' }
                ]
            },
            '2403': {
                image: 'images/画面15.jpg',
                text: 'Mike walked out of the room and said, \'Tom, you ____ to me over the past year. Are you still not willing to give up?\'',
                buttons: [
                    { text: 'had been repeatedly losing', position: 'left', correct: true, next: '2404' },
                    { text: 'was losing', position: 'right', correct: false, 
                      hint: 'A certain past action started earlier in the past and continued until a certain point in time, possibly still continuing or just stopped', next: '2404' }
                ]
            },
            '2404': {
                image: 'images/画面16.jpg',
                text: 'Tom pointed his magic wand at the sky and cursed \'It\'s going to rain soon,\' and the wand emitted blue light.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, next: '2405' }
                ]
            },
            '2405': {
                image: 'images/画面17.jpg',
                text: 'Before long, dark clouds appeared in the sky, thunder started to strike, and raindrops began to fall.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, next: '2406' }
                ]
            },
            '2406': {
                image: 'images/画面18.jpg',
                text: 'By tomorrow, Mike ____ magic for 2 years now. But Mike was still stunned when he saw Tom\'s magic. Mike had never seen such a powerful magic before and said to Tom, \'I admit you\'re already better than me.\'',
                buttons: [
                    { text: 'will have been studying', position: 'left', correct: true, next: '2407' },
                    { text: 'will be studying', position: 'right', correct: false, 
                      hint: 'Emphasize how long a certain action has been ongoing until a certain point in the future, using the future completion continuous time', next: '2407' }
                ]
            },
            '2407': {
                image: 'images/画面19.jpg',
                text: 'Tom wants to show off the power of his magic wand again and is ready to recite the next spell. But suddenly a beam of light flashed and the library director Jimmy appeared in front of him.',
                buttons: [
                    { text: 'Continue', position: 'center', correct: null, next: '2408' }
                ]
            },
            '2408': {
                image: 'images/画面20.jpg',
                text: 'Library director Jimmy said to Tom, \'I ____ for it all day, but you took it away.\'.',
                buttons: [
                    { text: 'have been looking', position: 'left', correct: true, next: '2409' },
                    { text: 'am looking', position: 'right', correct: false, 
                      hint: 'Describe actions that have been completed in the past and use them to complete them', next: '2409' }
                ]
            },
            '2409': {
                image: 'images/画面21.jpg',
                text: 'Jimmy raised his hand, and the magic wand automatically flew into Jimmy\'s hand. Then Jimmy shouted at Tom, \'Hurry back and clean the library for me.\'',
                buttons: [
                    { text: 'Game over', position: 'center', correct: null, next: '2501' }
                ]
            }
        };

        // Initialize game
        function initGame() {
            if (isTeacher) {
                // Teacher only sees ranking screen
                showRankingScreen();
                startRankingUpdates();
            } else {
                // Player starts the game
                startTime = Date.now();
                startTimer();
                showScreen(currentPageId);
            }
        }

        // Show a specific screen
        function showScreen(screenId) {
            hasClicked = false; // Reset click flag for new screen
            
            const screen = screens[screenId];
            if (!screen) {
                console.error('Screen not found:', screenId);
                return;
            }
            
            currentPageId = screenId;
            
            // Update progress in database
            updateProgress();
            
            // Create screen HTML
            let html = `
                <img src="${screen.image}" alt="Game Screen" class="full-width-image">
                <div class="text-box">${screen.text}</div>
                <div class="button-container">
            `;
            
            // Add buttons
            screen.buttons.forEach(button => {
                const positionClass = button.position === 'center' ? 'center-btn' : 
                                      button.position === 'left' ? 'left-btn' : 'right-btn';
                
                html += `
                    <button class="blue-btn ${positionClass}" 
                            data-correct="${button.correct}" 
                            data-next="${button.next}"
                            ${button.hint ? `data-hint="${button.hint}"` : ''}>
                        ${button.text}
                    </button>
                `;
            });
            
            html += `</div>`;
            
            currentScreen.innerHTML = html;
            currentScreen.style.display = 'block';
            
            // Add event listeners to buttons
            document.querySelectorAll('.blue-btn').forEach(btn => {
                btn.addEventListener('click', handleButtonClick);
            });
            
            // Preload next possible images
            preloadNextImages(screenId);
        }

        // Handle button clicks
        function handleButtonClick(e) {
            if (hasClicked) return; // Prevent multiple clicks on same screen
            hasClicked = true;
            
            const button = e.target;
            const isCorrect = button.getAttribute('data-correct') === 'true';
            const nextScreen = button.getAttribute('data-next');
            const hint = button.getAttribute('data-hint');
            
            // Update score if answer is correct
            if (isCorrect) {
                score += 6.7;
                correctAnswers++;
                updateScore();
            }
            
            // Show hint if answer is wrong and hint exists
            if (!isCorrect && hint) {
                showHint(hint);
                
                // Wait 3 seconds before proceeding
                setTimeout(() => {
                    hideHint();
                    proceedToNextScreen(nextScreen);
                }, 3000);
            } else {
                proceedToNextScreen(nextScreen);
            }
        }

        // Show hint message
        function showHint(message) {
            hintText.textContent = message;
            hintBox.style.display = 'block';
        }

        // Hide hint message
        function hideHint() {
            hintBox.style.display = 'none';
        }

        // Proceed to next screen
        function proceedToNextScreen(nextScreen) {
            if (nextScreen === '2501') {
                // Game over, show ranking
                endGame();
                showRankingScreen();
                startRankingUpdates();
            } else {
                showScreen(nextScreen);
            }
        }

        // Show ranking screen
        function showRankingScreen() {
            currentScreen.style.display = 'none';
            rankingScreen.style.display = 'block';
            
            roomDisplay.textContent = currentRoom;
            
            // Get player count (excluding teacher)
            database.ref('rooms/' + currentRoom + '/players').once('value').then(snapshot => {
                const players = snapshot.val() || {};
                playerCount.textContent = Object.keys(players).length;
            });
        }

        // Start real-time ranking updates
        function startRankingUpdates() {
            // Update rankings every 3 seconds
            setInterval(updateRankings, 3000);
            updateRankings(); // Initial update
        }

        // Update rankings from Firebase
        function updateRankings() {
            database.ref('rooms/' + currentRoom + '/players').once('value').then(snapshot => {
                const players = snapshot.val() || {};
                const playersArray = [];
                
                // Convert to array and calculate accuracy
                for (const [id, player] of Object.entries(players)) {
                    const accuracy = player.correctAnswers ? 
                        Math.round((player.correctAnswers / 15) * 100 * 10) / 10 : 0;
                    
                    playersArray.push({
                        id,
                        nickname: player.nickname,
                        score: Math.min(Math.round(player.score), 100), // Cap at 100
                        accuracy: accuracy + '%',
                        time: formatTime(player.timeSpent),
                        isCurrentPlayer: id === playerId
                    });
                }
                
                // Sort by score (descending)
                playersArray.sort((a, b) => b.score - a.score);
                
                // Update ranking table (top 10)
                rankingBody.innerHTML = '';
                playersArray.slice(0, 10).forEach((player, index) => {
                    const row = document.createElement('tr');
                    if (player.isCurrentPlayer) {
                        row.classList.add('highlight-player');
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${player.nickname}</td>
                        <td>${player.score}</td>
                        <td>${player.accuracy}</td>
                        <td>${player.time}</td>
                    `;
                    
                    rankingBody.appendChild(row);
                });
            });
        }

        // Format time (seconds) to MM:SS
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Start timer
        function startTimer() {
            timeInterval = setInterval(() => {
                timeSpent = Math.floor((Date.now() - startTime) / 1000);
                
                // Cap at 60 minutes (3600 seconds)
                if (timeSpent >= 3600) {
                    timeSpent = 3600;
                    clearInterval(timeInterval);
                }
                
                // Update time in database
                updateTime();
            }, 1000);
        }

        // End game (stop timer, calculate final score)
        function endGame() {
            clearInterval(timeInterval);
            
            // Calculate time score (2 points per full minute, 1 point otherwise)
            const timeScore = Math.floor(timeSpent / 60) * 2 + (timeSpent % 60 > 0 ? 1 : 0);
            
            // Final score is (correct answers * 6.7) - time score
            score = Math.max(0, Math.min(score - timeScore, 100));
            
            // Update final score
            updateScore();
        }

        // Update score in database
        function updateScore() {
            if (!playerId) return;
            
            database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                score: score,
                correctAnswers: correctAnswers
            }).catch(error => {
                console.error('Error updating score:', error);
            });
        }

        // Update time in database
        function updateTime() {
            if (!playerId) return;
            
            database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                timeSpent: timeSpent
            }).catch(error => {
                console.error('Error updating time:', error);
            });
        }

        // Update progress in database
        function updateProgress() {
            if (!playerId) return;
            
            // Calculate progress (current page number / 21)
            const pageNum = parseInt(currentPageId.substring(1));
            const progress = Math.round((pageNum / 21) * 100);
            
            database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                progress: progress
            }).catch(error => {
                console.error('Error updating progress:', error);
            });
        }

        // Preload next possible images to improve performance
        function preloadNextImages(currentScreenId) {
            const screen = screens[currentScreenId];
            if (!screen) return;
            
            // Preload images for next possible screens
            screen.buttons.forEach(button => {
                const nextScreen = screens[button.next];
                if (nextScreen) {
                    const img = new Image();
                    img.src = nextScreen.image;
                }
            });
        }

        // Initialize game when page loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>
