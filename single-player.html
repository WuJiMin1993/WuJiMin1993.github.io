<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单人俄罗斯方块</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            color: #333;
        }
        
        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 20px;
            width: 800px;
        }
        
        #header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-bottom: 20px;
        }
        
        #score-display {
            font-size: 24px;
            font-weight: bold;
        }
        
        #main-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        #game-board {
            border: 2px solid #333;
            background-color: #111;
            position: relative;
        }
        
        #side-panel {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            width: 200px;
        }
        
        #next-piece {
            border: 2px solid #333;
            background-color: #111;
            margin-bottom: 20px;
            position: relative;
        }
        
        #instructions {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            margin-bottom: 20px;
        }
        
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .button:hover {
            background-color: #45a049;
        }
        
        #back-button {
            background-color: #f44336;
        }
        
        #back-button:hover {
            background-color: #d32f2f;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 10;
            border-radius: 8px;
        }
        
        #final-score {
            font-size: 28px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .block {
            position: absolute;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .preview-block {
            position: absolute;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <div id="score-display">得分: 0</div>
            <button id="back-button" class="button">返回主界面</button>
        </div>
        
        <div id="main-content">
            <div id="game-board" style="width: 300px; height: 600px;">
                <div id="game-over">
                    <div id="final-score">最终得分: 0</div>
                    <button id="restart-button" class="button">重新开始</button>
                </div>
            </div>
            
            <div id="side-panel">
                <div id="next-piece" style="width: 120px; height: 120px;"></div>
                
                <div id="instructions">
                    <h3>游戏说明:</h3>
                    <p>← → : 左右移动</p>
                    <p>↑ : 旋转方块</p>
                    <p>↓ : 加速下落</p>
                    <p>空格 : 直接落到底部</p>
                </div>
                
                <button id="start-button" class="button">游戏开始</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 游戏常量
            const COLS = 10;
            const ROWS = 20;
            const BLOCK_SIZE = 30;
            const NEXT_BLOCK_SIZE = 20;
            
            // 游戏变量
            let score = 0;
            let gameInterval;
            let dropSpeed = 1000; // 初始下落速度(毫秒)
            let isGameRunning = false;
            let isGameOver = false;
            
            // 方块形状定义
            const SHAPES = [
                [[1, 1, 1, 1]], // I
                [[1, 1], [1, 1]], // O
                [[1, 1, 1], [0, 1, 0]], // T
                [[1, 1, 1], [1, 0, 0]], // L
                [[1, 1, 1], [0, 0, 1]], // J
                [[0, 1, 1], [1, 1, 0]], // S
                [[1, 1, 0], [0, 1, 1]]  // Z
            ];
            
            // 方块颜色
            const COLORS = [
                '#00FFFF', // I - 青色
                '#FFFF00', // O - 黄色
                '#AA00FF', // T - 紫色
                '#FF7F00', // L - 橙色
                '#0000FF', // J - 蓝色
                '#00FF00', // S - 绿色
                '#FF0000'  // Z - 红色
            ];
            
            // 游戏状态
            let board = createBoard();
            let currentPiece = null;
            let nextPiece = null;
            let currentPosition = { x: 0, y: 0 };
            
            // DOM元素
            const gameBoard = document.getElementById('game-board');
            const nextPieceDisplay = document.getElementById('next-piece');
            const scoreDisplay = document.getElementById('score-display');
            const startButton = document.getElementById('start-button');
            const restartButton = document.getElementById('restart-button');
            const backButton = document.getElementById('back-button');
            const gameOverDisplay = document.getElementById('game-over');
            const finalScoreDisplay = document.getElementById('final-score');
            
            // 初始化游戏
            function initGame() {
                board = createBoard();
                score = 0;
                dropSpeed = 1000;
                isGameOver = false;
                scoreDisplay.textContent = `得分: ${score}`;
                gameOverDisplay.style.display = 'none';
                
                // 清除游戏板上的所有方块
                const blocks = document.querySelectorAll('.block');
                blocks.forEach(block => block.remove());
                
                // 清除下一个方块预览
                const previewBlocks = document.querySelectorAll('.preview-block');
                previewBlocks.forEach(block => block.remove());
                
                // 生成下一个方块
                generateNextPiece();
            }
            
            // 创建游戏板
            function createBoard() {
                return Array(ROWS).fill().map(() => Array(COLS).fill(0));
            }
            
            // 生成下一个方块
            function generateNextPiece() {
                if (!nextPiece) {
                    const randomIndex = Math.floor(Math.random() * SHAPES.length);
                    nextPiece = {
                        shape: SHAPES[randomIndex],
                        color: COLORS[randomIndex]
                    };
                }
                
                displayNextPiece();
                
                // 设置当前方块为下一个方块
                currentPiece = nextPiece;
                
                // 生成新的下一个方块
                const randomIndex = Math.floor(Math.random() * SHAPES.length);
                nextPiece = {
                    shape: SHAPES[randomIndex],
                    color: COLORS[randomIndex]
                };
                
                // 设置初始位置 (居中顶部)
                currentPosition = {
                    x: Math.floor((COLS - currentPiece.shape[0].length) / 2),
                    y: 0
                };
                
                // 检查游戏是否结束
                if (checkCollision()) {
                    gameOver();
                    return false;
                }
                
                return true;
            }
            
            // 显示下一个方块预览
            function displayNextPiece() {
                // 清除之前的预览
                const previewBlocks = document.querySelectorAll('.preview-block');
                previewBlocks.forEach(block => block.remove());
                
                if (!nextPiece) return;
                
                const shape = nextPiece.shape;
                const color = nextPiece.color;
                
                // 计算居中位置
                const centerX = (120 - shape[0].length * NEXT_BLOCK_SIZE) / 2;
                const centerY = (120 - shape.length * NEXT_BLOCK_SIZE) / 2;
                
                // 绘制预览方块
                for (let y = 0; y < shape.length; y++) {
                    for (let x = 0; x < shape[y].length; x++) {
                        if (shape[y][x]) {
                            const block = document.createElement('div');
                            block.className = 'preview-block';
                            block.style.backgroundColor = color;
                            block.style.width = `${NEXT_BLOCK_SIZE}px`;
                            block.style.height = `${NEXT_BLOCK_SIZE}px`;
                            block.style.left = `${centerX + x * NEXT_BLOCK_SIZE}px`;
                            block.style.top = `${centerY + y * NEXT_BLOCK_SIZE}px`;
                            nextPieceDisplay.appendChild(block);
                        }
                    }
                }
            }
            
            // 绘制当前方块
            function drawPiece() {
                // 清除之前的方块
                const blocks = document.querySelectorAll('.block');
                blocks.forEach(block => {
                    if (!block.classList.contains('fixed')) {
                        block.remove();
                    }
                });
                
                if (!currentPiece) return;
                
                const shape = currentPiece.shape;
                const color = currentPiece.color;
                
                for (let y = 0; y < shape.length; y++) {
                    for (let x = 0; x < shape[y].length; x++) {
                        if (shape[y][x]) {
                            const block = document.createElement('div');
                            block.className = 'block';
                            block.style.backgroundColor = color;
                            block.style.width = `${BLOCK_SIZE}px`;
                            block.style.height = `${BLOCK_SIZE}px`;
                            block.style.left = `${currentPosition.x * BLOCK_SIZE + x * BLOCK_SIZE}px`;
                            block.style.top = `${currentPosition.y * BLOCK_SIZE + y * BLOCK_SIZE}px`;
                            gameBoard.appendChild(block);
                        }
                    }
                }
            }
            
            // 检查碰撞
            function checkCollision(offsetX = 0, offsetY = 0) {
                const shape = currentPiece.shape;
                
                for (let y = 0; y < shape.length; y++) {
                    for (let x = 0; x < shape[y].length; x++) {
                        if (shape[y][x]) {
                            const newX = currentPosition.x + x + offsetX;
                            const newY = currentPosition.y + y + offsetY;
                            
                            // 检查边界
                            if (newX < 0 || newX >= COLS || newY >= ROWS) {
                                return true;
                            }
                            
                            // 检查是否与固定方块碰撞
                            if (newY >= 0 && board[newY] && board[newY][newX]) {
                                return true;
                            }
                        }
                    }
                }
                
                return false;
            }
            
            // 旋转方块
            function rotatePiece() {
                if (!currentPiece) return;
                
                // 创建旋转后的形状
                const shape = currentPiece.shape;
                const rows = shape.length;
                const cols = shape[0].length;
                const rotated = Array(cols).fill().map(() => Array(rows).fill(0));
                
                for (let y = 0; y < rows; y++) {
                    for (let x = 0; x < cols; x++) {
                        rotated[x][rows - 1 - y] = shape[y][x];
                    }
                }
                
                // 保存当前形状和位置
                const originalShape = currentPiece.shape;
                const originalPosition = { ...currentPosition };
                
                // 尝试旋转
                currentPiece.shape = rotated;
                
                // 调整位置防止旋转后超出边界
                if (currentPosition.x + rotated[0].length > COLS) {
                    currentPosition.x = COLS - rotated[0].length;
                }
                
                if (currentPosition.x < 0) {
                    currentPosition.x = 0;
                }
                
                // 检查碰撞
                if (checkCollision()) {
                    // 如果旋转后发生碰撞，恢复原状
                    currentPiece.shape = originalShape;
                    currentPosition = originalPosition;
                    return false;
                }
                
                drawPiece();
                return true;
            }
            
            // 移动方块
            function movePiece(offsetX, offsetY) {
                if (!currentPiece || isGameOver) return false;
                
                // 检查是否可以移动
                if (!checkCollision(offsetX, offsetY)) {
                    currentPosition.x += offsetX;
                    currentPosition.y += offsetY;
                    drawPiece();
                    return true;
                }
                
                // 如果是向下移动且发生碰撞，则固定方块
                if (offsetY === 1) {
                    lockPiece();
                    return false;
                }
                
                return false;
            }
            
            // 固定方块到游戏板
            function lockPiece() {
                const shape = currentPiece.shape;
                
                for (let y = 0; y < shape.length; y++) {
                    for (let x = 0; x < shape[y].length; x++) {
                        if (shape[y][x]) {
                            const boardY = currentPosition.y + y;
                            const boardX = currentPosition.x + x;
                            
                            if (boardY >= 0) {
                                board[boardY][boardX] = 1;
                                
                                // 标记方块为固定
                                const blocks = document.querySelectorAll('.block');
                                blocks.forEach(block => {
                                    const blockX = parseInt(block.style.left) / BLOCK_SIZE;
                                    const blockY = parseInt(block.style.top) / BLOCK_SIZE;
                                    
                                    if (blockX === boardX && blockY === boardY) {
                                        block.classList.add('fixed');
                                    }
                                });
                            }
                        }
                    }
                }
                
                // 检查是否有完整的行
                checkLines();
                
                // 生成下一个方块
                if (!generateNextPiece()) {
                    return;
                }
                
                drawPiece();
            }
            
            // 检查并清除完整的行
            function checkLines() {
                let linesCleared = 0;
                
                for (let y = ROWS - 1; y >= 0; y--) {
                    if (board[y].every(cell => cell === 1)) {
                        // 清除行
                        board.splice(y, 1);
                        board.unshift(Array(COLS).fill(0));
                        linesCleared++;
                        y++; // 重新检查当前行，因为上面的行下移了
                    }
                }
                
                if (linesCleared > 0) {
                    // 更新分数
                    updateScore(linesCleared);
                    
                    // 清除游戏板上的所有固定方块并重新绘制
                    const fixedBlocks = document.querySelectorAll('.fixed');
                    fixedBlocks.forEach(block => block.remove());
                    
                    // 重新绘制所有固定方块
                    for (let y = 0; y < ROWS; y++) {
                        for (let x = 0; x < COLS; x++) {
                            if (board[y][x]) {
                                const block = document.createElement('div');
                                block.className = 'block fixed';
                                block.style.backgroundColor = getColorAtPosition(x, y);
                                block.style.width = `${BLOCK_SIZE}px`;
                                block.style.height = `${BLOCK_SIZE}px`;
                                block.style.left = `${x * BLOCK_SIZE}px`;
                                block.style.top = `${y * BLOCK_SIZE}px`;
                                gameBoard.appendChild(block);
                            }
                        }
                    }
                }
            }
            
            // 获取指定位置的方块颜色
            function getColorAtPosition(x, y) {
                const blocks = document.querySelectorAll('.fixed');
                for (const block of blocks) {
                    const blockX = parseInt(block.style.left) / BLOCK_SIZE;
                    const blockY = parseInt(block.style.top) / BLOCK_SIZE;
                    
                    if (blockX === x && blockY === y) {
                        return block.style.backgroundColor;
                    }
                }
                return '#FFFFFF'; // 默认颜色
            }
            
            // 更新分数
            function updateScore(linesCleared) {
                // 根据消除的行数计算得分
                const points = [0, 100, 300, 500, 800][linesCleared] || 0;
                score += points;
                scoreDisplay.textContent = `得分: ${score}`;
                
                // 根据分数调整下落速度
                if (score >= 5000) {
                    dropSpeed = 100;
                } else if (score >= 3000) {
                    dropSpeed = 200;
                } else if (score >= 2000) {
                    dropSpeed = 300;
                } else if (score >= 1000) {
                    dropSpeed = 500;
                } else if (score >= 500) {
                    dropSpeed = 700;
                }
                
                // 更新游戏间隔
                if (isGameRunning) {
                    clearInterval(gameInterval);
                    gameInterval = setInterval(() => {
                        movePiece(0, 1);
                    }, dropSpeed);
                }
            }
            
            // 游戏结束
            function gameOver() {
                isGameOver = true;
                isGameRunning = false;
                clearInterval(gameInterval);
                
                // 显示游戏结束界面
                finalScoreDisplay.textContent = `最终得分: ${score}`;
                gameOverDisplay.style.display = 'flex';
            }
            
            // 开始游戏
            function startGame() {
                if (isGameRunning) return;
                
                initGame();
                isGameRunning = true;
                isGameOver = false;
                
                // 生成第一个方块
                generateNextPiece();
                drawPiece();
                displayNextPiece();
                
                // 设置游戏循环
                gameInterval = setInterval(() => {
                    movePiece(0, 1);
                }, dropSpeed);
            }
            
            // 键盘控制
            document.addEventListener('keydown', function(e) {
                if (!isGameRunning || isGameOver) return;
                
                switch (e.key) {
                    case 'ArrowLeft':
                        movePiece(-1, 0);
                        break;
                    case 'ArrowRight':
                        movePiece(1, 0);
                        break;
                    case 'ArrowDown':
                        movePiece(0, 1);
                        break;
                    case 'ArrowUp':
                        rotatePiece();
                        break;
                    case ' ':
                        // 空格键 - 硬降落
                        e.preventDefault(); // 防止空格键的默认行为
                        while (movePiece(0, 1)) {
                            // 持续下落直到不能移动
                        }
                        break;
                }
            });
            
            // 按钮事件
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', startGame);
            backButton.addEventListener('click', function() {
                // 停止游戏
                clearInterval(gameInterval);
                isGameRunning = false;
                
                // 这里应该有一个返回主界面的逻辑
                alert('返回主界面功能需要与主页面集成');
            });
            
            // 初始化显示
            displayNextPiece();
        });
    </script>
</body>
</html>
