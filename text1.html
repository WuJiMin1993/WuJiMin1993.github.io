<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>经典俄罗斯方块</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        
        #main-menu, #single-player-game {
            text-align: center;
            display: none;
        }
        
        .active {
            display: block !important;
        }
        
        .menu-btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            width: 200px;
        }
        
        .menu-btn:hover {
            background-color: #45a049;
        }
        
        #single-player-game {
            position: relative;
        }
        
        #game-board {
            border: 2px solid #333;
            background-color: #111;
        }
        
        #score-display {
            position: absolute;
            top: 10px;
            right: 10px;
            color: white;
            font-size: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
        }
        
        #instructions {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            max-width: 200px;
        }
        
        #back-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: #f44336;
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }
        
        #back-btn:hover {
            background-color: #d32f2f;
        }
        
        #start-game-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2196F3;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            z-index: 10;
        }
        
        #start-game-btn:hover {
            background-color: #0b7dda;
        }
        
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 5;
        }
        
        .game-over h2 {
            font-size: 30px;
            margin-bottom: 20px;
        }
        
        .game-over p {
            font-size: 20px;
            margin-bottom: 20px;
        }
        
        .restart-btn {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        
        .restart-btn:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <!-- 主菜单 -->
    <div id="main-menu" class="active">
        <h1>经典俄罗斯方块</h1>
        <button id="single-player-btn" class="menu-btn">单人游戏</button>
        <button id="two-player-btn" class="menu-btn">双人游戏</button>
    </div>
    
    <!-- 单人游戏界面 -->
    <div id="single-player-game">
        <canvas id="game-board" width="300" height="600"></canvas>
        <div id="score-display">得分: 0</div>
        <button id="back-btn">←</button>
        <div id="instructions">
            <h3>操作说明:</h3>
            <p>↑: 旋转方块</p>
            <p>↓: 加速下落</p>
            <p>←: 左移</p>
            <p>→: 右移</p>
            <p>空格: 直接下落</p>
        </div>
        <button id="start-game-btn">开始游戏</button>
    </div>

    <script>
        // 游戏常量
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 30;
        const COLORS = [
            'cyan', 'blue', 'orange', 'yellow', 'green', 'purple', 'red'
        ];
        
        // 方块形状定义
        const SHAPES = [
            [[0, 0, 0, 0], [1, 1, 1, 1], [0, 0, 0, 0], [0, 0, 0, 0]], // I
            [[1, 0, 0], [1, 1, 1], [0, 0, 0]],                        // J
            [[0, 0, 1], [1, 1, 1], [0, 0, 0]],                        // L
            [[1, 1], [1, 1]],                                         // O
            [[0, 1, 1], [1, 1, 0], [0, 0, 0]],                        // S
            [[0, 1, 0], [1, 1, 1], [0, 0, 0]],                        // T
            [[1, 1, 0], [0, 1, 1], [0, 0, 0]]                         // Z
        ];
        
        // 游戏状态
        let canvas, ctx;
        let board = [];
        let currentPiece, nextPiece;
        let score = 0;
        let gameOver = false;
        let gameStarted = false;
        let dropStart;
        let lastTime = 0;
        let gameSpeed = 1000; // 初始下落速度(毫秒)
        
        // 初始化游戏
        function init() {
            // 设置按钮事件
            document.getElementById('single-player-btn').addEventListener('click', startSinglePlayer);
            document.getElementById('two-player-btn').addEventListener('click', showTwoPlayer);
            document.getElementById('back-btn').addEventListener('click', backToMenu);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            
            // 初始化游戏画布
            canvas = document.getElementById('game-board');
            ctx = canvas.getContext('2d');
            canvas.style.width = canvas.width + 'px';
            canvas.style.height = canvas.height + 'px';
            
            // 设置键盘控制
            document.addEventListener('keydown', control);
            
            // 初始化游戏板
            createBoard();
            
            // 生成第一个方块
            currentPiece = generatePiece();
            nextPiece = generatePiece();
            
            // 开始游戏循环
            requestAnimationFrame(gameLoop);
        }
        
        // 创建游戏板
        function createBoard() {
            board = [];
            for (let r = 0; r < ROWS; r++) {
                board[r] = [];
                for (let c = 0; c < COLS; c++) {
                    board[r][c] = 0;
                }
            }
        }
        
        // 生成随机方块
        function generatePiece() {
            const randomIndex = Math.floor(Math.random() * SHAPES.length);
            const shape = SHAPES[randomIndex];
            const color = COLORS[randomIndex];
            
            // 计算初始位置(居中)
            const startCol = Math.floor((COLS - shape[0].length) / 2);
            
            return {
                shape: shape,
                color: color,
                x: startCol,
                y: -1 // 从顶部开始
            };
        }
        
        // 绘制游戏板
        function drawBoard() {
            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    if (board[r][c]) {
                        drawBlock(c, r, board[r][c]);
                    }
                }
            }
        }
        
        // 绘制方块
        function drawPiece(piece) {
            for (let r = 0; r < piece.shape.length; r++) {
                for (let c = 0; c < piece.shape[r].length; c++) {
                    if (piece.shape[r][c]) {
                        drawBlock(piece.x + c, piece.y + r, piece.color);
                    }
                }
            }
        }
        
        // 绘制单个方块
        function drawBlock(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
            
            ctx.strokeStyle = 'black';
            ctx.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
        }
        
        // 游戏主循环
        function gameLoop(time = 0) {
            const deltaTime = time - lastTime;
            lastTime = time;
            
            // 清除画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制游戏板
            drawBoard();
            
            // 绘制当前方块
            drawPiece(currentPiece);
            
            // 检查是否需要下落
            if (gameStarted && !gameOver && time - dropStart > gameSpeed) {
                drop();
                dropStart = time;
            }
            
            // 更新分数显示
            document.getElementById('score-display').textContent = `得分: ${score}`;
            
            // 显示/隐藏开始按钮
            document.getElementById('start-game-btn').style.display = gameStarted ? 'none' : 'block';
            
            // 如果游戏未结束，继续循环
            if (!gameOver) {
                requestAnimationFrame(gameLoop);
            } else {
                // 游戏结束处理
                showGameOver();
            }
        }
        
        // 显示游戏结束界面
        function showGameOver() {
            const gameOverDiv = document.createElement('div');
            gameOverDiv.className = 'game-over';
            gameOverDiv.innerHTML = `
                <h2>游戏结束!</h2>
                <p>最终得分: ${score}</p>
                <button class="restart-btn">重新开始</button>
            `;
            
            gameOverDiv.querySelector('.restart-btn').addEventListener('click', restartGame);
            
            document.getElementById('single-player-game').appendChild(gameOverDiv);
        }
        
        // 重新开始游戏
        function restartGame() {
            const gameOverDiv = document.querySelector('.game-over');
            if (gameOverDiv) {
                gameOverDiv.remove();
            }
            
            resetGame();
            startGame();
        }
        
        // 方块下落
        function drop() {
            if (!collision(0, 1, currentPiece.shape)) {
                currentPiece.y++;
            } else {
                // 固定方块到游戏板
                lockPiece();
                
                // 检查是否有完整的行
                checkRows();
                
                // 生成新方块
                currentPiece = nextPiece;
                nextPiece = generatePiece();
                
                // 检查游戏是否结束
                if (collision(0, 0, currentPiece.shape)) {
                    gameOver = true;
                }
                
                // 随着分数增加加快下落速度
                gameSpeed = Math.max(100, 1000 - Math.floor(score / 10) * 50);
            }
        }
        
        // 固定方块到游戏板
        function lockPiece() {
            for (let r = 0; r < currentPiece.shape.length; r++) {
                for (let c = 0; c < currentPiece.shape[r].length; c++) {
                    if (currentPiece.shape[r][c]) {
                        board[currentPiece.y + r][currentPiece.x + c] = currentPiece.color;
                    }
                }
            }
        }
        
        // 检查是否有完整的行
        function checkRows() {
            let rowsCleared = 0;
            
            for (let r = ROWS - 1; r >= 0; r--) {
                let isRowFull = true;
                
                for (let c = 0; c < COLS; c++) {
                    if (board[r][c] === 0) {
                        isRowFull = false;
                        break;
                    }
                }
                
                if (isRowFull) {
                    // 移除该行
                    for (let y = r; y > 0; y--) {
                        for (let c = 0; c < COLS; c++) {
                            board[y][c] = board[y - 1][c];
                        }
                    }
                    
                    // 清空第一行
                    for (let c = 0; c < COLS; c++) {
                        board[0][c] = 0;
                    }
                    
                    rowsCleared++;
                    r++; // 重新检查当前行
                }
            }
            
            // 更新分数
            if (rowsCleared > 0) {
                score += [40, 100, 300, 1200][rowsCleared - 1];
            }
        }
        
        // 碰撞检测
        function collision(offsetX, offsetY, piece) {
            for (let r = 0; r < piece.length; r++) {
                for (let c = 0; c < piece[r].length; c++) {
                    if (!piece[r][c]) continue;
                    
                    const newX = currentPiece.x + c + offsetX;
                    const newY = currentPiece.y + r + offsetY;
                    
                    if (newX < 0 || newX >= COLS || newY >= ROWS) {
                        return true;
                    }
                    
                    if (newY < 0) {
                        continue;
                    }
                    
                    if (board[newY][newX] !== 0) {
                        return true;
                    }
                }
            }
            return false;
        }
        
        // 旋转方块
        function rotate() {
            if (!gameStarted || gameOver) return;
            
            const originalShape = currentPiece.shape;
            const rows = currentPiece.shape.length;
            const cols = currentPiece.shape[0].length;
            
            // 创建新的旋转后的形状
            const rotated = [];
            for (let c = 0; c < cols; c++) {
                rotated[c] = [];
                for (let r = rows - 1; r >= 0; r--) {
                    rotated[c][rows - 1 - r] = currentPiece.shape[r][c];
                }
            }
            
            // 检查旋转后是否会碰撞
            if (!collision(0, 0, rotated)) {
                currentPiece.shape = rotated;
            }
        }
        
        // 键盘控制
        function control(e) {
            if (!gameStarted || gameOver) return;
            
            switch (e.keyCode) {
                case 37: // 左箭头
                    if (!collision(-1, 0, currentPiece.shape)) {
                        currentPiece.x--;
                    }
                    break;
                case 39: // 右箭头
                    if (!collision(1, 0, currentPiece.shape)) {
                        currentPiece.x++;
                    }
                    break;
                case 40: // 下箭头
                    drop();
                    dropStart = performance.now(); // 重置下落计时器
                    break;
                case 38: // 上箭头
                    rotate();
                    break;
                case 32: // 空格键
                    hardDrop();
                    break;
            }
        }
        
        // 硬降落(直接落到底部)
        function hardDrop() {
            if (!gameStarted || gameOver) return;
            
            while (!collision(0, 1, currentPiece.shape)) {
                currentPiece.y++;
            }
            drop(); // 触发锁定和检查
        }
        
        // 开始单人游戏
        function startSinglePlayer() {
            showScreen('single-player-game');
            resetGame();
        }
        
        // 显示双人游戏界面(暂未实现)
        function showTwoPlayer() {
            alert('双人游戏功能正在开发中，请先玩单人游戏!');
        }
        
        // 开始游戏
        function startGame() {
            gameStarted = true;
            gameOver = false;
            dropStart = performance.now();
        }
        
        // 返回主菜单
        function backToMenu() {
            showScreen('main-menu');
            resetGame();
        }
        
        // 显示指定屏幕
        function showScreen(screenId) {
            // 隐藏所有屏幕
            document.querySelectorAll('body > div').forEach(div => {
                div.classList.remove('active');
            });
            
            // 显示指定屏幕
            document.getElementById(screenId).classList.add('active');
        }
        
        // 重置游戏
        function resetGame() {
            createBoard();
            currentPiece = generatePiece();
            nextPiece = generatePiece();
            score = 0;
            gameOver = false;
            gameStarted = false;
            gameSpeed = 1000;
            dropStart = performance.now();
            lastTime = 0;
            
            // 移除游戏结束界面
            const gameOverDiv = document.querySelector('.game-over');
            if (gameOverDiv) {
                gameOverDiv.remove();
            }
        }
        
        // 初始化游戏
        window.onload = init;
    </script>
</body>
</html>
